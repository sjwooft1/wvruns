<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migrate Data from CSV to Firebase</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #4285f4;
    }
    .section h2 {
      margin-top: 0;
      color: #4285f4;
    }
    .file-input-group {
      margin: 15px 0;
    }
    .file-input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    input[type="file"] {
      padding: 8px;
      border: 2px dashed #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #357ae8;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-danger {
      background: #ea4335;
    }
    .btn-danger:hover {
      background: #d33b2c;
    }
    .status {
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      background: #e8f0fe;
      border-left: 4px solid #4285f4;
    }
    .status.success {
      background: #e6f4ea;
      border-left-color: #34a853;
    }
    .status.error {
      background: #fce8e6;
      border-left-color: #ea4335;
    }
    .status.warning {
      background: #fef7e0;
      border-left-color: #fbbc04;
    }
    .progress {
      margin: 10px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .progress-bar {
      height: 20px;
      background: #4285f4;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .log {
      max-height: 400px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    .log-entry {
      margin: 5px 0;
    }
    .log-entry.success { color: #4ec9b0; }
    .log-entry.error { color: #f48771; }
    .log-entry.info { color: #569cd6; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #4285f4;
    }
    .instructions {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .instructions ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    .instructions li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä CSV to Firebase Migration Tool</h1>
    <p class="subtitle">Import data from Supabase CSV exports into Firebase Realtime Database</p>

    <div class="instructions">
      <h3>üìã How to Export from Supabase:</h3>
      <ol>
        <li>Go to your Supabase Dashboard: <a href="https://app.supabase.com" target="_blank">https://app.supabase.com</a></li>
        <li>Select your project</li>
        <li>Go to <strong>Table Editor</strong></li>
        <li>For each table (schools, meets, athletes, results), click the table name</li>
        <li>Click the <strong>"..."</strong> menu (three dots) in the top right</li>
        <li>Select <strong>"Export as CSV"</strong></li>
        <li>Save the CSV files with descriptive names (e.g., "schools.csv", "meets.csv")</li>
      </ol>
      <p><strong>For Track data:</strong> Repeat the same process for track_meets, track_events, track_athletes, track_results</p>
    </div>

    <div class="section">
      <h2>Cross Country Data</h2>
      <div class="file-input-group">
        <label for="cc-schools">Schools CSV:</label>
        <input type="file" id="cc-schools" accept=".csv" />
      </div>
      <div class="file-input-group">
        <label for="cc-meets">Meets CSV:</label>
        <input type="file" id="cc-meets" accept=".csv" />
      </div>
      <div class="file-input-group">
        <label for="cc-athletes">Athletes CSV:</label>
        <input type="file" id="cc-athletes" accept=".csv" />
      </div>
      <div class="file-input-group">
        <label for="cc-results">Results CSV:</label>
        <input type="file" id="cc-results" accept=".csv" />
      </div>
      <button onclick="migrateCrossCountry()">Migrate Cross Country Data</button>
    </div>

    <div class="section">
      <h2>Track Data</h2>
      <div class="file-input-group">
        <label for="track-meets">Track Meets CSV:</label>
        <input type="file" id="track-meets" accept=".csv" />
      </div>
      <div class="file-input-group">
        <label for="track-events">Track Events CSV:</label>
        <input type="file" id="track-events" accept=".csv" />
      </div>
      <div class="file-input-group">
        <label for="track-athletes">Track Athletes CSV:</label>
        <input type="file" id="track-athletes" accept=".csv" />
      </div>
      <div class="file-input-group">
        <label for="track-results">Track Results CSV:</label>
        <input type="file" id="track-results" accept=".csv" />
      </div>
      <button onclick="migrateTrack()">Migrate Track Data</button>
    </div>

    <div class="section">
      <button onclick="migrateAll()" class="btn-danger">Migrate ALL Uploaded Files</button>
      <button onclick="clearFirebase()" class="btn-danger">‚ö†Ô∏è Clear Firebase (Dangerous!)</button>
    </div>

    <div id="stats-container" class="stats"></div>

    <div id="status-container"></div>
    <div id="progress-container"></div>
    <div id="log" class="log"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCBQt9I_OSoUuTM61F-JXNBkD98f7PCJcA",
      authDomain: "mountainstatemiles-1326f.firebaseapp.com",
      databaseURL: "https://mountainstatemiles-1326f-default-rtdb.firebaseio.com",
      projectId: "mountainstatemiles-1326f",
      storageBucket: "mountainstatemiles-1326f.firebasestorage.app",
      messagingSenderId: "605911511756",
      appId: "1:605911511756:web:0e99071a816f0a39210869",
      measurementId: "G-N3DNFRQNF9"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let migrationStats = {
      schools: 0,
      meets: 0,
      athletes: 0,
      results: 0,
      track_meets: 0,
      track_events: 0,
      track_athletes: 0,
      track_results: 0
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function showStatus(message, type = 'info') {
      const container = document.getElementById('status-container');
      const status = document.createElement('div');
      status.className = `status ${type}`;
      status.textContent = message;
      container.appendChild(status);
      log(message, type);
    }

    function updateProgress(current, total, label) {
      const container = document.getElementById('progress-container');
      const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
      container.innerHTML = `
        <div class="progress">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>${label}</span>
            <span>${current} / ${total} (${percentage}%)</span>
          </div>
          <div class="progress-bar" style="width: ${percentage}%"></div>
        </div>
      `;
    }

    function updateStats() {
      const container = document.getElementById('stats-container');
      container.innerHTML = `
        <div class="stat-card">
          <h3>Cross Country</h3>
          <div class="number">${migrationStats.schools}</div>
          <p>Schools</p>
        </div>
        <div class="stat-card">
          <div class="number">${migrationStats.meets}</div>
          <p>Meets</p>
        </div>
        <div class="stat-card">
          <div class="number">${migrationStats.athletes}</div>
          <p>Athletes</p>
        </div>
        <div class="stat-card">
          <div class="number">${migrationStats.results}</div>
          <p>Results</p>
        </div>
        <div class="stat-card">
          <h3>Track</h3>
          <div class="number">${migrationStats.track_meets}</div>
          <p>Meets</p>
        </div>
        <div class="stat-card">
          <div class="number">${migrationStats.track_events}</div>
          <p>Events</p>
        </div>
        <div class="stat-card">
          <div class="number">${migrationStats.track_athletes}</div>
          <p>Athletes</p>
        </div>
        <div class="stat-card">
          <div class="number">${migrationStats.track_results}</div>
          <p>Results</p>
        </div>
      `;
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];
      
      // Parse header
      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
      
      // Parse rows
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // Simple CSV parsing (handles quoted values)
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim()); // Last value
        
        if (values.length === headers.length) {
          const row = {};
          headers.forEach((header, index) => {
            let value = values[index] || '';
            // Remove quotes if present
            value = value.replace(/^"|"$/g, '');
            // Try to parse numbers
            if (value && !isNaN(value) && value !== '') {
              if (value.includes('.')) {
                row[header] = parseFloat(value);
              } else {
                row[header] = parseInt(value, 10);
              }
            } else {
              row[header] = value || null;
            }
          });
          rows.push(row);
        }
      }
      
      return rows;
    }

    async function readCSVFile(fileInput) {
      return new Promise((resolve, reject) => {
        const file = fileInput.files[0];
        if (!file) {
          resolve(null);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csv = parseCSV(e.target.result);
            resolve(csv);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    async function migrateCSVToFirebase(csvData, firebasePath, tableName) {
      if (!csvData || csvData.length === 0) {
        log(`No data in ${tableName} CSV`, 'warning');
        return 0;
      }
      
      log(`Starting migration of ${tableName}... (${csvData.length} rows)`);
      updateProgress(0, csvData.length, `Migrating ${tableName}...`);
      
      const ref = database.ref(firebasePath);
      let migrated = 0;
      
      for (let i = 0; i < csvData.length; i++) {
        const record = csvData[i];
        
        // Remove id field (Firebase will generate its own)
        delete record.id;
        
        // Convert date fields to strings
        if (record.date) {
          record.date = record.date.toString();
        }
        if (record.created_at) {
          record.created_at = record.created_at.toString();
        }
        
        // Push to Firebase
        await ref.push(record);
        migrated++;
        
        updateProgress(migrated, csvData.length, `Migrating ${tableName}...`);
        
        if (migrated % 10 === 0) {
          log(`Migrated ${migrated}/${csvData.length} ${tableName} records...`);
        }
      }
      
      log(`‚úÖ Successfully migrated ${migrated} ${tableName} records`, 'success');
      return migrated;
    }

    async function migrateCrossCountry() {
      try {
        showStatus('Starting Cross Country migration...', 'info');
        
        const schoolsCSV = await readCSVFile(document.getElementById('cc-schools'));
        const meetsCSV = await readCSVFile(document.getElementById('cc-meets'));
        const athletesCSV = await readCSVFile(document.getElementById('cc-athletes'));
        const resultsCSV = await readCSVFile(document.getElementById('cc-results'));
        
        if (schoolsCSV) {
          migrationStats.schools = await migrateCSVToFirebase(schoolsCSV, 'crosscountry/schools', 'schools');
        }
        if (meetsCSV) {
          migrationStats.meets = await migrateCSVToFirebase(meetsCSV, 'crosscountry/meets', 'meets');
        }
        if (athletesCSV) {
          migrationStats.athletes = await migrateCSVToFirebase(athletesCSV, 'crosscountry/athletes', 'athletes');
        }
        if (resultsCSV) {
          migrationStats.results = await migrateCSVToFirebase(resultsCSV, 'crosscountry/results', 'results');
        }
        
        updateStats();
        showStatus(`‚úÖ Cross Country migration complete!`, 'success');
        
      } catch (error) {
        showStatus(`‚ùå Migration failed: ${error.message}`, 'error');
      }
    }

    async function migrateTrack() {
      try {
        showStatus('Starting Track migration...', 'info');
        
        const meetsCSV = await readCSVFile(document.getElementById('track-meets'));
        const eventsCSV = await readCSVFile(document.getElementById('track-events'));
        const athletesCSV = await readCSVFile(document.getElementById('track-athletes'));
        const resultsCSV = await readCSVFile(document.getElementById('track-results'));
        
        if (meetsCSV) {
          migrationStats.track_meets = await migrateCSVToFirebase(meetsCSV, 'Track/meets', 'track_meets');
        }
        if (eventsCSV) {
          migrationStats.track_events = await migrateCSVToFirebase(eventsCSV, 'Track/events', 'track_events');
        }
        if (athletesCSV) {
          migrationStats.track_athletes = await migrateCSVToFirebase(athletesCSV, 'Track/athletes', 'track_athletes');
        }
        if (resultsCSV) {
          migrationStats.track_results = await migrateCSVToFirebase(resultsCSV, 'Track/results', 'track_results');
        }
        
        updateStats();
        showStatus(`‚úÖ Track migration complete!`, 'success');
        
      } catch (error) {
        showStatus(`‚ùå Migration failed: ${error.message}`, 'error');
      }
    }

    async function migrateAll() {
      if (!confirm('This will migrate all uploaded CSV files to Firebase. Continue?')) {
        return;
      }
      
      try {
        showStatus('Starting full migration...', 'info');
        await migrateCrossCountry();
        await migrateTrack();
        showStatus('‚úÖ Full migration complete!', 'success');
      } catch (error) {
        showStatus(`‚ùå Migration failed: ${error.message}`, 'error');
      }
    }

    async function clearFirebase() {
      if (!confirm('‚ö†Ô∏è DANGER: This will DELETE ALL DATA in Firebase! Are you absolutely sure?')) {
        return;
      }
      
      try {
        showStatus('Clearing Firebase database...', 'warning');
        await database.ref().remove();
        showStatus('‚úÖ Firebase database cleared!', 'success');
        migrationStats = {
          schools: 0,
          meets: 0,
          athletes: 0,
          results: 0,
          track_meets: 0,
          track_events: 0,
          track_athletes: 0,
          track_results: 0
        };
        updateStats();
      } catch (error) {
        showStatus(`‚ùå Error clearing Firebase: ${error.message}`, 'error');
      }
    }

    // Initialize
    log('CSV Migration tool ready. Upload CSV files and click migrate.', 'info');
    updateStats();
  </script>
</body>
</html>

