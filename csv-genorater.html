<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css" />
  <title>Advanced CSV Generator ‚Äì Mountain State Miles</title>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1f3a 0%, #242a41 100%);
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 0;
      margin: 0;
    }
    header {
      background: rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      padding: 15px 40px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }
    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.7);
      margin-bottom: 40px;
      font-size: 1.1rem;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    .card h2 {
      color: #002855;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.4rem;
      border-bottom: 2px solid #002855;
      padding-bottom: 10px;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group label {
      display: block;
      font-weight: 600;
      color: #002855;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .input-group select,
    .input-group input,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s;
    }
    .input-group select:focus,
    .input-group input:focus,
    textarea:focus {
      outline: none;
      border-color: #002855;
      box-shadow: 0 0 0 3px rgba(0,40,85,0.1);
    }
    textarea {
      min-height: 200px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }
    .dropzone {
      border: 2px dashed #002855;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, rgba(0,40,85,0.02), rgba(0,40,85,0.05));
    }
    .dropzone:hover,
    .dropzone.active {
      background: linear-gradient(135deg, rgba(0,40,85,0.1), rgba(0,40,85,0.15));
      border-color: #004080;
    }
    .dropzone p {
      margin: 0;
      color: #002855;
      font-weight: 600;
    }
    .dropzone small {
      display: block;
      color: #999;
      margin-top: 8px;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      display: inline-block;
    }
    .btn-primary {
      background: #002855;
      color: white;
    }
    .btn-primary:hover {
      background: #004080;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,40,85,0.3);
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    .stat-item {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-radius: 8px;
      border-left: 4px solid #002855;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #002855;
    }
    .stat-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      margin-top: 5px;
    }
    .preview-section {
      grid-column: 1 / -1;
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .preview-section h2 {
      color: #002855;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.4rem;
      border-bottom: 2px solid #002855;
      padding-bottom: 10px;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    thead {
      background: linear-gradient(135deg, #002855 0%, #004080 100%);
      color: white;
    }
    th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
    }
    tr:hover {
      background: #f8f9fa;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid #721c24;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid #155724;
      display: none;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid #0c5460;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 10px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #999;
      transition: all 0.3s;
    }
    .tab:hover {
      color: #002855;
    }
    .tab.active {
      color: #002855;
      border-bottom-color: #002855;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .row-actions {
      display: flex;
      gap: 5px;
    }
    .row-actions button {
      padding: 4px 8px;
      font-size: 12px;
    }
    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    footer {
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.6);
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/Wvruns Logo.png" alt="Mountain State Miles Logo" class="logo" />
    <nav>
      <a href="index.html">Home</a>
      <a href="schools.html">Schools</a>
      <a href="meets.html">Meets</a>
      <a href="rankings.html">Rankings</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>

  <main>
    <h1>üìä Advanced CSV Generator</h1>
    <p class="subtitle">Convert any race results format to CSV for easy import</p>

    <div class="container">
      <!-- Import Methods -->
      <div class="card">
        <h2>üì• Input Method</h2>
        
        <div class="tabs">
          <button class="tab active" onclick="switchTab('paste')">Paste Text</button>
          <button class="tab" onclick="switchTab('file')">Upload File</button>
          <button class="tab" onclick="switchTab('manual')">Manual Entry</button>
        </div>

        <!-- Paste Tab -->
        <div id="paste" class="tab-content active">
          <div class="input-group">
            <label>Format Type</label>
            <select id="format-select" onchange="updateFormatHint()">
              <option value="auto">Auto-Detect</option>
              <option value="athleticlive">AthleticLIVE</option>
              <option value="runwv">RunWV / Plain Text</option>
              <option value="html">HTML Table</option>
              <option value="csv">CSV</option>
            </select>
          </div>

          <div class="input-group">
            <label>Paste Results Here</label>
            <textarea id="text-input" placeholder="Paste your race results here..."></textarea>
          </div>

          <div class="info" id="format-hint">
            üí° Select a format type or let us auto-detect it
          </div>

          <button class="btn btn-primary" onclick="parseTextInput()" style="width: 100%;">Parse Results</button>
        </div>

        <!-- File Upload Tab -->
        <div id="file" class="tab-content">
          <div class="dropzone" id="dropzone" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="handleDrop(event)">
            <p>üìÅ Drag and drop a file here</p>
            <small>or click to browse</small>
            <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(event)" accept=".csv,.txt,.html,.pdf">
          </div>
          <script>
            document.getElementById('dropzone').addEventListener('click', () => {
              document.getElementById('file-input').click();
            });
          </script>
        </div>

        <!-- Manual Tab -->
        <div id="manual" class="tab-content">
          <p style="color: #999; font-size: 14px;">Add results one by one</p>
          <div class="input-group">
            <label>Athlete Name *</label>
            <input type="text" id="manual-name" placeholder="e.g., John Smith">
          </div>
          <div class="input-group">
            <label>School</label>
            <input type="text" id="manual-school" placeholder="e.g., Parkersburg High">
          </div>
          <div class="input-group">
            <label>Time</label>
            <input type="text" id="manual-time" placeholder="e.g., 18:45.32 or 1125.32">
          </div>
          <div class="input-group">
            <label>Distance (meters)</label>
            <input type="number" id="manual-distance" value="5000" placeholder="5000">
          </div>
          <div class="input-group">
            <label>Place</label>
            <input type="number" id="manual-place" placeholder="1">
          </div>
          <button class="btn btn-success" onclick="addManualResult()" style="width: 100%;">Add Result</button>
        </div>
      </div>

      <!-- Settings -->
      <div class="card">
        <h2>‚öôÔ∏è Settings</h2>
        
        <div class="input-group">
          <label>Gender</label>
          <select id="gender-select">
            <option value="">Not Set</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>

        <div class="input-group">
          <label>Distance (meters)</label>
          <select id="distance-select">
            <option value="5000">5K (5000m)</option>
            <option value="3200">3200m</option>
            <option value="1600">1600m (1 mile)</option>
            <option value="10000">10K (10000m)</option>
            <option value="8000">8K (8000m)</option>
            <option value="2000">2000m</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="input-group" id="other-distance" style="display: none;">
          <label>Custom Distance</label>
          <input type="number" id="custom-distance" placeholder="Enter distance in meters">
        </div>

        <div class="input-group">
          <label>Race Type</label>
          <select id="race-type-select">
            <option value="">Not Set</option>
            <option value="varsity">Varsity</option>
            <option value="elite">Elite</option>
            <option value="jv">JV</option>
            <option value="open">Open</option>
            <option value="emerging-elite">Emerging Elite</option>
          </select>
        </div>

        <div class="input-group">
          <label>School Mapping</label>
          <select id="school-mapping">
            <option value="auto">Auto-Detect</option>
            <option value="exact">Exact Match Only</option>
            <option value="fuzzy">Fuzzy Match</option>
          </select>
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
            <button class="btn btn-danger" onclick="deleteSelected()">Delete Selected</button>
          </div>
        </div>

        <div class="btn-group" style="margin-top: 20px;">
          <button class="btn btn-success" onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>
          <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
        </div>
      </div>
    </div>

    <!-- Preview Table -->
    <div class="preview-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Preview & Edit</h2>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="total-count">0</div>
            <div class="stat-label">Total Rows</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="valid-count">0</div>
            <div class="stat-label">Valid</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="error-count">0</div>
            <div class="stat-label">Errors</div>
          </div>
        </div>
      </div>

      <div class="error" id="error-message"></div>
      <div class="success" id="success-message"></div>

      <div class="table-wrapper">
        <table id="preview-table">
          <thead>
            <tr>
              <th style="width: 30px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
              <th>Athlete Name</th>
              <th>School</th>
              <th>Gender</th>
              <th>Time</th>
              <th>Distance</th>
              <th>Place</th>
              <th style="width: 80px;">Actions</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="8" style="text-align: center; color: #999; padding: 40px;">No data yet. Start by pasting or uploading results above.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Mountain State Miles ‚Äî Built by runners, for runners.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <script>
    let parsedResults = [];
    let schoolCache = null;

    // School mapping
    const schoolOverrides = {
      "woodrow wilson": "woodrow",
      "park. south": "parkersburg-south",
      "parkersburg south": "parkersburg-south",
      "buck-upshur": "buckhannon",
      "buckhannon-upshur": "buckhannon",
      "geo. washington": "george-washington",
      "george washington": "george-washington"
    };

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // Format hint
    function updateFormatHint() {
      const format = document.getElementById('format-select').value;
      const hints = {
        'auto': 'üí° We\'ll automatically detect the format from your pasted text',
        'athleticlive': 'üí° AthleticLIVE format: Place, Name, Team, Time on separate lines',
        'runwv': 'üí° RunWV format: Place, Name, School, Time separated by spaces/tabs',
        'html': 'üí° HTML table format: Paste the HTML source from a webpage',
        'csv': 'üí° CSV format: Comma-separated values with headers'
      };
      document.getElementById('format-hint').textContent = hints[format] || hints['auto'];
    }

    // Distance dropdown
    document.getElementById('distance-select').addEventListener('change', function() {
      document.getElementById('other-distance').style.display = this.value === 'other' ? 'block' : 'none';
    });

    // Slugify school
    function slugifySchool(name) {
      const lower = name.trim().toLowerCase();
      for (const key in schoolOverrides) {
        if (lower.includes(key)) return schoolOverrides[key];
      }
      return lower.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    // Clean time
    function cleanTime(t) {
      return t.replace(/\*/g, '').replace('PR', '').replace('SB', '').trim();
    }

    // Time to seconds
    function timeToSeconds(t) {
      t = cleanTime(t);
      const parts = t.split(':');
      if (parts.length === 3) return (parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2])).toFixed(2);
      if (parts.length === 2) return (parseInt(parts[0]) * 60 + parseFloat(parts[1])).toFixed(2);
      return parseFloat(t).toFixed(2);
    }

    // Parse AthleticLIVE format
    function parseAthLiveText(raw, gender) {
      const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length);
      const results = [];
      
      for (let i = 0; i < lines.length; i++) {
        if (/^\d+$/.test(lines[i])) {
          const place = parseInt(lines[i]);
          const name = lines[i+1];
          const team = lines[i+2];
          const time = lines[i+3];
          
          if (name && team && time) {
            results.push({
              athlete_name: name,
              school_slug: slugifySchool(team),
              gender,
              time: timeToSeconds(time),
              distance: 5000,
              place
            });
          }
        }
      }
      return results;
    }

    // Parse plain text (RunWV)
    function parsePlainText(text, gender) {
      const lines = text.split('\n').filter(l => l.trim());
      const results = [];
      
      for (const line of lines) {
        const trimmed = line.trim();
        
        // Skip header rows or empty lines
        if (!trimmed || /^(place|rank|pos|#)/i.test(trimmed)) continue;
        
        // Match: Number. Name Grade Time School
        // Example: 1. Joaquin Summers 11 9:25.55 Unattached
        const match = trimmed.match(/^(\d+)\.\s+(.+?)\s+(\d+|-)\s+([\d:\.]+)\s+(.*)$/);
        if (match) {
          const [, place, name, grade, time, schoolRaw] = match;
          const school = schoolRaw.trim();
          
          // Skip if school is "Unattached" or contains "Unattached"
          const schoolSlug = (school.toLowerCase() === 'unattached' || school.includes('Unattached')) 
            ? '' 
            : slugifySchool(school);
          
          results.push({
            athlete_name: name.trim(),
            school_slug: schoolSlug,
            gender,
            time: timeToSeconds(time),
            distance: 5000,
            place: parseInt(place)
          });
          continue;
        }
        
        // Fallback: Try splitting by multiple spaces or tabs
        const parts = trimmed.split(/\s{2,}|\t+/);
        if (parts.length >= 4) {
          // Extract place (remove trailing period if exists)
          const place = parseInt(parts[0].replace('.', ''));
          const name = parts[1];
          const timeStr = parts[parts.length - 1];
          const schoolRaw = parts[parts.length - 2];
          
          // Skip if school is "Unattached"
          const schoolSlug = (schoolRaw.toLowerCase() === 'unattached' || schoolRaw.includes('Unattached')) 
            ? '' 
            : slugifySchool(schoolRaw);
          
          results.push({
            athlete_name: name,
            school_slug: schoolSlug,
            gender,
            time: timeToSeconds(timeStr),
            distance: 5000,
            place
          });
        }
      }
      return results;
    }

    // Parse HTML
    function parseHtmlSource(html, gender) {
      const rows = [];
      const table = html.match(/<table[^>]*>[\s\S]*?<\/table>/i);
      if (!table) return [];

      const regex = /<tr[^>]*>[\s\S]*?<\/tr>/gi;
      const trs = table[0].match(regex) || [];

      let place = 1;
      for (const tr of trs) {
        const tds = tr.match(/<td[^>]*>[\s\S]*?<\/td>/gi) || [];
        if (tds.length < 3) continue;

        const cells = tds.map(td => td.replace(/<[^>]*>/g, '').trim()).filter(c => c);
        if (cells.length < 3) continue;

        rows.push({
          athlete_name: cells[1],
          school_slug: slugifySchool(cells[2]),
          gender,
          time: timeToSeconds(cells[cells.length-1]),
          distance: 5000,
          place: place++
        });
      }
      return rows;
    }

    // Parse CSV
    function parseCSV(text, gender) {
      const lines = text.split('\n');
      const headers = lines[0].toLowerCase();
      const results = [];

      let nameIdx = headers.includes('name') ? 1 : 0;
      let schoolIdx = headers.includes('school') ? 2 : 1;
      let timeIdx = -1;
      let placeIdx = -1;

      for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split(',').map(c => c.trim());
        if (cells.length < 3) continue;

        results.push({
          athlete_name: cells[nameIdx],
          school_slug: slugifySchool(cells[schoolIdx]),
          gender,
          time: timeToSeconds(cells[timeIdx >= 0 ? timeIdx : cells.length-1]),
          distance: 5000,
          place: i
        });
      }
      return results;
    }

    // Parse text input
    function parseTextInput() {
      const text = document.getElementById('text-input').value;
      const format = document.getElementById('format-select').value;
      const gender = document.getElementById('gender-select').value || '';

      if (!text) {
        showError('Please paste some text first');
        return;
      }

      try {
        let results = [];

        if (format === 'auto') {
          if (text.includes('<table') || text.includes('<tr')) results = parseHtmlSource(text, gender);
          else if (text.includes(',')) results = parseCSV(text, gender);
          else if (/^\d+\n/.test(text)) results = parseAthLiveText(text, gender);
          else results = parsePlainText(text, gender);
        } else if (format === 'athleticlive') {
          results = parseAthLiveText(text, gender);
        } else if (format === 'runwv') {
          results = parsePlainText(text, gender);
        } else if (format === 'html') {
          results = parseHtmlSource(text, gender);
        } else if (format === 'csv') {
          results = parseCSV(text, gender);
        }

        if (results.length === 0) {
          showError('No results found. Check your format and try again.');
          return;
        }

        parsedResults = results;
        updatePreview();
        showSuccess(`Successfully parsed ${results.length} results!`);
      } catch (error) {
        showError(`Parse error: ${error.message}`);
      }
    }

    // File handling
    function dragOver(e) {
      e.preventDefault();
      document.getElementById('dropzone').classList.add('active');
    }

    function dragLeave(e) {
      e.preventDefault();
      document.getElementById('dropzone').classList.remove('active');
    }

    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('dropzone').classList.remove('active');
      handleFiles(e.dataTransfer.files);
    }

    function handleFileSelect(e) {
      handleFiles(e.target.files);
    }

    function handleFiles(files) {
      if (files.length === 0) return;
      const file = files[0];
      const reader = new FileReader();

      reader.onload = (e) => {
        document.getElementById('text-input').value = e.target.result;
        switchTab('paste');
      };

      reader.readAsText(file);
    }

    // Add manual result
    function addManualResult() {
      const name = document.getElementById('manual-name').value.trim();
      const school = document.getElementById('manual-school').value.trim();
      const time = document.getElementById('manual-time').value.trim();
      const distance = parseInt(document.getElementById('manual-distance').value) || 5000;
      const place = parseInt(document.getElementById('manual-place').value) || 0;

      if (!name) {
        showError('Please enter an athlete name');
        return;
      }

      if (!time) {
        showError('Please enter a time');
        return;
      }

      parsedResults.push({
        athlete_name: name,
        school_slug: slugifySchool(school),
        gender: document.getElementById('gender-select').value || '',
        time: timeToSeconds(time),
        distance,
        place
      });

      document.getElementById('manual-name').value = '';
      document.getElementById('manual-school').value = '';
      document.getElementById('manual-time').value = '';
      document.getElementById('manual-place').value = '';

      updatePreview();
      showSuccess('Result added!');
    }

    // Update preview
    function updatePreview() {
      const tbody = document.getElementById('table-body');
      
      if (parsedResults.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999; padding: 40px;">No data yet.</td></tr>';
        updateStats();
        return;
      }

      tbody.innerHTML = parsedResults.map((r, idx) => `
        <tr>
          <td><input type="checkbox" class="row-checkbox" value="${idx}"></td>
          <td>${r.athlete_name}</td>
          <td>${r.school_slug}</td>
          <td>${r.gender || '-'}</td>
          <td>${r.time}</td>
          <td>${r.distance}</td>
          <td>${r.place || '-'}</td>
          <td class="row-actions">
            <button class="btn btn-secondary" onclick="editRow(${idx})">Edit</button>
            <button class="btn btn-danger" onclick="deleteRow(${idx})">Delete</button>
          </td>
        </tr>
      `).join('');

      updateStats();
    }

    // Edit row
    function editRow(idx) {
      const r = parsedResults[idx];
      const newName = prompt('Athlete Name:', r.athlete_name);
      if (newName === null) return;

      parsedResults[idx].athlete_name = newName;
      updatePreview();
    }

    // Delete row
    function deleteRow(idx) {
      if (confirm('Delete this result?')) {
        parsedResults.splice(idx, 1);
        updatePreview();
      }
    }

    // Toggle select all
    function toggleSelectAll() {
      const isChecked = document.getElementById('select-all').checked;
      document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
    }

    // Delete selected
    function deleteSelected() {
      const selected = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.value));
      if (selected.length === 0) {
        showError('No rows selected');
        return;
      }

      if (!confirm(`Delete ${selected.length} results?`)) return;

      parsedResults = parsedResults.filter((_, i) => !selected.includes(i));
      updatePreview();
      showSuccess(`Deleted ${selected.length} results`);
    }

    // Clear all
    function clearAll() {
      if (confirm('Clear all data? This cannot be undone.')) {
        parsedResults = [];
        document.getElementById('text-input').value = '';
        updatePreview();
      }
    }

    // Update stats
    function updateStats() {
      document.getElementById('total-count').textContent = parsedResults.length;
      const valid = parsedResults.filter(r => r.athlete_name && r.time && r.school_slug).length;
      const errors = parsedResults.length - valid;
      document.getElementById('valid-count').textContent = valid;
      document.getElementById('error-count').textContent = errors;
    }

    // Download CSV
    function downloadCSV() {
      if (parsedResults.length === 0) {
        showError('No data to download');
        return;
      }

      const raceType = document.getElementById('race-type-select').value;
      const headers = 'athlete_name,school_slug,gender,time,distance,place,race_type\n';
      const rows = parsedResults.map(r =>
        `${r.athlete_name},${r.school_slug},${r.gender},${r.time},${r.distance},${r.place},${raceType}`
      ).join('\n');

      const csv = headers + rows;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `results-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showSuccess('CSV downloaded!');
    }

    // Copy to clipboard
    function copyToClipboard() {
      if (parsedResults.length === 0) {
        showError('No data to copy');
        return;
      }

      const raceType = document.getElementById('race-type-select').value;
      const headers = 'athlete_name,school_slug,gender,time,distance,place,race_type\n';
      const rows = parsedResults.map(r =>
        `${r.athlete_name},${r.school_slug},${r.gender},${r.time},${r.distance},${r.place},${raceType}`
      ).join('\n');

      const csv = headers + rows;
      navigator.clipboard.writeText(csv).then(() => {
        showSuccess('CSV copied to clipboard!');
      });
    }

    // Messages
    function showError(msg) {
      const el = document.getElementById('error-message');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(msg) {
      const el = document.getElementById('success-message');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
  </script>
</body>
</html>
