<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Athlete Profile – Mountain State Miles</title>
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    .athlete-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .athlete-header h1 {
      transform: scale(2.0);
      color: #082054;
      text-shadow: 20px 20px 50px rgb(252, 11, 7);
      transition: all 1.5s ease;
    }
    .athlete-header:hover h1{
      transform: scale(0.3) rotate(135deg);
      color: #082054;
      text-shadow: 20px 20px 50px rgb(252, 11, 7);
      transition: all 1.5s ease;
    }
    .athlete-info {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      color: rgba(255,255,255,0.95);
      font-size: 1.1rem;
      margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    .stat-card h3 {
      color: #002855;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
      border-bottom: 2px solid #002855;
      padding-bottom: 10px;
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-item {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-radius: 10px;
      border-left: 4px solid #002855;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #002855;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      text-align: center;
      padding: 40px;
      color: #d32f2f;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      margin: 20px 0;
    }
    @media (max-width: 768px) {
      .athlete-info {
        flex-direction: column;
        gap: 15px;
      }
      .stat-grid {
        grid-template-columns: 1fr;
      }
      .chart-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div class="page-background"></div>
    <img src="assets/Wvruns Logo.png" alt="" class="page-background-image" />
    <header>
      <a href="rankings.html" style="color: white; text-decoration: none; font-weight: 600; padding: 8px 16px; border-radius: 8px; background: rgba(255,255,255,0.1); transition: all 0.3s ease;">← Back to Rankings</a>
      <nav>
        <a href="index.html">Home</a>
        <a href="schools.html">Schools</a>
        <a href="meets.html">Meets</a>
        <a href="rankings.html">Rankings</a>
        <a href="calendar.html">Calendar</a>
      </nav>
    </header>
    <main>
      <div class="athlete-header">
        <h1 id="athlete-name">Loading...</h1>
        <div class="athlete-info" id="athlete-info"></div>
      </div>
      
      <div id="loading" class="loading">Loading athlete data...</div>
      <div id="error" class="error" style="display: none;"></div>
      
      <div id="content" style="display: none;">
        <!-- Personal Records -->
        <div class="stat-card">
          <h3>Personal Records</h3>
          <div class="stat-grid" id="pr-stats"></div>
        </div>

        <!-- Performance Chart -->
        <div class="stat-card">
          <h3>Performance Over Time</h3>
          <div class="chart-container">
            <canvas id="performance-chart"></canvas>
          </div>
        </div>

        <!-- Meet Results -->
        <div class="stat-card">
          <h3>All Meet Results</h3>
          <div class="table-wrapper">
            <table id="results-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Meet</th>
                  <th>Place</th>
                  <th>Time</th>
                  <th>Pace/Mile</th>
                  <th>School</th>
                </tr>
              </thead>
              <tbody id="results-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    <footer>
      <p>&copy; 2025 Mountain State Miles — Built by runners, for runners.</p>
      <a href="login.html"
         style="
           display:inline-block;
           margin-top:8px;
           background:#6cb5d967;
           padding:8px 14px;
           color:white;
           text-decoration:none;
           border-radius:6px;
           font-weight:bold;
         ">
         Admin Login
      </a>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script>
    // Get athlete name from URL
    function getAthleteName() {
      const params = new URLSearchParams(window.location.search);
      return params.get('name');
    }

    // Format grade from graduation year
    function formatGrade(gradYear) {
      if (!gradYear) return 'N/A';
      const yearNum = parseInt(gradYear, 10);
      if (Number.isNaN(yearNum)) return 'N/A';
      const now = new Date();
      const month = now.getMonth();
      const currentYear = now.getFullYear();
      const academicEndYear = month >= 7 ? currentYear + 1 : currentYear;
      const gradeNum = 12 - (yearNum - academicEndYear);
      const numLabels = { 9: '9th', 10: '10th', 11: '11th', 12: '12th' };
      return numLabels[gradeNum] || 'N/A';
    }

    // Format time
    function formatTime(seconds) {
      if (!seconds && seconds !== 0) return '';
      const sec = Number(seconds);
      if (Number.isNaN(sec)) return seconds;
      const ms = Math.floor((sec % 1) * 100);
      const totalSeconds = Math.floor(sec);
      const minutes = Math.floor(totalSeconds / 60);
      const remainingSeconds = totalSeconds % 60;
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
    }

    // Calculate pace per mile
    function calculatePacePerMile(seconds) {
      if (!seconds && seconds !== 0) return '';
      const sec = Number(seconds);
      if (Number.isNaN(sec) || sec <= 0) return '';
      const DISTANCE_MILES = 3.10686;
      const paceSecondsPerMile = sec / DISTANCE_MILES;
      const paceMinutes = Math.floor(paceSecondsPerMile / 60);
      const paceSeconds = Math.floor(paceSecondsPerMile % 60);
      return `${paceMinutes}:${paceSeconds.toString().padStart(2, '0')}`;
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '';
      const parts = dateString.split('-');
      if (parts.length === 3) {
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const day = parseInt(parts[2], 10);
        const date = new Date(year, month, day);
        return date.toLocaleDateString();
      }
      return new Date(dateString).toLocaleDateString();
    }

    // Get school name
    const schoolNameCache = {};
    async function getSchoolName(slug) {
      if (!slug) return '';
      if (schoolNameCache[slug]) return schoolNameCache[slug];
      const { data } = await supabase.from('schools').select('name').eq('slug', slug).single();
      if (data) {
        schoolNameCache[slug] = data.name;
        return data.name;
      }
      return slug;
    }

    // Load athlete data
    async function loadAthleteProfile() {
      const athleteName = getAthleteName();
      const loadingDiv = document.getElementById('loading');
      const errorDiv = document.getElementById('error');
      const contentDiv = document.getElementById('content');

      if (!athleteName) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'No athlete name specified!';
        return;
      }

      try {
        // Get athlete info
        const { data: athletes, error: athleteError } = await supabase
          .from('athletes')
          .select('*')
          .ilike('name', athleteName);

        // Get all results for this athlete (by name match)
        const { data: results, error: resultsError } = await supabase
          .from('results')
          .select('*')
          .ilike('athlete_name', athleteName)
          .order('created_at', { ascending: false });

        if (resultsError) throw resultsError;

        loadingDiv.style.display = 'none';

        // Display athlete name
        document.getElementById('athlete-name').textContent = athleteName;

        // Display athlete info
        const athleteInfo = athletes && athletes.length > 0 ? athletes[0] : null;
        const infoDiv = document.getElementById('athlete-info');
        if (athleteInfo) {
          const schoolName = athleteInfo.school_slug ? await getSchoolName(athleteInfo.school_slug) : 'N/A';
          infoDiv.innerHTML = `
            <div><strong>School:</strong> ${schoolName}</div>
            <div><strong>Grade:</strong> ${formatGrade(athleteInfo.grade)}</div>
            <div><strong>Gender:</strong> ${athleteInfo.gender || 'N/A'}</div>
          `;
        } else {
          infoDiv.innerHTML = '<div style="color: rgba(255,255,255,0.8);">Athlete information not available</div>';
        }

        if (!results || results.length === 0) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = 'No results found for this athlete.';
          return;
        }

        // Calculate stats
        const validResults = results.filter(r => r.time && Number(r.time) > 0);
        if (validResults.length === 0) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = 'No valid time results found.';
          return;
        }

        const times = validResults.map(r => Number(r.time)).sort((a, b) => a - b);
        const bestTime = times[0];
        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const recentTime = times[times.length - 1];

        // Display PR stats
        const prStatsDiv = document.getElementById('pr-stats');
        prStatsDiv.innerHTML = `
          <div class="stat-item">
            <div class="stat-value">${formatTime(bestTime)}</div>
            <div class="stat-label">Personal Record</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${formatTime(avgTime)}</div>
            <div class="stat-label">Average Time</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${validResults.length}</div>
            <div class="stat-label">Total Races</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${calculatePacePerMile(bestTime)}</div>
            <div class="stat-label">Best Pace/Mile</div>
          </div>
        `;

        // Create performance chart
        const chartData = results
          .filter(r => r.time && Number(r.time) > 0)
          .map(r => ({
            date: r.created_at || r.meet_slug,
            time: Number(r.time),
            meet: r.meet_slug
          }))
          .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (chartData.length > 0) {
          const ctx = document.getElementById('performance-chart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartData.map((_, i) => `Race ${i + 1}`),
              datasets: [{
                label: 'Time (seconds)',
                data: chartData.map(d => d.time),
                borderColor: '#002855',
                backgroundColor: 'rgba(0, 40, 85, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return formatTime(context.parsed.y);
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  ticks: {
                    callback: function(value) {
                      return formatTime(value);
                    }
                  }
                }
              }
            }
          });
        }

        // Display results table
        const tbody = document.getElementById('results-tbody');
        const resultsWithMeetInfo = await Promise.all(results.map(async (r) => {
          const { data: meet } = await supabase.from('meets').select('*').eq('slug', r.meet_slug).single();
          const schoolName = r.school_slug ? await getSchoolName(r.school_slug) : '';
          return { ...r, meet, schoolName };
        }));

        tbody.innerHTML = resultsWithMeetInfo
          .sort((a, b) => {
            const dateA = a.meet?.date || a.created_at || '';
            const dateB = b.meet?.date || b.created_at || '';
            return dateB.localeCompare(dateA);
          })
          .map(r => `
            <tr>
              <td>${r.meet?.date ? formatDate(r.meet.date) : 'N/A'}</td>
              <td><a href="meet.html?slug=${r.meet_slug}" style="color: #0056b3; text-decoration: none; font-weight: 600;">${r.meet?.name || r.meet_slug || 'Unknown Meet'}</a></td>
              <td>${r.place || ''}</td>
              <td>${formatTime(r.time)}</td>
              <td>${calculatePacePerMile(r.time)}</td>
              <td>${r.schoolName || r.school_slug || ''}</td>
            </tr>
          `).join('');

        contentDiv.style.display = 'block';
      } catch (error) {
        console.error('Error loading athlete:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Error loading athlete data. Please try again.';
      }
    }

    document.addEventListener('DOMContentLoaded', loadAthleteProfile);
  </script>
</body>
</html>

