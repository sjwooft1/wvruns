<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team – Mountain State Miles</title>
  <link rel="icon" type="image/png" href="../assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="../assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="../assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="track.css">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <!-- Your Configuration and Helper Scripts -->
  <script src="firebase-config.js"></script>
  <script src="firebase-helpers.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="navbar-content">
        <a href="index.html" class="navbar-brand">⚡ Track & Field</a>
        <button class="mobile-menu-toggle" aria-label="Toggle menu">☰</button>
        <ul class="navbar-nav" id="main-nav">
          <li><a href="/home/" class="navbar-link">Home</a></li>
          <li><a href="index.html" class="navbar-link">Track</a></li>
          <li><a href="teams.html" class="navbar-link active">Teams</a></li>
          <li><a href="meets.html" class="navbar-link">Meets</a></li>
          <li><a href="events.html" class="navbar-link">Events</a></li>
          <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
          <li><a href="analytics.html" class="navbar-link">Analytics</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <main class="page-container">
    <header class="hero-section hero-profile">
      <div class="hero-content">
        <!-- Team Logo Display -->
        <img id="team-logo" class="hero-logo" src="" alt="Team Logo" style="display: none;" 
             onerror="this.onerror=null; this.src='../assets/Wvruns Logo.png'; this.style.display='block';"> 
        <h1 id="team-name" class="text-4xl font-extrabold mb-2">Team Profile</h1>
        <p id="team-info" class="text-xl font-medium text-gray-200">Loading team information...</p>
      </div>
    </header>

    <section class="content-section">
      <div class="container">
        
        <!-- Roster Section -->
        <h2 class="section-title mb-4">Current Roster</h2>
        <div id="roster-loading" class="loading-message">
            Loading roster...
        </div>
        <div id="no-athletes" class="loading-message" style="display: none;">
            No athletes found for this team.
        </div>
        <div id="roster-grid" class="table-container" style="display: none;">
          <!-- Custom HTML Roster Table will render here -->
        </div>

        <!-- Meet Results Section -->
        <h2 class="section-title mt-10 mb-4">Meet Results Summary</h2>
        <div id="meets-loading" class="loading-message">
            Loading recent meet results...
        </div>
        <div id="meets-list">
            <!-- Meet list will be injected here -->
        </div>
        
      </div>
    </section>
  </main>
  
  <footer>
    <p>&copy; 2026 Mountain State Miles — Built by runners, for runners.</p>
    <a href="admin-login.html" class="btn btn-secondary">Admin Login</a>
  </footer>
  
  <!-- Custom Styles for visual integration -->
  <style>
    /* Team Logo Style */
    .hero-logo { 
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: contain;
        background: white;
        padding: 5px;
        margin: 0 auto 1.5rem auto;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Container for the new custom table */
    .table-container {
        max-width: 100%;
        overflow-x: auto;
        margin-bottom: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .loading-message {
        padding: 20px;
        text-align: center;
        color: var(--xc-primary);
        font-weight: 500;
        font-size: 1.1rem;
    }
    .meet-card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .meet-card a {
      color: var(--xc-primary);
      font-weight: 600;
      text-decoration: none;
    }
    .meet-card p {
        margin: 0;
        color: #555;
        font-size: 0.95rem;
    }
    
    /* Responsive Table Styles */
    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .results-table th, .results-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        color: #333;
    }

    .results-table th {
        background-color: var(--xc-primary);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .results-table tbody tr:nth-of-type(even) {
        background-color: #f9f9f9;
    }

    .results-table tbody tr:hover {
        background-color: #f1f5f9;
    }
    
    /* Responsive styles for table on small screens */
    @media screen and (max-width: 768px) {
        .results-table table, 
        .results-table thead, 
        .results-table tbody, 
        .results-table th, 
        .results-table td, 
        .results-table tr {
            display: block;
        }
        
        .results-table thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        .results-table tr {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .results-table td {
            border: none;
            position: relative;
            padding-left: 50%;
            text-align: right;
        }
        
        .results-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            font-weight: 600;
            text-align: left;
            color: var(--xc-primary);
        }
    }
  </style>

  <script>
    // Utility function to format time (in seconds) to M:SS.ss
    function formatTime(seconds) {
      const timeSec = parseFloat(seconds);
      if (isNaN(timeSec) || timeSec <= 0) return 'N/A';
      
      const totalMinutes = Math.floor(timeSec / 60);
      const remainingSeconds = (timeSec % 60).toFixed(2).padStart(5, '0'); 
      return `${totalMinutes}:${remainingSeconds}`;
    }
    
    // Element references
    const teamLogoEl = document.getElementById('team-logo');
    const teamNameEl = document.getElementById('team-name');
    const teamInfoEl = document.getElementById('team-info');
    const rosterGrid = document.getElementById('roster-grid');
    const rosterLoading = document.getElementById('roster-loading');
    const noAthletes = document.getElementById('no-athletes');
    const meetsList = document.getElementById('meets-list');
    const meetsLoading = document.getElementById('meets-loading');

    /**
     * Converts school name to slug
     * @param {string} schoolName - The school name
     * @returns {string} The slug
     */
    function schoolNameToSlug(schoolName) {
      return schoolName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    /**
     * Loads team name and logo from URL parameter.
     * @returns {Promise<string|null>} The school name or null if not found.
     */
    async function loadTeamInfo() {
      const params = new URLSearchParams(window.location.search);
      const schoolName = params.get('school');

      if (!schoolName) {
        teamNameEl.textContent = 'Team Not Found';
        teamInfoEl.textContent = 'Please provide a valid school name in the URL.';
        return null;
      }

      try {
        teamNameEl.textContent = schoolName;
        teamInfoEl.textContent = `Track & Field Team in West Virginia`;
        document.title = `${schoolName} Track Team – Mountain State Miles`;
        
        // Set Logo path using slug
        const slug = schoolNameToSlug(schoolName);
        const logoPath = `../CrossCountry/assets/team logos/${slug}.png`;
        const fallbackLogo = `../assets/Wvruns Logo.png`;
        teamLogoEl.onerror = function() {
          this.onerror = null;
          this.src = fallbackLogo;
          this.style.display = 'block';
        };
        teamLogoEl.src = logoPath;
        teamLogoEl.style.display = 'block'; 
        
        return schoolName;
      } catch (error) {
        console.error('Error loading team info:', error);
        teamNameEl.textContent = 'Error Loading Data';
        teamInfoEl.textContent = 'Could not load team information.';
        return null;
      }
    }

    /**
     * Loads the roster by querying Track/athletes for school name matches.
     * @param {string} schoolName The school name.
     */
    async function loadRoster(schoolName) {
      rosterLoading.style.display = 'block';
      rosterGrid.style.display = 'none';
      noAthletes.style.display = 'none';
      rosterGrid.innerHTML = ''; 

      try {
        await waitForFirebase();
        
        // Query athletes by school name
        const snapshot = await window.firebaseDatabase.ref('Track/athletes').once('value');
        const allAthletes = [];
        snapshot.forEach(child => {
          const athlete = child.val();
          if (athlete && athlete.school === schoolName) {
            allAthletes.push(athlete);
          }
        });

        if (allAthletes.length > 0) {
          // Sort by name
          allAthletes.sort((a, b) => {
            const nameA = (a.name || a.athlete_name || '').toLowerCase();
            const nameB = (b.name || b.athlete_name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
          
          const tableHTML = `
            <table class="results-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Gender</th>
                  <th>Graduation Year</th>
                </tr>
              </thead>
              <tbody>
                ${allAthletes.map(athlete => {
                  const name = athlete.athlete_name || athlete.name || 'Name Unknown'; 
                  let gradYear = athlete.grad_year || athlete.graduation_year || athlete.class;
                  gradYear = gradYear ? `C/o ${gradYear}` : 'N/A';
                  const gender = athlete.gender === 'M' ? 'Male' : (athlete.gender === 'F' ? 'Female' : 'N/A');
                  const slug = athlete.athlete_slug || athlete.slug;
                  
                  const link = slug 
                      ? `<a href="athlete.html?slug=${slug}" style="color: var(--xc-primary); font-weight: 600;">${name}</a>`
                      : name;

                  return `
                    <tr>
                      <td data-label="Name">${link}</td>
                      <td data-label="Gender">${gender}</td>
                      <td data-label="Graduation Year">${gradYear}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;

          rosterGrid.innerHTML = tableHTML;
          rosterLoading.style.display = 'none';
          rosterGrid.style.display = 'block';

        } else {
          rosterLoading.style.display = 'none';
          noAthletes.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading roster:', error);
        rosterLoading.textContent = 'Error loading roster data: ' + error.message;
        rosterLoading.style.display = 'block';
        rosterGrid.style.display = 'none';
        noAthletes.style.display = 'none';
      }
    }
    
    /**
     * Loads the list of meets a team has participated in.
     * @param {string} schoolName The school name.
     */
    async function loadMeets(schoolName) {
      meetsLoading.style.display = 'block';
      meetsList.innerHTML = '';
      try {
        await waitForFirebase();
        
        // Get all results for this school
        const resultsSnapshot = await window.firebaseDatabase.ref('Track/results').once('value');
        const allResults = [];
        resultsSnapshot.forEach(child => {
          const result = child.val();
          if (result && result.school === schoolName) {
            allResults.push(result);
          }
        });
        
        if (allResults.length > 0) {
            // Group results by unique meet slug
            const meetsMap = allResults.reduce((acc, result) => {
                const meetSlug = result.meet_slug;
                
                if (!meetSlug) return acc;

                let meetName = result.meet_name || result.meet; 
                if (!meetName) {
                    meetName = meetSlug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); 
                }
                
                if (!acc[meetSlug]) {
                    acc[meetSlug] = {
                        meet_slug: meetSlug,
                        meet_name: meetName,
                        date: result.date || null,
                        results: []
                    };
                }
                acc[meetSlug].results.push(result);
                return acc;
            }, {});

            const meetsArray = Object.values(meetsMap);
            
            // Sort meets by date, newest first
            meetsArray.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (isNaN(dateA)) return 1;
                if (isNaN(dateB)) return -1;
                return dateB.getTime() - dateA.getTime(); 
            });

            const html = meetsArray.map(meet => {
                // Find the best overall time from this team at this meet
                const bestTimeResult = meet.results.reduce((best, current) => {
                    const currentTime = parseFloat(current.time);
                    if (isNaN(currentTime) || currentTime <= 0) return best; 
                    
                    const bestTime = best ? parseFloat(best.time) : Infinity;
                    return currentTime < bestTime ? current : best;
                }, null);
                
                const bestTimeDisplay = bestTimeResult ? formatTime(bestTimeResult.time) : 'No Valid Time Recorded';
                const bestTimeAthlete = bestTimeResult 
                    ? bestTimeResult.athlete_name || bestTimeResult.name || 'Unknown Athlete' 
                    : '';

                let displayDate = 'Date Unknown';
                if (meet.date) {
                    const dateObj = new Date(meet.date);
                    if (!isNaN(dateObj.getTime())) {
                        displayDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                }
                
                return `
                    <div class="meet-card">
                        <a href="meet.html?slug=${meet.meet_slug}">${meet.meet_name}</a>
                        <p>Date: ${displayDate}</p>
                        <p>Best Time: ${bestTimeDisplay} ${bestTimeAthlete ? `(by ${bestTimeAthlete})` : ''}</p>
                    </div>
                `;
            }).join('');

            meetsList.innerHTML = html;
        } else {
            meetsList.innerHTML = '<p class="loading-message">No meet results found for this team in the database.</p>';
        }

      } catch (error) {
        console.error('Error loading meets:', error);
        meetsList.innerHTML = `<p class="loading-message" style="color: red;">Error loading meet data: ${error.message}</p>`;
      } finally {
        meetsLoading.style.display = 'none';
      }
    }

    async function waitForFirebase() {
      let attempts = 0;
      while (typeof window.firebaseDatabase === 'undefined' && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (typeof window.firebaseDatabase === 'undefined') {
        throw new Error('Firebase database not initialized');
      }
    }

    // Initialize page
    async function init() {
      const schoolName = await loadTeamInfo();
      if (schoolName) {
        loadRoster(schoolName);
        loadMeets(schoolName);
      } else {
        document.getElementById('roster-loading').style.display = 'none';
        document.getElementById('meets-loading').style.display = 'none';
      }
    }

    // Run when page loads
    window.onload = function() {
      init();
      
      // Mobile menu toggle
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      const navMenu = document.getElementById('main-nav');
      
      if (menuToggle && navMenu) {
        menuToggle.addEventListener('click', () => {
          navMenu.classList.toggle('mobile-open');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!navMenu.contains(e.target) && !menuToggle.contains(e.target)) {
            navMenu.classList.remove('mobile-open');
          }
        });
      }
    };
  </script>
</body>
</html>

