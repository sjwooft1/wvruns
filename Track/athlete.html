<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Athlete — Track</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; }
  
  :root {
    --primary: #002855;
    --secondary: #0056b3;
    --text-primary: #1a1a1a;
    --text-secondary: #666;
    --bg-light: #f8f9fa;
    --border-light: #e0e0e0;
    --accent: #ff6b35;
    --accent-dark: #d9530a;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
  }
  
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .navbar {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
  }
  
  .navbar-brand {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .navbar-nav {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 30px;
  }
  
  .navbar-link {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s;
    position: relative;
  }
  
  .navbar-link:hover,
  .navbar-link.active {
    color: var(--secondary);
  }
  
  .navbar-link.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent);
    border-radius: 2px;
  }
  
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 20px;
  }
  
  .section-title {
    font-size: 2.2rem;
    font-weight: 800;
    margin: 0 0 40px;
    color: var(--primary);
    position: relative;
    padding-bottom: 15px;
  }
  
  .section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
  }
  
  h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin: 30px 0 20px;
  }
  
  footer {
    background: var(--primary);
    color: white;
    text-align: center;
    padding: 40px 20px;
    margin-top: 80px;
  }
  
  footer p {
    margin: 0 0 20px;
    opacity: 0.9;
  }
  
  .btn {
    display: inline-block;
    padding: 12px 28px;
    background: var(--accent);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
  }
  
  .btn:hover {
    background: var(--accent-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 53, 0.3);
  }
</style>
</head>
<body>
  <header>
    <nav class="navbar">
      <a href="index.html" class="navbar-brand">⚡ Track & Field</a>
      <ul class="navbar-nav">
        <li><a href="/index.html" class="navbar-link">Home</a></li>
        <li><a href="index.html" class="navbar-link">Track</a></li>
        <li><a href="meets.html" class="navbar-link">Meets</a></li>
        <li><a href="events.html" class="navbar-link">Events</a></li>
        <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
        <li><a href="analytics.html" class="navbar-link">Analytics</a></li>
      </ul>
    </nav>
  </header>
  
  <main>
    <h1 class="section-title" id="athlete-name">Loading athlete…</h1>
    <div id="athlete-meta" style="margin-bottom:18px;"></div>

    <h3>Personal Bests</h3>
    <div id="pbs">Loading…</div>

    <h3 style="margin-top:18px;">Recent Results</h3>
    <div id="history">Loading…</div>
  </main>

  <footer>
      <div class="row">
          <!-- 1st Column -->
          <div class="footer-col">
              <h4>General</h4>
              <ul>
                  <li><a href="/home/index.html">Home</a></li>
                  <li><a href="/home/about.html">About</a></li>
                  <li><a href="/home/admin.html">Admin</a></li>
              </ul>
          </div>

          <!-- 2nd Column -->
          <div class="footer-col">
              <h4>Cross Country</h4>
              <ul>
                  <li><a href="/CrossCountry/xc.html">Home</a></li>
                  <li><a href="/CrossCountry/meets.html">Meets</a></li>
                  <li><a href="/CrossCountry/schools.html">Schools</a></li>
                  <li><a href="/CrossCountry/rankings.html">Rankings</a></li>
                  <li><a href="/CrossCountry/analytics.html">Analytics</a></li>
              </ul>
          </div>

          <!-- 3rd Column -->
          <div class="footer-col">
              <h4>Track</h4>
              <ul>
                  <li><a href="/Track/index.html">Home</a></li>
                  <li><a href="/Track/meets.html">Meets</a></li>
                  <li><a href="/Track/teams.html">Teams</a></li>
                  <li><a href="/Track/rankings.html">Rankings</a></li>
                  <li><a href="/Track/analytics.html">Analytics</a></li>
              </ul>
          </div>
      </div>
      <hr>
      <div class="row">
          <div class="footer-bottom">
              <div style="margin-bottom: 1rem;">
                  <a href="https://github.com/sjwooft1/mountainstatemiles" target="_blank" rel="noopener noreferrer">
                      <i class="fab fa-github" style="font-size: 1.5rem;"></i>
                      <span>GitHub Repository</span>
                  </a>
              </div>
              <p>&#169; 2026 Mountain State Miles — Built by runners, for runners.</p>
          </div>
      </div>
  </footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<script src="firebase-config.js"></script>
<script>
async function waitForFirebase() {
  let attempts = 0;
  while (typeof window.firebaseDatabase === 'undefined' && attempts < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  if (typeof window.firebaseDatabase === 'undefined') {
    throw new Error('Firebase database not initialized');
  }
}

const params = new URLSearchParams(window.location.search);
const athleteId = params.get('id');

async function loadAthlete() {
  try {
    await waitForFirebase();
    const athSnapshot = await window.firebaseDatabase.ref(`Track/athletes/${athleteId}`).once('value');
  const ath = athSnapshot.exists() ? { id: athleteId, ...athSnapshot.val() } : null;
  if (!ath) { document.getElementById('athlete-name').textContent = 'Athlete not found'; return; }
  document.getElementById('athlete-name').textContent = `${ath.first_name} ${ath.last_name}`;
  document.getElementById('athlete-meta').innerHTML = `<strong>School:</strong> ${ath.school ?? ''} &nbsp; <strong>Grade:</strong> ${ath.grade ?? ''}`;

  // personal bests: find best mark per event for this athlete (naive: min mark)
  const pbsSnapshot = await window.firebaseDatabase.ref('Track/results')
    .orderByChild('athlete_id')
    .equalTo(athleteId)
    .limitToFirst(1000)
    .once('value');
  
  const pbs = [];
  pbsSnapshot.forEach(child => {
    pbs.push({ id: child.key, ...child.val() });
  });
  
  // Load events for results
  const eventIds = [...new Set(pbs.map(r => r.event_id).filter(Boolean))];
  const eventsMap = {};
  if (eventIds.length > 0) {
    const eventsSnapshot = await window.firebaseDatabase.ref('Track/events').once('value');
    eventsSnapshot.forEach(child => {
      if (eventIds.includes(child.key)) {
        eventsMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }
  
  // Attach event data and sort by mark
  pbs.forEach(r => {
    r.event = eventsMap[r.event_id] || {};
  });
  pbs.sort((a, b) => {
    const markA = parseFloat(a.mark) || Infinity;
    const markB = parseFloat(b.mark) || Infinity;
    return markA - markB;
  });

  if (!pbs || pbs.length===0) {
    document.getElementById('pbs').innerHTML = '<p>No personal bests found.</p>';
  } else {
    // group by event
    const bests = {};
    pbs.forEach(r => {
      const eventName = r.event?.name || 'Unknown';
      if (!bests[eventName]) bests[eventName] = r.mark;
    });
    document.getElementById('pbs').innerHTML = `<ul>${Object.entries(bests).map(([ev,mark]) => `<li><strong>${ev}:</strong> ${mark}</li>`).join('')}</ul>`;
  }

  // Load history
  const histSnapshot = await window.firebaseDatabase.ref('Track/results')
    .orderByChild('athlete_id')
    .equalTo(athleteId)
    .limitToFirst(200)
    .once('value');
  
  const hist = [];
  histSnapshot.forEach(child => {
    hist.push({ id: child.key, ...child.val() });
  });
  
  // Load meets and events for history
  const meetIds = [...new Set(hist.map(r => r.meet_id).filter(Boolean))];
  const histEventIds = [...new Set(hist.map(r => r.event_id).filter(Boolean))];
  const meetsMap = {};
  const histEventsMap = {};
  
  if (meetIds.length > 0) {
    const meetsSnapshot = await window.firebaseDatabase.ref('Track/meets').once('value');
    meetsSnapshot.forEach(child => {
      if (meetIds.includes(child.key)) {
        meetsMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }
  
  if (histEventIds.length > 0) {
    const eventsSnapshot = await window.firebaseDatabase.ref('Track/events').once('value');
    eventsSnapshot.forEach(child => {
      if (histEventIds.includes(child.key)) {
        histEventsMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }
  
  // Attach meet and event data
  hist.forEach(r => {
    r.meet = meetsMap[r.meet_id] || {};
    r.event = histEventsMap[r.event_id] || {};
  });
  
  // Sort by meet date descending
  hist.sort((a, b) => {
    const dateA = a.meet?.date || '';
    const dateB = b.meet?.date || '';
    return dateB.localeCompare(dateA);
  });
  const historyContainer = document.getElementById('history');
  if (!hist || hist.length===0) {
    historyContainer.innerHTML = '<p>No results found.</p>';
  } else {
    historyContainer.innerHTML = '<div id="history-grid" style="height: 400px; width: 100%;"></div>';
    
    setTimeout(() => {
      const headers = ['Date', 'Event', 'Mark', 'Meet'];
      const rowData = hist.map(r => [
        r.meet?.date ? new Date(r.meet.date).toLocaleDateString() : '',
        r.event.name || '',
        r.mark || '',
        r.meet.name || '',
        r.event.slug || '',
        r.meet.slug || ''
      ]);

      const columnDefs = [
        { data: 0, title: 'Date', type: 'text', readOnly: true, width: 120 },
        {
          data: 1,
          title: 'Event',
          type: 'text',
          readOnly: true,
          renderer: function(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            const eventSlug = instance.getDataAtRow(row)[4];
            if (eventSlug) {
              td.innerHTML = `<a href="event.html?event=${eventSlug}" style="color: #0056b3; text-decoration: none;">${value || ''}</a>`;
            }
          }
        },
        { data: 2, title: 'Mark', type: 'text', readOnly: true, width: 120 },
        {
          data: 3,
          title: 'Meet',
          type: 'text',
          readOnly: true,
          renderer: function(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            const meetSlug = instance.getDataAtRow(row)[5];
            if (meetSlug) {
              td.innerHTML = `<a href="meet.html?slug=${meetSlug}" style="color: #0056b3; text-decoration: none;">${value || ''}</a>`;
            }
          }
        }
      ];

      const gridElement = document.getElementById('history-grid');
      if (gridElement) {
        new Handsontable(gridElement, {
          data: rowData,
          colHeaders: headers,
          columns: columnDefs,
          rowHeaders: true,
          licenseKey: 'non-commercial-and-evaluation',
          height: 'auto',
          maxHeight: '400px',
          stretchH: 'all',
          columnSorting: true,
          filters: true,
          dropdownMenu: true,
          contextMenu: true,
          manualColumnResize: true
        });
      }
    }, 100);
  }
  } catch (error) {
    console.error('Error loading athlete:', error);
    document.getElementById('athlete-name').textContent = 'Error Loading Athlete';
    document.getElementById('athlete-meta').innerHTML = '<p style="color: #dc3545;">⚠️ Error loading athlete data. Please check your connection and try again.</p>';
    document.getElementById('pbs').innerHTML = '<p style="color: #dc3545;">Error loading data.</p>';
    document.getElementById('history').innerHTML = '<p style="color: #dc3545;">Error loading data.</p>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(loadAthlete, 100);
});
</script>
</body>
</html>
