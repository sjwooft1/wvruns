<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meet Results ‚Äî Mountain State Miles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; }
  
  :root {
    --primary: #002855;
    --secondary: #0056b3;
    --text-primary: #1a1a1a;
    --text-secondary: #666;
    --bg-light: #f8f9fa;
    --border-light: #e0e0e0;
    --accent: #ff6b35;
    --accent-dark: #d9530a;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
  }
  
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .navbar {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
  }
  
  .navbar-brand {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .navbar-nav {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 30px;
  }
  
  .navbar-link {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s;
    position: relative;
  }
  
  .navbar-link:hover,
  .navbar-link.active {
    color: var(--secondary);
  }
  
  .navbar-link.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent);
    border-radius: 2px;
  }
  
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 20px;
  }
  
  .section-title {
    font-size: 2.2rem;
    font-weight: 800;
    margin: 0 0 40px;
    color: var(--primary);
    position: relative;
    padding-bottom: 15px;
  }
  
  .section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
  }

    .meet-desc {
    font-size: 1.2rem;
    color: #000000bd;
    font-weight: 500;
    margin-bottom: 25px;
  }
  .meet-desc::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
  }
  .meet-meta {
  font-size: 1.2rem;
  color: var(secondary);
  font-weight: 600;
  margin-bottom: 15px;
  margin-top: -30px; /* Pulls it closer to the title */
}
  .event-block {
    margin-bottom: 40px;
  }
  
  .event-block h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 20px;
  }
  
   /* Footer */
    footer {
  /* Remove the solid background color */
  background: rgba(0, 40, 85, 0.85); /* Semi-transparent version of your primary blue */
  backdrop-filter: blur(8px); /* Optional: Adds a glass effect */
  color: white;
  text-align: center;
  padding: 40px 20px;
  margin-top: 80px;
  position: relative;
  z-index: 1; /* Ensures footer content stays above the image */
}
.footer-with-bg {
  position: relative;
  overflow: hidden; /* Clips the image to footer boundaries */
  padding: 60px 20px;
  color: white;
  text-align: center;
}

.footer-bg-img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover; /* Ensures the mountain image fills the area */
  z-index: -1; /* Puts it behind the text */
  filter: brightness(0.5); /* Darkens the image so text is readable */
}

.footer-content {
  position: relative;
  z-index: 2;
}
  
  .btn {
    display: inline-block;
    padding: 12px 28px;
    background: var(--accent);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
  }
  
  .btn:hover {
    background: var(--accent-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 53, 0.3);
  }

  /* === WEATHER WIDGET STYLING === */

  .weather-widget {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 250, 255, 0.95) 100%);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 24px;
    margin: 20px 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.5);
  }

  .weather-content {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .weather-icon {
    font-size: 4rem;
    line-height: 1;
    flex-shrink: 0;
  }

  .weather-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .weather-location {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
  }

  .weather-conditions {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }

  .weather-temps {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.25rem;
    font-weight: 700;
  }

  .temp-high {
    color: #d97706;
  }

  .temp-divider {
    color: #9ca3af;
  }

  .temp-low {
    color: #0891b2;
  }

  .weather-details {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
  }

  .detail-item {
    font-size: 0.95rem;
    color: #4b5563;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .weather-timestamp {
    font-size: 0.8rem;
    color: #9ca3af;
    margin-top: 8px;
  }

  /* Responsive weather widget */
  @media (max-width: 768px) {
    .weather-widget {
      padding: 16px;
    }

    .weather-content {
      flex-direction: column;
      text-align: center;
      gap: 16px;
    }

    .weather-icon {
      font-size: 3.5rem;
    }

    .weather-conditions {
      font-size: 1.25rem;
    }

    .weather-temps {
      justify-content: center;
      font-size: 1.1rem;
    }

    .weather-details {
      justify-content: center;
      gap: 16px;
    }
  }
</style>
</head>
<body>
  <header>
    <nav class="navbar">
      <a href="index.html" class="navbar-brand">‚ö° Track & Field</a>
      <ul class="navbar-nav">
        <li><a href="/index.html" class="navbar-link">Home</a></li>
        <li><a href="index.html" class="navbar-link">Track</a></li>
        <li><a href="meets.html" class="navbar-link active">Meets</a></li>
        <li><a href="events.html" class="navbar-link">Events</a></li>
        <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
        <li><a href="analytics.html" class="navbar-link">Analytics</a></li>
      </ul>
    </nav>
  </header>
  
  <main>
    <h1 class="section-title" id="meet-title">Loading...</h1>
    <p class="meet-meta" id="meet-meta">Loading details...</p>
    <div id="weather-widget" class="weather-widget" style="display:none;"></div>
    <p class="meet-desc" id="meet-description">Loading description...</p> 
    <div id="event-results">Loading results...</div>
  </main>

  <footer>
      <div class="row">
          <!-- 1st Column -->
          <div class="footer-col">
              <h4>General</h4>
              <ul>
                  <li><a href="/home/index.html">Home</a></li>
                  <li><a href="/home/about.html">About</a></li>
                  <li><a href="/home/admin.html">Admin</a></li>
              </ul>
          </div>

          <!-- 2nd Column -->
          <div class="footer-col">
              <h4>Cross Country</h4>
              <ul>
                  <li><a href="/CrossCountry/xc.html">Home</a></li>
                  <li><a href="/CrossCountry/meets.html">Meets</a></li>
                  <li><a href="/CrossCountry/schools.html">Schools</a></li>
                  <li><a href="/CrossCountry/rankings.html">Rankings</a></li>
                  <li><a href="/CrossCountry/analytics.html">Analytics</a></li>
              </ul>
          </div>

          <!-- 3rd Column -->
          <div class="footer-col">
              <h4>Track</h4>
              <ul>
                  <li><a href="/Track/index.html">Home</a></li>
                  <li><a href="/Track/meets.html">Meets</a></li>
                  <li><a href="/Track/teams.html">Teams</a></li>
                  <li><a href="/Track/rankings.html">Rankings</a></li>
                  <li><a href="/Track/analytics.html">Analytics</a></li>
              </ul>
          </div>
      </div>
      <hr>
      <div class="row">
          <div class="footer-bottom">
              <div style="margin-bottom: 1rem;">
                  <a href="https://github.com/sjwooft1/mountainstatemiles" target="_blank" rel="noopener noreferrer">
                      <i class="fab fa-github" style="font-size: 1.5rem;"></i>
                      <span>GitHub Repository</span>
                  </a>
              </div>
              <p>&#169; 2026 Mountain State Miles ‚Äî Built by runners, for runners.</p>
          </div>
      </div>
  </footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<script src="firebase-config.js"></script>
<script>
async function waitForFirebase() {
  let attempts = 0;
  while (typeof window.firebaseDatabase === 'undefined' && attempts < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  if (typeof window.firebaseDatabase === 'undefined') {
    throw new Error('Firebase database not initialized');
  }
}

const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

async function loadMeet() {
  try {
    await waitForFirebase();
    console.log('Loading meet with slug:', slug);
    
    // Try to find meet by slug first
    let meet = null;
    const allMeetsSnapshot = await window.firebaseDatabase.ref("Track/meets").once("value");
    
    console.log('All meets snapshot exists:', allMeetsSnapshot.exists());
    
    allMeetsSnapshot.forEach(child => {
      const meetData = child.val();
      console.log('Checking meet:', child.key, meetData);
      if (meetData.slug === slug || child.key === slug) {
        meet = { id: child.key, ...meetData };
        console.log('Found meet:', meet);
      }
    });

  // Load Title
document.getElementById("meet-title").textContent =
  meet?.name ?? "Meet Not Found";

// Load Description
document.getElementById("meet-description").textContent =
  meet?.description ?? "No description available";

// Load Location and Date combined
const location = meet?.location ?? "No location";
const date = meet?.date ?? "No date";

// This combines them into "Location ‚Ä¢ Date"
document.getElementById("meet-meta").textContent = `${location} ‚Ä¢ ${date}`;

// Load weather for the meet location if date is in the future
if (meet?.location && meet?.date) {
  loadWeatherForMeet(meet.location, meet.date);
}

  if (!meet) {
    console.log('Meet not found with slug:', slug);
    document.getElementById("event-results").innerHTML = "<p>Meet not found. Check console for details.</p>";
    return;
  }

  // Load results for this meet
  console.log('Loading results for meet:', meet.id);
  const allResultsSnapshot = await window.firebaseDatabase.ref("Track/results").once("value");
  
  const results = [];
  allResultsSnapshot.forEach(child => {
    const resultData = child.val();
    if (resultData.meet_id === meet.id) {
      console.log('Found result:', child.key, resultData);
      results.push({ id: child.key, ...resultData });
    }
  });
  
  console.log('Total results found:', results.length);

  if (!results || !results.length) {
    document.getElementById("event-results").innerHTML = "<p>No results found.</p>";
    return;
  }

  // Load athletes and events for results
  const athleteIds = [...new Set(results.map(r => r.athlete_id).filter(Boolean))];
  const eventIds = [...new Set(results.map(r => r.event_id).filter(Boolean))];
  
  const athletesMap = {};
  const eventsMap = {};
  
  // Load athletes
  if (athleteIds.length > 0) {
      const athletesSnapshot = await window.firebaseDatabase.ref("Track/athletes").once("value");
    athletesSnapshot.forEach(child => {
      if (athleteIds.includes(child.key)) {
        athletesMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }
  
  // Load events
  if (eventIds.length > 0) {
      const eventsSnapshot = await window.firebaseDatabase.ref("Track/events").once("value");
    eventsSnapshot.forEach(child => {
      if (eventIds.includes(child.key)) {
        eventsMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }

  // Attach athlete and event data to results
  results.forEach(r => {
    r.athlete = athletesMap[r.athlete_id] || {};
    r.event = eventsMap[r.event_id] || {};
  });

  // Sort by placing
  results.sort((a, b) => {
    const placeA = a.placing || a.placement || 999;
    const placeB = b.placing || b.placement || 999;
    return placeA - placeB;
  });

  // Group by event
  const groups = {};
  results.forEach(r => {
    const eventName = r.event?.name || 'Unknown Event';
    if (!groups[eventName]) groups[eventName] = [];
    groups[eventName].push(r);
  });

  // Calculate team scores
  const teamScores = calculateTeamScoresTrack(results);

  const container = document.getElementById("event-results");
  container.innerHTML = Object.entries(groups)
    .map(([eventName, rows], idx) => `
      <div class="event-block">
        <h3>${eventName}</h3>
        <div id="meet-grid-${idx}" style="height: 300px; width: 100%;"></div>
      </div>
    `).join("");

  // Display team results
  if (teamScores && teamScores.length > 0) {
    container.innerHTML += renderTeamResultsTrack(teamScores);
  }

  // Initialize grids for each event
  Object.entries(groups).forEach(([eventName, rows], idx) => {
    setTimeout(() => {
      const gridId = `meet-grid-${idx}`;
      const gridElement = document.getElementById(gridId);
      if (!gridElement) return;

      const headers = ['Place', 'Athlete', 'School', 'Mark'];
      const rowData = rows.map(r => [
        r.placing || r.placement || '',
        `${r.athlete.first_name || ''} ${r.athlete.last_name || ''}`.trim(),
        r.athlete.school || '',
        r.mark || '',
        r.athlete.id || ''
      ]);

      const columnDefs = [
        { data: 0, title: 'Place', type: 'text', readOnly: true, width: 80 },
        {
          data: 1,
          title: 'Athlete',
          type: 'text',
          readOnly: true,
          renderer: function(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            const athleteId = instance.getDataAtRow(row)[4];
            if (athleteId) {
              td.innerHTML = `<a href="athlete.html?id=${athleteId}" style="color: #0056b3; text-decoration: none;">${value || ''}</a>`;
            }
          }
        },
        { data: 2, title: 'School', type: 'text', readOnly: true },
        { data: 3, title: 'Mark', type: 'text', readOnly: true, width: 120 }
      ];

      new Handsontable(gridElement, {
        data: rowData,
        colHeaders: headers,
        columns: columnDefs,
        rowHeaders: true,
        licenseKey: 'non-commercial-and-evaluation',
        height: 'auto',
        maxHeight: '300px',
        stretchH: 'all',
        columnSorting: true,
        filters: true,
        dropdownMenu: true,
        contextMenu: true,
        manualColumnResize: true
      });
    }, idx * 50);
  });
  } catch (error) {
    console.error('Error loading meet:', error);
    document.getElementById("meet-title").textContent = "Error Loading Meet";
    document.getElementById("event-results").innerHTML = '<p style="color: #dc3545;">‚ö†Ô∏è Error loading meet data. Please check your connection and try again.</p>';
  }
}

// ==========================================
// WEATHER WIDGET FUNCTIONS
// ==========================================

/**
 * Map school names to their geographic coordinates for weather lookup
 */
const schoolCoordinatesMap = {
  'grafton high school': { lat: 39.34, lon: -80.03 },
  'parkersburg high school': { lat: 39.27, lon: -81.56 },
  'parkersburg south high school': { lat: 39.27, lon: -81.56 },
  'morgantown high school': { lat: 39.64, lon: -79.96 },
  'bridgeport high school': { lat: 39.29, lon: -80.26 },
  'buckhannon sampson high school': { lat: 38.99, lon: -80.23 },
  'cabell midland high school': { lat: 38.54, lon: -82.45 },
  'capital high school': { lat: 38.35, lon: -81.64 },
  'george washington high school': { lat: 38.35, lon: -81.64 },
  'hedgesville high school': { lat: 39.18, lon: -78.05 },
  'huntington high school': { lat: 38.42, lon: -82.45 },
  'hurricane high school': { lat: 38.49, lon: -82.48 },
  'jefferson high school': { lat: 39.33, lon: -77.74 },
  'martinsburg high school': { lat: 39.47, lon: -77.97 },
  'musselman high school': { lat: 39.48, lon: -78.03 },
  'oak hill high school': { lat: 38.41, lon: -81.60 },
  'preston high school': { lat: 39.34, lon: -80.03 },
  'riverside high school': { lat: 38.46, lon: -81.75 },
  'spring mills high school': { lat: 39.47, lon: -77.97 },
  'spring valley high school': { lat: 38.42, lon: -82.45 },
  'st albans high school': { lat: 38.54, lon: -81.83 },
  'university high school': { lat: 39.64, lon: -79.96 },
  'washington high school': { lat: 38.35, lon: -81.64 },
  'wheeling park high school': { lat: 40.07, lon: -80.71 },
  'woodrow wilson high school': { lat: 37.78, lon: -81.19 }
};

/**
 * Get coordinates for a location (school or city)
 */
function getCoordinatesForLocation(location) {
  if (!location) return null;
  
  const normalized = location.toLowerCase().trim();
  
  // Check if it's a school name
  if (schoolCoordinatesMap[normalized]) {
    console.log('‚úÖ Found coordinates in map for:', location);
    return schoolCoordinatesMap[normalized];
  }
  
  return null;
}

/**
 * Get weather for the meet location
 * Uses Open-Meteo API (free, no API key required)
 */
async function loadWeatherForMeet(location, meetDate) {
  try {
    const weatherWidget = document.getElementById('weather-widget');
    console.log('üå§Ô∏è Weather loading for:', location, meetDate);
    
    // Get coordinates for the location
    const coordinates = getCoordinatesForLocation(location);
    
    if (!coordinates) {
      console.log('Could not find coordinates for location:', location);
      return;
    }

    console.log('üìç Found coordinates:', coordinates);

    // Determine which date to show weather for
    const meetDateObj = new Date(meetDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // If meet is today or in the past, show today's weather
    // If meet is in the future, show the meet day's forecast
    const weatherDate = meetDateObj <= today ? 'today' : meetDate;
    console.log('Weather date:', weatherDate, '(Meet date:', meetDate, ', Today:', today.toISOString().split('T')[0], ')');

    // Fetch weather data
    const weather = await fetchWeatherData(coordinates.lat, coordinates.lon, weatherDate);
    
    if (weather) {
      console.log('‚úÖ Weather data received:', weather);
      weatherWidget.style.display = 'block';
      renderWeatherWidget(weather, location, weather.isTodayWeather);
      
      // Update weather every 10 minutes
      setInterval(() => {
        fetchWeatherData(coordinates.lat, coordinates.lon, weatherDate).then(w => {
          if (w) renderWeatherWidget(w, location, w.isTodayWeather);
        });
      }, 600000); // 10 minutes
    } else {
      console.log('‚ùå No weather data received');
    }
  } catch (err) {
    console.error('Error loading weather:', err);
  }
}

/**
 * Fetch weather data from Open-Meteo API
 */
async function fetchWeatherData(lat, lon, dateOrType) {
  try {
    console.log('üì° Fetching weather for:', dateOrType);
    
    const response = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_sum,wind_speed_10m_max&temperature_unit=fahrenheit&timezone=auto`
    );
    const data = await response.json();
    
    if (data.daily) {
      const dailyData = data.daily;
      console.log('Available dates:', dailyData.time.slice(0, 5));
      
      let weatherIndex = -1;
      let isTodayWeather = false;
      
      if (dateOrType === 'today') {
        // Use today's weather (first index)
        weatherIndex = 0;
        isTodayWeather = true;
        console.log('‚úÖ Using today\'s weather at index 0');
      } else {
        // Look for the specific meet date
        weatherIndex = dailyData.time.indexOf(dateOrType);
        if (weatherIndex !== -1) {
          console.log('‚úÖ Found meet date at index:', weatherIndex);
        } else {
          // If exact date not found, use today's weather
          console.log('‚ö†Ô∏è Meet date not found, using today\'s forecast');
          weatherIndex = 0;
          isTodayWeather = true;
        }
      }
      
      return {
        date: dateOrType === 'today' ? dailyData.time[0] : dateOrType,
        maxTemp: dailyData.temperature_2m_max[weatherIndex],
        minTemp: dailyData.temperature_2m_min[weatherIndex],
        weatherCode: dailyData.weather_code[weatherIndex],
        precipitation: dailyData.precipitation_sum[weatherIndex],
        windSpeed: dailyData.wind_speed_10m_max[weatherIndex],
        timezone: data.timezone,
        isTodayWeather: isTodayWeather
      };
    }
    console.log('‚ùå No daily data received');
    return null;
  } catch (err) {
    console.error('Weather fetch error:', err);
    return null;
  }
}

/**
 * Get weather icon and description from weather code
 */
function getWeatherDetails(code) {
  const weatherMap = {
    0: { icon: '‚òÄÔ∏è', description: 'Clear' },
    1: { icon: 'üå§Ô∏è', description: 'Mostly Clear' },
    2: { icon: '‚õÖ', description: 'Partly Cloudy' },
    3: { icon: '‚òÅÔ∏è', description: 'Overcast' },
    45: { icon: 'üå´Ô∏è', description: 'Foggy' },
    48: { icon: 'üå´Ô∏è', description: 'Foggy' },
    51: { icon: 'üå¶Ô∏è', description: 'Light Drizzle' },
    53: { icon: 'üåßÔ∏è', description: 'Drizzle' },
    55: { icon: 'üåßÔ∏è', description: 'Heavy Drizzle' },
    61: { icon: 'üåßÔ∏è', description: 'Light Rain' },
    63: { icon: 'üåßÔ∏è', description: 'Rain' },
    65: { icon: '‚õàÔ∏è', description: 'Heavy Rain' },
    71: { icon: '‚ùÑÔ∏è', description: 'Light Snow' },
    73: { icon: '‚ùÑÔ∏è', description: 'Snow' },
    75: { icon: '‚ùÑÔ∏è', description: 'Heavy Snow' },
    77: { icon: '‚ùÑÔ∏è', description: 'Snow' },
    80: { icon: 'üåßÔ∏è', description: 'Light Showers' },
    81: { icon: '‚õàÔ∏è', description: 'Showers' },
    82: { icon: '‚õàÔ∏è', description: 'Heavy Showers' },
    85: { icon: 'üå®Ô∏è', description: 'Snow Showers' },
    86: { icon: 'üå®Ô∏è', description: 'Heavy Snow Showers' },
    95: { icon: '‚õàÔ∏è', description: 'Thunderstorm' },
    96: { icon: '‚õàÔ∏è', description: 'Hail Thunderstorm' },
    99: { icon: '‚õàÔ∏è', description: 'Hail Thunderstorm' }
  };
  
  return weatherMap[code] || { icon: '‚ùì', description: 'Unknown' };
}

/**
 * Render the weather widget
 */
function renderWeatherWidget(weather, location, isTodayWeather) {
  const widget = document.getElementById('weather-widget');
  const { icon, description } = getWeatherDetails(weather.weatherCode);
  
  const maxTemp = Math.round(weather.maxTemp);
  const minTemp = Math.round(weather.minTemp);
  const windSpeed = Math.round(weather.windSpeed);
  const precipitation = Math.round(weather.precipitation * 100) / 100;
  
  const weatherLabel = isTodayWeather ? 'üìç Current Weather' : '‚õÖ Meet Day Forecast';
  
  widget.innerHTML = `
    <div class="weather-content">
      <div class="weather-icon">${icon}</div>
      <div class="weather-info">
        <div class="weather-label">${weatherLabel}</div>
        <div class="weather-location">üåç ${location}</div>
        <div class="weather-conditions">${description}</div>
        <div class="weather-temps">
          <span class="temp-high">${maxTemp}¬∞F</span>
          <span class="temp-divider">/</span>
          <span class="temp-low">${minTemp}¬∞F</span>
        </div>
        <div class="weather-details">
          <span class="detail-item">üí® ${windSpeed} mph</span>
          <span class="detail-item">üíß ${precipitation}"</span>
        </div>
        <div class="weather-timestamp">Updated: ${new Date().toLocaleTimeString()}</div>
      </div>
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(loadMeet, 100);
});

// ==========================================
// TEAM SCORING FUNCTIONS FOR TRACK
// ==========================================

/**
 * Calculate team scores from individual results
 * In track, higher score is better (points based on placement)
 * 1st place = most points, descending
 */
function calculateTeamScoresTrack(results) {
  const teamMap = {};
  
  // Group results by school
  results.forEach(result => {
    const school = result.athlete?.school || 'Unknown';
    if (!teamMap[school]) {
      teamMap[school] = [];
    }
    teamMap[school].push(result);
  });

  // Calculate scores for each team
  const scores = [];
  Object.entries(teamMap).forEach(([school, athleteResults]) => {
    let teamScore = 0;
    
    // Sum points from all athletes (lower placement = higher points)
    athleteResults.forEach(result => {
      const placing = parseInt(result.placing || result.placement) || 999;
      // Convert placement to points: 1st = 10 points, 2nd = 8, 3rd = 6, etc.
      const points = Math.max(0, 11 - placing);
      teamScore += points;
    });

    scores.push({
      school,
      score: teamScore,
      athletes: athleteResults,
      athleteCount: athleteResults.length
    });
  });

  // Sort by score (descending - higher is better)
  return scores.sort((a, b) => b.score - a.score);
}

/**
 * Render team results for track
 */
function renderTeamResultsTrack(teamScores) {
  if (!teamScores || teamScores.length === 0) {
    return '';
  }

  return `
    <div class="event-block" style="margin-top: 40px;">
      <h3>üèÜ Team Results</h3>
      <div style="background: white; border-radius: 8px; padding: 20px; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #002855; color: white;">
              <th style="padding: 12px; text-align: left; font-weight: 700;">Team Placement</th>
              <th style="padding: 12px; text-align: left; font-weight: 700;">School</th>
              <th style="padding: 12px; text-align: left; font-weight: 700;">Team Score</th>
              <th style="padding: 12px; text-align: left; font-weight: 700;">Athletes</th>
            </tr>
          </thead>
          <tbody>
            ${teamScores.map((team, index) => `
              <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 12px; font-weight: 700;">${index + 1}</td>
                <td style="padding: 12px; font-weight: 600;">${team.school}</td>
                <td style="padding: 12px; font-weight: 700; color: #0056b3;">${team.score}</td>
                <td style="padding: 12px;">${team.athleteCount}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}
</script>

</body>
</html>
