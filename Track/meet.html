<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meet Results — Mountain State Miles</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; }
  
  :root {
    --primary: #002855;
    --secondary: #0056b3;
    --text-primary: #1a1a1a;
    --text-secondary: #666;
    --bg-light: #f8f9fa;
    --border-light: #e0e0e0;
    --accent: #ff6b35;
    --accent-dark: #d9530a;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
  }
  
  header {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .navbar {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
  }
  
  .navbar-brand {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .navbar-nav {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 30px;
  }
  
  .navbar-link {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s;
    position: relative;
  }
  
  .navbar-link:hover,
  .navbar-link.active {
    color: var(--secondary);
  }
  
  .navbar-link.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent);
    border-radius: 2px;
  }
  
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 20px;
  }
  
  .section-title {
    font-size: 2.2rem;
    font-weight: 800;
    margin: 0 0 40px;
    color: var(--primary);
    position: relative;
    padding-bottom: 15px;
  }
  
  .section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
  }

    .meet-desc {
    font-size: 1.2rem;
    color: #000000bd;
    font-weight: 500;
    margin-bottom: 25px;
  }
  .meet-desc::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
  }
  .meet-meta {
  font-size: 1.2rem;
  color: var(secondary);
  font-weight: 600;
  margin-bottom: 15px;
  margin-top: -30px; /* Pulls it closer to the title */
}
  .event-block {
    margin-bottom: 40px;
  }
  
  .event-block h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 20px;
  }
  
   /* Footer */
    footer {
  /* Remove the solid background color */
  background: rgba(0, 40, 85, 0.85); /* Semi-transparent version of your primary blue */
  backdrop-filter: blur(8px); /* Optional: Adds a glass effect */
  color: white;
  text-align: center;
  padding: 40px 20px;
  margin-top: 80px;
  position: relative;
  z-index: 1; /* Ensures footer content stays above the image */
}
.footer-with-bg {
  position: relative;
  overflow: hidden; /* Clips the image to footer boundaries */
  padding: 60px 20px;
  color: white;
  text-align: center;
}

.footer-bg-img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover; /* Ensures the mountain image fills the area */
  z-index: -1; /* Puts it behind the text */
  filter: brightness(0.5); /* Darkens the image so text is readable */
}

.footer-content {
  position: relative;
  z-index: 2;
}
  
  .btn {
    display: inline-block;
    padding: 12px 28px;
    background: var(--accent);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
  }
  
  .btn:hover {
    background: var(--accent-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 53, 0.3);
  }
</style>
</head>
<body>
  <header>
    <nav class="navbar">
      <a href="index.html" class="navbar-brand">⚡ Track & Field</a>
      <ul class="navbar-nav">
        <li><a href="/index.html" class="navbar-link">Home</a></li>
        <li><a href="index.html" class="navbar-link">Track</a></li>
        <li><a href="meets.html" class="navbar-link active">Meets</a></li>
        <li><a href="events.html" class="navbar-link">Events</a></li>
        <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
        <li><a href="analytics.html" class="navbar-link">Analytics</a></li>
      </ul>
    </nav>
  </header>
  
  <main>
    <h1 class="section-title" id="meet-title">Loading...</h1>
    <p class="meet-meta" id="meet-meta">Loading details...</p> 
    <p class="meet-desc" id="meet-description">Loading description...</p> 
    <div id="event-results">Loading results...</div>
  </main>
  
  <footer class="footer-with-bg">
    <img src="footer image.jpeg" alt="" class="footer-bg-img" />
    <div class="footer-content">
      <p>&copy; 2025 Mountain State Miles — Built by runners, for runners.</p>
      <a href="admin-login.html" class="btn btn-secondary">Admin Login</a>
    </div>
  </footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
<script src="firebase-config.js"></script>
<script>
async function waitForFirebase() {
  let attempts = 0;
  while (typeof window.firebaseDatabase === 'undefined' && attempts < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  if (typeof window.firebaseDatabase === 'undefined') {
    throw new Error('Firebase database not initialized');
  }
}

const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

async function loadMeet() {
  try {
    await waitForFirebase();
    console.log('Loading meet with slug:', slug);
    
    // Try to find meet by slug first
    let meet = null;
    const allMeetsSnapshot = await window.firebaseDatabase.ref("Track/meets").once("value");
    
    console.log('All meets snapshot exists:', allMeetsSnapshot.exists());
    
    allMeetsSnapshot.forEach(child => {
      const meetData = child.val();
      console.log('Checking meet:', child.key, meetData);
      if (meetData.slug === slug || child.key === slug) {
        meet = { id: child.key, ...meetData };
        console.log('Found meet:', meet);
      }
    });

  // Load Title
document.getElementById("meet-title").textContent =
  meet?.name ?? "Meet Not Found";

// Load Description
document.getElementById("meet-description").textContent =
  meet?.description ?? "No description available";

// Load Location and Date combined
const location = meet?.location ?? "No location";
const date = meet?.date ?? "No date";

// This combines them into "Location • Date"
document.getElementById("meet-meta").textContent = `${location} • ${date}`;

  if (!meet) {
    console.log('Meet not found with slug:', slug);
    document.getElementById("event-results").innerHTML = "<p>Meet not found. Check console for details.</p>";
    return;
  }

  // Load results for this meet
  console.log('Loading results for meet:', meet.id);
  const allResultsSnapshot = await window.firebaseDatabase.ref("Track/results").once("value");
  
  const results = [];
  allResultsSnapshot.forEach(child => {
    const resultData = child.val();
    if (resultData.meet_id === meet.id) {
      console.log('Found result:', child.key, resultData);
      results.push({ id: child.key, ...resultData });
    }
  });
  
  console.log('Total results found:', results.length);

  if (!results || !results.length) {
    document.getElementById("event-results").innerHTML = "<p>No results found.</p>";
    return;
  }

  // Load athletes and events for results
  const athleteIds = [...new Set(results.map(r => r.athlete_id).filter(Boolean))];
  const eventIds = [...new Set(results.map(r => r.event_id).filter(Boolean))];
  
  const athletesMap = {};
  const eventsMap = {};
  
  // Load athletes
  if (athleteIds.length > 0) {
      const athletesSnapshot = await window.firebaseDatabase.ref("Track/athletes").once("value");
    athletesSnapshot.forEach(child => {
      if (athleteIds.includes(child.key)) {
        athletesMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }
  
  // Load events
  if (eventIds.length > 0) {
      const eventsSnapshot = await window.firebaseDatabase.ref("Track/events").once("value");
    eventsSnapshot.forEach(child => {
      if (eventIds.includes(child.key)) {
        eventsMap[child.key] = { id: child.key, ...child.val() };
      }
    });
  }

  // Attach athlete and event data to results
  results.forEach(r => {
    r.athlete = athletesMap[r.athlete_id] || {};
    r.event = eventsMap[r.event_id] || {};
  });

  // Sort by placing
  results.sort((a, b) => {
    const placeA = a.placing || a.placement || 999;
    const placeB = b.placing || b.placement || 999;
    return placeA - placeB;
  });

  // Group by event
  const groups = {};
  results.forEach(r => {
    const eventName = r.event?.name || 'Unknown Event';
    if (!groups[eventName]) groups[eventName] = [];
    groups[eventName].push(r);
  });

  const container = document.getElementById("event-results");
  container.innerHTML = Object.entries(groups)
    .map(([eventName, rows], idx) => `
      <div class="event-block">
        <h3>${eventName}</h3>
        <div id="meet-grid-${idx}" style="height: 300px; width: 100%;"></div>
      </div>
    `).join("");

  // Initialize grids for each event
  Object.entries(groups).forEach(([eventName, rows], idx) => {
    setTimeout(() => {
      const gridId = `meet-grid-${idx}`;
      const gridElement = document.getElementById(gridId);
      if (!gridElement) return;

      const headers = ['Place', 'Athlete', 'School', 'Mark'];
      const rowData = rows.map(r => [
        r.placing || r.placement || '',
        `${r.athlete.first_name || ''} ${r.athlete.last_name || ''}`.trim(),
        r.athlete.school || '',
        r.mark || '',
        r.athlete.id || ''
      ]);

      const columnDefs = [
        { data: 0, title: 'Place', type: 'text', readOnly: true, width: 80 },
        {
          data: 1,
          title: 'Athlete',
          type: 'text',
          readOnly: true,
          renderer: function(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            const athleteId = instance.getDataAtRow(row)[4];
            if (athleteId) {
              td.innerHTML = `<a href="athlete.html?id=${athleteId}" style="color: #0056b3; text-decoration: none;">${value || ''}</a>`;
            }
          }
        },
        { data: 2, title: 'School', type: 'text', readOnly: true },
        { data: 3, title: 'Mark', type: 'text', readOnly: true, width: 120 }
      ];

      new Handsontable(gridElement, {
        data: rowData,
        colHeaders: headers,
        columns: columnDefs,
        rowHeaders: true,
        licenseKey: 'non-commercial-and-evaluation',
        height: 'auto',
        maxHeight: '300px',
        stretchH: 'all',
        columnSorting: true,
        filters: true,
        dropdownMenu: true,
        contextMenu: true,
        manualColumnResize: true
      });
    }, idx * 50);
  });
  } catch (error) {
    console.error('Error loading meet:', error);
    document.getElementById("meet-title").textContent = "Error Loading Meet";
    document.getElementById("event-results").innerHTML = '<p style="color: #dc3545;">⚠️ Error loading meet data. Please check your connection and try again.</p>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(loadMeet, 100);
});
</script>

</body>
</html>
