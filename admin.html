<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Management ‚Äì Mountain State Miles</title>
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <style>
    * { box-sizing: border-box; }

    body {
      background: #f5f7fa;
    }

    .admin-header {
      background: linear-gradient(135deg, #002855 0%, #004080 100%);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .admin-header h1 {
      margin: 0;
      font-size: 28px;
    }

    .admin-header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .search-bar {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      width: 250px;
      font-size: 14px;
    }

    .btn-logout {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-top: 4px solid #002855;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #002855;
    }

    /* Tabs */
    .section-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
    }

    .section-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      font-size: 15px;
      transition: all 0.3s;
    }

    .section-tab:hover {
      color: #002855;
    }

    .section-tab.active {
      color: #002855;
      border-bottom-color: #002855;
    }

    .section-content {
      display: none;
    }

    .section-content.active {
      display: block;
    }

    /* Data Table */
    .data-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .section-header h2 {
      margin: 0;
      color: #002855;
      font-size: 22px;
    }

    .data-controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #002855;
      color: white;
    }

    .btn-primary:hover {
      background: #004080;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Search & Filter */
    .search-filter {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .filter-select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    /* Data Grid */
    .data-grid {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 600px;
      overflow-y: auto;
    }

    .grid-header {
      display: grid;
      grid-template-columns: 2fr 1.5fr 1fr 1fr 150px;
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 2px solid #e0e0e0;
    }

    .grid-row {
      display: grid;
      grid-template-columns: 2fr 1.5fr 1fr 1fr 150px;
      gap: 15px;
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      align-items: center;
    }

    .grid-row:hover {
      background: #fafbfc;
    }

    .grid-cell-main {
      font-weight: 500;
      color: #002855;
    }

    .grid-cell-secondary {
      font-size: 13px;
      color: #666;
    }

    .grid-actions {
      display: flex;
      gap: 8px;
    }

    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: #999;
    }

    .empty-state p {
      margin: 10px 0 0 0;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 15px;
    }

    .modal-header h2 {
      margin: 0;
      color: #002855;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #002855;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #002855;
      box-shadow: 0 0 0 3px rgba(0,40,85,0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #999;
      font-size: 12px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      justify-content: flex-end;
    }

    /* Status Messages */
    .status-message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 6px;
      min-width: 300px;
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .status-icon {
      font-size: 18px;
      font-weight: bold;
    }

    /* CSV Import */
    .csv-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #1976d2;
    }

    .csv-info a {
      color: #1976d2;
      text-decoration: underline;
      font-weight: bold;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        gap: 15px;
      }

      .admin-header-actions {
        width: 100%;
        flex-direction: column;
      }

      .search-bar {
        width: 100%;
      }

      .grid-header, .grid-row {
        grid-template-columns: 1fr 1fr 100px;
      }

      .grid-header > div:nth-child(3),
      .grid-header > div:nth-child(4),
      .grid-row > div:nth-child(3),
      .grid-row > div:nth-child(4) {
        display: none;
      }

      .grid-row > div:nth-child(5) {
        grid-column: 3;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .data-grid {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <!-- Admin Header -->
  <div class="admin-header">
    <h1>üìä Data Management</h1>
    <div class="admin-header-actions">
      <input type="text" class="search-bar" id="global-search" placeholder="Search all data..." />
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <main class="admin-container">
    <!-- Dashboard Stats -->
    <div class="dashboard-stats" id="stats-container"></div>

    <!-- Section Tabs -->
    <div class="section-tabs">
      <button class="section-tab active" onclick="switchSection('schools')">üè´ Schools</button>
      <button class="section-tab" onclick="switchSection('meets')">üèÉ Meets</button>
      <button class="section-tab" onclick="switchSection('athletes')">üë• Athletes</button>
      <button class="section-tab" onclick="switchSection('results')">üèÜ Results</button>
      <button class="section-tab" onclick="switchSection('csv')">üì• CSV Import</button>
    </div>

    <!-- Schools Section -->
    <div id="schools" class="section-content active">
      <div class="data-section">
        <div class="section-header">
          <h2>Schools</h2>
          <button class="btn btn-primary" onclick="openModal('school')">+ Add School</button>
        </div>
        
        <div class="search-filter">
          <input type="text" class="search-input" id="schools-search" placeholder="Search schools..." onkeyup="filterTable('schools', 'schools-search')" />
        </div>

        <div class="data-grid" id="schools-grid">
          <div class="grid-header">
            <div>School Name</div>
            <div>Slug</div>
            <div>Results</div>
            <div></div>
            <div>Actions</div>
          </div>
          <div id="schools-list"></div>
        </div>
      </div>
    </div>

    <!-- Meets Section -->
    <div id="meets" class="section-content">
      <div class="data-section">
        <div class="section-header">
          <h2>Meets</h2>
          <button class="btn btn-primary" onclick="openModal('meet')">+ Add Meet</button>
        </div>
        
        <div class="search-filter">
          <input type="text" class="search-input" id="meets-search" placeholder="Search meets..." onkeyup="filterTable('meets', 'meets-search')" />
        </div>

        <div class="data-grid" id="meets-grid">
          <div class="grid-header">
            <div>Meet Name</div>
            <div>Date</div>
            <div>Location</div>
            <div>Results</div>
            <div>Actions</div>
          </div>
          <div id="meets-list"></div>
        </div>
      </div>
    </div>

    <!-- Athletes Section -->
    <div id="athletes" class="section-content">
      <div class="data-section">
        <div class="section-header">
          <h2>Athletes</h2>
          <button class="btn btn-primary" onclick="openModal('athlete')">+ Add Athlete</button>
        </div>
        
        <div class="search-filter">
          <input type="text" class="search-input" id="athletes-search" placeholder="Search athletes..." onkeyup="filterTable('athletes', 'athletes-search')" />
          <select class="filter-select" id="athletes-school-filter" onchange="filterTable('athletes', 'athletes-search')">
            <option value="">All Schools</option>
          </select>
        </div>

        <div class="data-grid" id="athletes-grid">
          <div class="grid-header">
            <div>Name</div>
            <div>School</div>
            <div>Grade</div>
            <div>Gender</div>
            <div>Actions</div>
          </div>
          <div id="athletes-list"></div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="results" class="section-content">
      <div class="data-section">
        <div class="section-header">
          <h2>Results</h2>
          <button class="btn btn-primary" onclick="openModal('result')">+ Add Result</button>
        </div>
        
        <div class="search-filter">
          <input type="text" class="search-input" id="results-search" placeholder="Search results..." onkeyup="filterTable('results', 'results-search')" />
          <select class="filter-select" id="results-meet-filter" onchange="filterTable('results', 'results-search')">
            <option value="">All Meets</option>
          </select>
        </div>

        <div class="data-grid" id="results-grid">
          <div class="grid-header">
            <div>Athlete</div>
            <div>Meet</div>
            <div>Time</div>
            <div>Place</div>
            <div>Actions</div>
          </div>
          <div id="results-list"></div>
        </div>
      </div>
    </div>

    <!-- CSV Import Section -->
    <div id="csv" class="section-content">
      <div class="data-section">
        <h2>üì• CSV Import</h2>
        
        <div class="csv-info">
          <strong>Need to convert RunWV results to CSV format?</strong> 
          <a href="csv-genorater.html" target="_blank">Use the CSV Generator tool ‚Üí</a>
        </div>

        <form onsubmit="handleCSVImport(event)" style="margin-bottom: 30px;">
          <div class="form-group">
            <label>Meet Slug *</label>
            <input type="text" id="csv-meet-slug" required placeholder="e.g., state-championship-2025" />
            <small>Enter the slug of an existing meet or create a new one</small>
          </div>

          <div class="form-group">
            <label>CSV File *</label>
            <input type="file" id="csv-file" accept=".csv" required />
            <small><strong>Required headers (exact order):</strong> athlete_name, school_slug, gender, time, distance, place, race_type</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Import Results</button>
          </div>
        </form>

        <h3 style="margin-top: 30px; color: #002855;">Import Status</h3>
        <div id="csv-status"></div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Add Item</h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <form id="modal-form" onsubmit="handleModalSubmit(event)">
        <div id="modal-body"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="supabase-helpers.js"></script>

  <script>
    // ===== AUTH =====
    (function requirePassword() {
      const saved = localStorage.getItem('adminLoggedIn');
      if (saved === 'true') return;
      
      const pass = prompt('Enter admin password:');
      if (pass === 'phsisbest') {
        localStorage.setItem('adminLoggedIn', 'true');
        return;
      }
      
      alert('Access denied.');
      window.location.replace('index.html');
    })();

    function logout() {
      localStorage.removeItem('adminLoggedIn');
      window.location.reload();
    }

    // ===== STATE & UTILS =====
    const USE_WORD_GRADE_LABELS = false;
    let currentModal = null;
    let allData = { schools: [], meets: [], athletes: [], results: [] };

    function formatGrade(gradYear) {
      if (!gradYear) return 'N/A';
      const yearNum = parseInt(gradYear, 10);
      if (Number.isNaN(yearNum)) return 'N/A';
      const now = new Date();
      const month = now.getMonth();
      const currentYear = now.getFullYear();
      const academicEndYear = month >= 7 ? currentYear + 1 : currentYear;
      const gradeNum = 12 - (yearNum - academicEndYear);
      const numLabels = { 9: '9th', 10: '10th', 11: '11th', 12: '12th' };
      const wordLabels = { 9: 'Freshman', 10: 'Sophomore', 11: 'Junior', 12: 'Senior' };
      const dict = USE_WORD_GRADE_LABELS ? wordLabels : numLabels;
      return dict[gradeNum] || 'N/A';
    }

    function showStatus(message, type = 'success') {
      const div = document.createElement('div');
      div.className = `status-message ${type}`;
      div.innerHTML = `
        <span class="status-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllData();
      updateStats();
      populateFilters();
    });

    async function loadAllData() {
      const [schools, meets, athletes, results] = await Promise.all([
        supabase.from('schools').select('*').order('name'),
        supabase.from('meets').select('*').order('date', { ascending: false }),
        supabase.from('athletes').select('*').order('name'),
        supabase.from('results').select('*').order('created_at', { ascending: false })
      ]);

      allData = {
        schools: schools.data || [],
        meets: meets.data || [],
        athletes: athletes.data || [],
        results: results.data || []
      };

      renderSchools();
      renderMeets();
      renderAthletes();
      renderResults();
    }

    function updateStats() {
      const stats = document.getElementById('stats-container');
      stats.innerHTML = `
        <div class="stat-card">
          <h3>Schools</h3>
          <div class="number">${allData.schools.length}</div>
        </div>
        <div class="stat-card">
          <h3>Meets</h3>
          <div class="number">${allData.meets.length}</div>
        </div>
        <div class="stat-card">
          <h3>Athletes</h3>
          <div class="number">${allData.athletes.length}</div>
        </div>
        <div class="stat-card">
          <h3>Results</h3>
          <div class="number">${allData.results.length}</div>
        </div>
      `;
    }

    function populateFilters() {
      const schoolFilter = document.getElementById('athletes-school-filter');
      schoolFilter.innerHTML = '<option value="">All Schools</option>';
      allData.schools.forEach(s => {
        schoolFilter.innerHTML += `<option value="${s.slug}">${s.name}</option>`;
      });

      const meetFilter = document.getElementById('results-meet-filter');
      meetFilter.innerHTML = '<option value="">All Meets</option>';
      allData.meets.forEach(m => {
        meetFilter.innerHTML += `<option value="${m.slug}">${m.name}</option>`;
      });
    }

    // ===== TAB SWITCHING =====
    function switchSection(section) {
      document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.section-tab').forEach(el => el.classList.remove('active'));
      document.getElementById(section).classList.add('active');
      event.target.classList.add('active');
    }

    // ===== MODAL =====
    function openModal(type, id = null) {
      currentModal = { type, id };
      const modal = document.getElementById('modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      if (type === 'school') {
        title.textContent = id ? 'Edit School' : 'Add School';
        const item = id ? allData.schools.find(s => s.id === id) : {};
        body.innerHTML = `
          <div class="form-group">
            <label>School Name *</label>
            <input type="text" id="form-school-name" value="${item.name || ''}" required />
          </div>
          <div class="form-group">
            <label>Slug *</label>
            <input type="text" id="form-school-slug" value="${item.slug || ''}" required />
            <small>e.g., parkersburg-high</small>
          </div>
        `;
      } else if (type === 'meet') {
        title.textContent = id ? 'Edit Meet' : 'Add Meet';
        const item = id ? allData.meets.find(m => m.id === id) : {};
        body.innerHTML = `
          <div class="form-row">
            <div class="form-group">
              <label>Meet Name *</label>
              <input type="text" id="form-meet-name" value="${item.name || ''}" required />
            </div>
            <div class="form-group">
              <label>Slug *</label>
              <input type="text" id="form-meet-slug" value="${item.slug || ''}" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="form-meet-date" value="${item.date || ''}" required />
            </div>
            <div class="form-group">
              <label>Location</label>
              <input type="text" id="form-meet-location" value="${item.location || ''}" />
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="form-meet-description">${item.description || ''}</textarea>
          </div>
        `;
      } else if (type === 'athlete') {
        title.textContent = id ? 'Edit Athlete' : 'Add Athlete';
        const item = id ? allData.athletes.find(a => a.id === id) : {};
        const schoolOptions = allData.schools.map(s => `<option value="${s.slug}" ${item.school_slug === s.slug ? 'selected' : ''}>${s.name}</option>`).join('');
        body.innerHTML = `
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="form-athlete-name" value="${item.name || ''}" required />
            </div>
            <div class="form-group">
              <label>School</label>
              <select id="form-athlete-school">
                <option value="">Select...</option>
                ${schoolOptions}
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Grade (Graduation Year)</label>
              <input type="number" id="form-athlete-grade" value="${item.grade || ''}" min="2020" max="2030" />
              <small>e.g., 2026 for a current senior</small>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="form-athlete-gender">
                <option value="">Select...</option>
                <option value="M" ${item.gender === 'M' ? 'selected' : ''}>Male</option>
                <option value="F" ${item.gender === 'F' ? 'selected' : ''}>Female</option>
              </select>
            </div>
          </div>
        `;
      } else if (type === 'result') {
        title.textContent = id ? 'Edit Result' : 'Add Result';
        const item = id ? allData.results.find(r => r.id === id) : {};
        const meetOptions = allData.meets.map(m => `<option value="${m.slug}" ${item.meet_slug === m.slug ? 'selected' : ''}>${m.name}</option>`).join('');
        const schoolOptions = allData.schools.map(s => `<option value="${s.slug}" ${item.school_slug === s.slug ? 'selected' : ''}>${s.name}</option>`).join('');
        body.innerHTML = `
          <div class="form-group">
            <label>Athlete Name *</label>
            <input type="text" id="form-result-athlete" value="${item.athlete_name || ''}" required />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Meet</label>
              <select id="form-result-meet">
                <option value="">Select...</option>
                ${meetOptions}
              </select>
            </div>
            <div class="form-group">
              <label>School</label>
              <select id="form-result-school">
                <option value="">Select...</option>
                ${schoolOptions}
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Time (seconds)</label>
              <input type="number" id="form-result-time" value="${item.time || ''}" step="0.01" />
            </div>
            <div class="form-group">
              <label>Distance (meters)</label>
              <input type="number" id="form-result-distance" value="${item.distance || ''}" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Place</label>
              <input type="number" id="form-result-place" value="${item.place || ''}" />
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="form-result-gender">
                <option value="">Select...</option>
                <option value="M" ${item.gender === 'M' ? 'selected' : ''}>Male</option>
                <option value="F" ${item.gender === 'F' ? 'selected' : ''}>Female</option>
              </select>
            </div>
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      currentModal = null;
    }

    async function handleModalSubmit(e) {
      e.preventDefault();
      const { type, id } = currentModal;

      try {
        if (type === 'school') {
          const name = document.getElementById('form-school-name').value;
          const slug = document.getElementById('form-school-slug').value;
          if (id) {
            await supabase.from('schools').update({ name, slug }).eq('id', id);
            showStatus('School updated!');
          } else {
            await supabase.from('schools').insert({ name, slug });
            showStatus('School added!');
          }
        } else if (type === 'meet') {
          const name = document.getElementById('form-meet-name').value;
          const slug = document.getElementById('form-meet-slug').value;
          const date = document.getElementById('form-meet-date').value;
          const location = document.getElementById('form-meet-location').value;
          const description = document.getElementById('form-meet-description').value;
          if (id) {
            await supabase.from('meets').update({ name, slug, date, location, description }).eq('id', id);
            showStatus('Meet updated!');
          } else {
            await supabase.from('meets').insert({ name, slug, date, location, description });
            showStatus('Meet added!');
          }
        } else if (type === 'athlete') {
          const name = document.getElementById('form-athlete-name').value;
          const school_slug = document.getElementById('form-athlete-school').value || null;
          const grade = document.getElementById('form-athlete-grade').value || null;
          const gender = document.getElementById('form-athlete-gender').value || null;
          if (id) {
            await supabase.from('athletes').update({ name, school_slug, grade, gender }).eq('id', id);
            showStatus('Athlete updated!');
          } else {
            await supabase.from('athletes').insert({ name, school_slug, grade, gender });
            showStatus('Athlete added!');
          }
        } else if (type === 'result') {
          const athlete_name = document.getElementById('form-result-athlete').value;
          const meet_slug = document.getElementById('form-result-meet').value || null;
          const school_slug = document.getElementById('form-result-school').value || null;
          const time = document.getElementById('form-result-time').value || null;
          const distance = document.getElementById('form-result-distance').value || null;
          const place = document.getElementById('form-result-place').value || null;
          const gender = document.getElementById('form-result-gender').value || null;
          if (id) {
            await supabase.from('results').update({ athlete_name, meet_slug, school_slug, time, distance, place, gender }).eq('id', id);
            showStatus('Result updated!');
          } else {
            await supabase.from('results').insert({ athlete_name, meet_slug, school_slug, time, distance, place, gender });
            showStatus('Result added!');
          }
        }
        closeModal();
        await loadAllData();
        updateStats();
        populateFilters();
      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
      }
    }

    // ===== RENDERING =====
    function renderSchools() {
      const list = document.getElementById('schools-list');
      if (allData.schools.length === 0) {
        list.innerHTML = '<div class="empty-state">No schools yet. Add one to get started!</div>';
        return;
      }
      list.innerHTML = allData.schools.map(s => `
        <div class="grid-row">
          <div class="grid-cell-main">${s.name}</div>
          <div class="grid-cell-secondary">${s.slug}</div>
          <div class="grid-cell-secondary">${allData.results.filter(r => r.school_slug === s.slug).length}</div>
          <div></div>
          <div class="grid-actions">
            <button class="btn btn-secondary btn-small" onclick="openModal('school', '${s.id}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteItem('schools', '${s.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderMeets() {
      const list = document.getElementById('meets-list');
      if (allData.meets.length === 0) {
        list.innerHTML = '<div class="empty-state">No meets yet. Add one to get started!</div>';
        return;
      }
      list.innerHTML = allData.meets.map(m => `
        <div class="grid-row">
          <div class="grid-cell-main">${m.name}</div>
          <div class="grid-cell-secondary">${m.date}</div>
          <div class="grid-cell-secondary">${m.location || '-'}</div>
          <div class="grid-cell-secondary">${allData.results.filter(r => r.meet_slug === m.slug).length}</div>
          <div class="grid-actions">
            <button class="btn btn-secondary btn-small" onclick="openModal('meet', '${m.id}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteItem('meets', '${m.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderAthletes() {
      const list = document.getElementById('athletes-list');
      if (allData.athletes.length === 0) {
        list.innerHTML = '<div class="empty-state">No athletes yet. Add one to get started!</div>';
        return;
      }
      list.innerHTML = allData.athletes.map(a => `
        <div class="grid-row">
          <div class="grid-cell-main">${a.name}</div>
          <div class="grid-cell-secondary">${allData.schools.find(s => s.slug === a.school_slug)?.name || '-'}</div>
          <div class="grid-cell-secondary">${formatGrade(a.grade)}</div>
          <div class="grid-cell-secondary">${a.gender || '-'}</div>
          <div class="grid-actions">
            <button class="btn btn-secondary btn-small" onclick="openModal('athlete', '${a.id}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteItem('athletes', '${a.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderResults() {
      const list = document.getElementById('results-list');
      if (allData.results.length === 0) {
        list.innerHTML = '<div class="empty-state">No results yet. Import from CSV or add manually!</div>';
        return;
      }
      list.innerHTML = allData.results.map(r => `
        <div class="grid-row">
          <div class="grid-cell-main">${r.athlete_name}</div>
          <div class="grid-cell-secondary">${allData.meets.find(m => m.slug === r.meet_slug)?.name || '-'}</div>
          <div class="grid-cell-secondary">${r.time ? r.time + 's' : '-'}</div>
          <div class="grid-cell-secondary">${r.place || '-'}</div>
          <div class="grid-actions">
            <button class="btn btn-secondary btn-small" onclick="openModal('result', '${r.id}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteItem('results', '${r.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // ===== DELETE & FILTER =====
    async function deleteItem(type, id) {
      if (!confirm('Delete this item?')) return;
      await supabase.from(type).delete().eq('id', id);
      showStatus('Deleted!');
      await loadAllData();
      updateStats();
    }

    function filterTable(type, searchId) {
      const search = document.getElementById(searchId).value.toLowerCase();
      const rows = document.getElementById(`${type}-list`).querySelectorAll('.grid-row');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }

    // ===== CSV IMPORT =====
    function humanizeSlug(slug) {
      return slug.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    async function handleCSVImport(e) {
      e.preventDefault();
      const meetSlug = document.getElementById('csv-meet-slug').value;
      const file = document.getElementById('csv-file').files[0];

      if (!file) return;

      try {
        const text = await file.text();
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const expected = ['athlete_name', 'school_slug', 'gender', 'time', 'distance', 'place', 'race_type'];
        
        if (headers.join(',') !== expected.join(',')) {
          throw new Error(`CSV headers must be exactly: ${expected.join(', ')}`);
        }

        const results = [];
        const errors = [];
        const knownSchools = new Set(allData.schools.map(s => s.slug));
        const knownAthletes = new Set(allData.athletes.map(a => `${a.name}||${a.school_slug || ''}`));

        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
          const row = {};
          headers.forEach((h, idx) => { row[h] = values[idx] || null; });

          // Ensure school
          if (row.school_slug && !knownSchools.has(row.school_slug)) {
            await supabase.from('schools').insert({ name: humanizeSlug(row.school_slug), slug: row.school_slug });
            knownSchools.add(row.school_slug);
          }

          // Ensure athlete
          const athleteKey = `${row.athlete_name}||${row.school_slug || ''}`;
          if (!knownAthletes.has(athleteKey)) {
            await supabase.from('athletes').insert({ name: row.athlete_name, school_slug: row.school_slug || null });
            knownAthletes.add(athleteKey);
          }

          // Parse time
          if (row.time) {
            const timeStr = row.time.toString();
            if (timeStr.includes(':')) {
              const parts = timeStr.split(':');
              row.time = parts.length === 2 ? parseInt(parts[0]) * 60 + parseFloat(parts[1]) : parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2]);
            } else {
              row.time = parseFloat(row.time);
            }
          }

          row.meet_slug = meetSlug;
          row.place = row.place ? parseInt(row.place) : null;
          row.distance = row.distance ? parseInt(row.distance) : null;
          results.push(row);
        }

        if (results.length === 0) throw new Error('No valid rows in CSV');

        await supabase.from('results').insert(results);
        document.getElementById('csv-status').innerHTML = `<div style="color: #155724; background: #d4edda; padding: 15px; border-radius: 6px;">‚úì Successfully imported ${results.length} results!</div>`;
        document.getElementById('csv-meet-slug').value = '';
        document.getElementById('csv-file').value = '';
        showStatus(`Imported ${results.length} results!`);
        await loadAllData();
        updateStats();
      } catch (error) {
        document.getElementById('csv-status').innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 15px; border-radius: 6px;">‚úï ${error.message}</div>`;
        showStatus(error.message, 'error');
      }
    }
  </script>
</body>
</html>

