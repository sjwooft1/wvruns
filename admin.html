<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Management â€“ WV Runs</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #002855;
    }

    .tab {
      padding: 10px 20px;
      background: #f4f4f4;
      border: none;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .tab:hover {
      background: #e0e0e0;
    }

    .tab.active {
      background: #002855;
      color: white;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 20px;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #002855;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      margin-right: 10px;
    }

    .btn-primary {
      background: #002855;
      color: white;
    }

    .btn-primary:hover {
      background: #004080;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .data-list {
      margin-top: 20px;
    }

    .data-item {
      background: #f8f9fa;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #002855;
    }

    .data-item-info {
      flex: 1;
    }

    .data-item-info h4 {
      margin: 0 0 5px 0;
      color: #002855;
    }

    .data-item-info p {
      margin: 3px 0;
      font-size: 14px;
      color: #666;
    }

    .data-item-actions {
      display: flex;
      gap: 10px;
    }

    .status-message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h3 {
      color: #002855;
      border-bottom: 2px solid #002855;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/Wvruns Logo.png" alt="WV Runs Logo" class="logo" />
    <nav>
      <a href="home.html">Home</a>
      <a href="schools.html">Schools</a>
      <a href="meets.html">Meets</a>
    </nav>
  </header>

  <main>
    <div class="admin-container">
      <h1>Data Management</h1>

      <!-- Status Messages -->
      <div id="status-message" class="status-message"></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('schools')">Schools</button>
        <button class="tab" onclick="showTab('meets')">Meets</button>
        <button class="tab" onclick="showTab('athletes')">Athletes</button>
        <button class="tab" onclick="showTab('results')">Results</button>
        <button class="tab" onclick="showTab('csv-import')">CSV Import</button>
      </div>

      <!-- Schools Tab -->
      <div id="schools" class="tab-content active">
        <div class="form-section">
          <h3>Add New School</h3>
          <form id="school-form" onsubmit="addSchool(event)">
            <div class="form-row">
              <div class="form-group">
                <label>School Name *</label>
                <input type="text" id="school-name" required />
              </div>
              <div class="form-group">
                <label>Slug * (e.g., parkersburg-high)</label>
                <input type="text" id="school-slug" required />
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add School</button>
          </form>
        </div>

        <div class="data-list">
          <h3>Existing Schools</h3>
          <div id="schools-list"></div>
        </div>
      </div>

      <!-- Meets Tab -->
      <div id="meets" class="tab-content">
        <div class="form-section">
          <h3>Add New Meet</h3>
          <form id="meet-form" onsubmit="addMeet(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Meet Name *</label>
                <input type="text" id="meet-name" required />
              </div>
              <div class="form-group">
                <label>Slug * (e.g., state-xc-2025)</label>
                <input type="text" id="meet-slug" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Date *</label>
                <input type="date" id="meet-date" required />
              </div>
              <div class="form-group">
                <label>Location</label>
                <input type="text" id="meet-location" />
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="meet-description"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Add Meet</button>
          </form>
        </div>

        <div class="data-list">
          <h3>Existing Meets</h3>
          <div id="meets-list"></div>
        </div>
      </div>

      <!-- Athletes Tab -->
      <div id="athletes" class="tab-content">
        <div class="form-section">
          <h3>Add New Athlete</h3>
          <form id="athlete-form" onsubmit="addAthlete(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Name *</label>
                <input type="text" id="athlete-name" required />
              </div>
              <div class="form-group">
                <label>School</label>
                <select id="athlete-school">
                  <option value="">Select a school...</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Grade</label>
                <input type="number" id="athlete-grade" min="2020" max="2030" />
              </div>
              <div class="form-group">
                <label>Gender</label>
                <select id="athlete-gender">
                  <option value="">Select...</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Athlete</button>
          </form>
        </div>

        <div class="data-list">
          <h3>Existing Athletes</h3>
          <div id="athletes-list"></div>
        </div>
      </div>

      <!-- Results Tab -->
      <div id="results" class="tab-content">
        <div class="form-section">
          <h3>Add New Result</h3>
          <form id="result-form" onsubmit="addResult(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Athlete Name *</label>
                <input type="text" id="result-athlete" required />
              </div>
              <div class="form-group">
                <label>Meet</label>
                <select id="result-meet">
                  <option value="">Select a meet...</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>School</label>
                <select id="result-school">
                  <option value="">Select a school...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Gender</label>
                <select id="result-gender">
                  <option value="">Select...</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Time (seconds)</label>
                <input type="number" id="result-time" step="0.01" />
              </div>
              <div class="form-group">
                <label>Distance (meters)</label>
                <input type="number" id="result-distance" />
              </div>
            </div>
            <div class="form-group">
              <label>Place</label>
              <input type="number" id="result-place" />
            </div>
            <button type="submit" class="btn btn-primary">Add Result</button>
          </form>
        </div>

        <div class="data-list">
          <h3>Existing Results</h3>
          <div id="results-list"></div>
        </div>
      </div>

      <!-- CSV Import Tab -->
      <div id="csv-import" class="tab-content">
        <div class="form-section">
          <h3>Import Meet Results from CSV</h3>
          <p>Simple import using the exact headers from your RunWV CSV.</p>
          <p><strong>Required CSV header row (exact order):</strong></p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li><strong>athlete_name</strong></li>
            <li><strong>school_slug</strong></li>
            <li><strong>gender</strong></li>
            <li><strong>time</strong></li>
            <li><strong>distance</strong></li>
            <li><strong>place</strong></li>
          </ul>

          <div class="form-group">
            <label>Meet Slug *</label>
            <input type="text" id="simple-meet-slug" required placeholder="e.g., state-championship-2025" />
            <small style="color: #666; margin-top: 5px; display: block;"><a href="#" onclick="loadExistingMeets()">Check existing meets</a></small>
          </div>

          <div class="form-group">
            <label>CSV File *</label>
            <input type="file" id="simple-csv-file" accept=".csv" required />
          </div>

          <button type="button" class="btn btn-primary" onclick="simpleImportCSV()">Import Results</button>
        </div>

        <div class="data-list">
          <h3>Import Status</h3>
          <div id="import-status"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 WV Runs â€” Built by runners, for runners.</p>
  </footer>

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabase Configuration -->
  <script src="supabase-config.js"></script>
  <!-- Supabase Helpers -->
  <script src="supabase-helpers.js"></script>
  
  <script>
    // Simple password gate (no storage)
    (function requirePassword() {
      const pass = prompt('Enter admin password:');
      if (pass !== 'phsisbest') {
        alert('Access denied.');
        window.location.replace('home.html');
      }
    })();
  </script>
  <script>
    // Toggle: set to true to show word labels (freshmanâ€“senior)
    const USE_WORD_GRADE_LABELS = false;

    // Convert graduation year to grade label (9thâ€“12th or words) based on current academic year
    function formatGrade(gradYear) {
      if (!gradYear) return 'N/A';
      const yearNum = parseInt(gradYear, 10);
      if (Number.isNaN(yearNum)) return 'N/A';
      const now = new Date();
      const month = now.getMonth(); // 0=Jan ... 11=Dec
      const currentYear = now.getFullYear();
      // Academic year ends the next calendar year if it's Aug (7) or later
      const academicEndYear = month >= 7 ? currentYear + 1 : currentYear;
      const gradeNum = 12 - (yearNum - academicEndYear);
      const numLabels = { 9: '9th', 10: '10th', 11: '11th', 12: '12th' };
      const wordLabels = { 9: 'Freshman', 10: 'Sophomore', 11: 'Junior', 12: 'Senior' };
      const dict = USE_WORD_GRADE_LABELS ? wordLabels : numLabels;
      return dict[gradeNum] || 'N/A';
    }

    // Initialize data on load
    document.addEventListener('DOMContentLoaded', () => {
      loadSchools();
      loadMeets();
      loadAthletes();
      loadResults();
      populateSelectOptions();
    });

    // Tab switching
    function showTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    // Status messages
    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status-message');
      statusDiv.className = `status-message ${type}`;
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.className = 'status-message';
      }, 5000);
    }

    // Populate select dropdowns
    async function populateSelectOptions() {
      // Load schools for selects
      const { data: schools } = await supabase.from('schools').select('*').order('name');
      const schoolSelects = ['athlete-school', 'result-school'];
      
      schoolSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select a school...</option>';
        schools?.forEach(school => {
          const option = document.createElement('option');
          option.value = school.slug;
          option.textContent = school.name;
          select.appendChild(option);
        });
      });

      // Load meets for selects
      const { data: meets } = await supabase.from('meets').select('*').order('date', { ascending: false });
      const meetSelect = document.getElementById('result-meet');
      meetSelect.innerHTML = '<option value="">Select a meet...</option>';
      meets?.forEach(meet => {
        const option = document.createElement('option');
        option.value = meet.slug;
        option.textContent = `${meet.name} - ${meet.date}`;
        meetSelect.appendChild(option);
      });
    }

    // ===== SCHOOLS =====
    async function loadSchools() {
      const { data, error } = await supabase.from('schools').select('*').order('name');
      if (error) {
        console.error('Error loading schools:', error);
        return;
      }

      const list = document.getElementById('schools-list');
      list.innerHTML = '';

      data?.forEach(school => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.innerHTML = `
          <div class="data-item-info">
            <h4>${school.name}</h4>
            <p>Slug: ${school.slug}</p>
          </div>
          <div class="data-item-actions">
            <button class="btn btn-primary" onclick="editSchool('${school.id}', '${school.name}', '${school.slug}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteSchool('${school.id}')">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    async function addSchool(event) {
      event.preventDefault();
      
      const name = document.getElementById('school-name').value;
      const slug = document.getElementById('school-slug').value;

      const { error } = await supabase.from('schools').insert({ name, slug });

      if (error) {
        showStatus(`Error adding school: ${error.message}`, 'error');
      } else {
        showStatus('School added successfully!');
        document.getElementById('school-form').reset();
        loadSchools();
      }
    }

    async function editSchool(id, name, slug) {
      const newName = prompt('Enter new school name:', name);
      if (!newName) return;
      
      const newSlug = prompt('Enter new slug:', slug);
      if (!newSlug) return;

      const { error } = await supabase.from('schools').update({ name: newName, slug: newSlug }).eq('id', id);

      if (error) {
        showStatus(`Error updating school: ${error.message}`, 'error');
      } else {
        showStatus('School updated successfully!');
        loadSchools();
        populateSelectOptions();
      }
    }

    async function deleteSchool(id) {
      if (!confirm('Are you sure you want to delete this school?')) return;

      const { error } = await supabase.from('schools').delete().eq('id', id);

      if (error) {
        showStatus(`Error deleting school: ${error.message}`, 'error');
      } else {
        showStatus('School deleted successfully!');
        loadSchools();
      }
    }

    // ===== MEETS =====
    async function loadMeets() {
      const { data, error } = await supabase.from('meets').select('*').order('date', { ascending: false });
      if (error) {
        console.error('Error loading meets:', error);
        return;
      }

      const list = document.getElementById('meets-list');
      list.innerHTML = '';

      data?.forEach(meet => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.innerHTML = `
          <div class="data-item-info">
            <h4>${meet.name}</h4>
            <p>Date: ${meet.date} | Location: ${meet.location || 'N/A'}</p>
            <p>Slug: ${meet.slug}</p>
          </div>
          <div class="data-item-actions">
            <button class="btn btn-primary" onclick="editMeet('${meet.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteMeet('${meet.id}')">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    async function addMeet(event) {
      event.preventDefault();
      
      const name = document.getElementById('meet-name').value;
      const slug = document.getElementById('meet-slug').value;
      const date = document.getElementById('meet-date').value;
      const location = document.getElementById('meet-location').value;
      const description = document.getElementById('meet-description').value;

      const { error } = await supabase.from('meets').insert({ 
        name, slug, date, location, description 
      });

      if (error) {
        showStatus(`Error adding meet: ${error.message}`, 'error');
      } else {
        showStatus('Meet added successfully!');
        document.getElementById('meet-form').reset();
        loadMeets();
        populateSelectOptions();
      }
    }

    async function editMeet(id) {
      // Load meet data first
      const { data: meet } = await supabase.from('meets').select('*').eq('id', id).single();
      if (!meet) {
        showStatus('Error loading meet data', 'error');
        return;
      }

      const name = prompt('Enter meet name:', meet.name);
      if (!name) return;
      
      const slug = prompt('Enter slug:', meet.slug);
      if (!slug) return;

      const date = prompt('Enter date (YYYY-MM-DD):', meet.date);
      if (!date) return;

      const location = prompt('Enter location:', meet.location || '');
      const description = prompt('Enter description:', meet.description || '');

      const { error } = await supabase.from('meets').update({ name, slug, date, location, description }).eq('id', id);

      if (error) {
        showStatus(`Error updating meet: ${error.message}`, 'error');
      } else {
        showStatus('Meet updated successfully!');
        loadMeets();
        populateSelectOptions();
      }
    }

    async function deleteMeet(id) {
      if (!confirm('Are you sure you want to delete this meet?')) return;

      const { error } = await supabase.from('meets').delete().eq('id', id);

      if (error) {
        showStatus(`Error deleting meet: ${error.message}`, 'error');
      } else {
        showStatus('Meet deleted successfully!');
        loadMeets();
        populateSelectOptions();
      }
    }

    // ===== ATHLETES =====
    async function loadAthletes() {
      const { data, error } = await supabase.from('athletes').select('*').order('name');
      if (error) {
        console.error('Error loading athletes:', error);
        return;
      }

      const list = document.getElementById('athletes-list');
      list.innerHTML = '';

      data?.forEach(athlete => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.innerHTML = `
          <div class="data-item-info">
            <h4>${athlete.name}</h4>
            <p>Grade: ${formatGrade(athlete.grade)} | Gender: ${athlete.gender || 'N/A'}</p>
            <p>School: ${athlete.school_slug || 'N/A'}</p>
          </div>
          <div class="data-item-actions">
            <button class="btn btn-primary" onclick="editAthlete('${athlete.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteAthlete('${athlete.id}')">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    async function addAthlete(event) {
      event.preventDefault();
      
      const name = document.getElementById('athlete-name').value;
      const school_slug = document.getElementById('athlete-school').value || null;
      const grade = document.getElementById('athlete-grade').value || null;
      const gender = document.getElementById('athlete-gender').value || null;

      const { error } = await supabase.from('athletes').insert({ 
        name, school_slug, grade, gender 
      });

      if (error) {
        showStatus(`Error adding athlete: ${error.message}`, 'error');
      } else {
        showStatus('Athlete added successfully!');
        document.getElementById('athlete-form').reset();
        loadAthletes();
      }
    }

    async function editAthlete(id) {
      // Load athlete data first
      const { data: athlete } = await supabase.from('athletes').select('*').eq('id', id).single();
      if (!athlete) {
        showStatus('Error loading athlete data', 'error');
        return;
      }

      const name = prompt('Enter athlete name:', athlete.name);
      if (!name) return;
      
      const grade = prompt('Enter grade (year):', athlete.grade || '');
      const gender = prompt('Enter gender (M/F):', athlete.gender || '');

      const schoolSlug = prompt('Enter school slug:', athlete.school_slug || '');

      const { error } = await supabase.from('athletes').update({ 
        name, 
        grade: grade || null, 
        gender: gender || null,
        school_slug: schoolSlug || null
      }).eq('id', id);

      if (error) {
        showStatus(`Error updating athlete: ${error.message}`, 'error');
      } else {
        showStatus('Athlete updated successfully!');
        loadAthletes();
      }
    }

    async function deleteAthlete(id) {
      if (!confirm('Are you sure you want to delete this athlete?')) return;

      const { error } = await supabase.from('athletes').delete().eq('id', id);

      if (error) {
        showStatus(`Error deleting athlete: ${error.message}`, 'error');
      } else {
        showStatus('Athlete deleted successfully!');
        loadAthletes();
      }
    }

    // ===== RESULTS =====
    async function loadResults() {
      const { data, error } = await supabase.from('results').select('*').order('date', { ascending: false });
      if (error) {
        console.error('Error loading results:', error);
        return;
      }

      const list = document.getElementById('results-list');
      list.innerHTML = '';

      data?.forEach(result => {
        const item = document.createElement('div');
        item.className = 'data-item';
        item.innerHTML = `
          <div class="data-item-info">
            <h4>${result.athlete_name}</h4>
            <p>Time: ${result.time || 'N/A'}s | Distance: ${result.distance || 'N/A'}m | Place: ${result.place || 'N/A'}</p>
            <p>Meet: ${result.meet_slug || 'N/A'} | School: ${result.school_slug || 'N/A'}</p>
          </div>
          <div class="data-item-actions">
            <button class="btn btn-primary" onclick="editResult('${result.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteResult('${result.id}')">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    async function addResult(event) {
      event.preventDefault();
      
      const athlete_name = document.getElementById('result-athlete').value;
      const meet_slug = document.getElementById('result-meet').value || null;
      const school_slug = document.getElementById('result-school').value || null;
      const gender = document.getElementById('result-gender').value || null;
      const time = document.getElementById('result-time').value || null;
      const distance = document.getElementById('result-distance').value || null;
      const place = document.getElementById('result-place').value || null;

      const { error } = await supabase.from('results').insert({ 
        athlete_name, meet_slug, school_slug, gender, time, distance, place 
      });

      if (error) {
        showStatus(`Error adding result: ${error.message}`, 'error');
      } else {
        showStatus('Result added successfully!');
        document.getElementById('result-form').reset();
        loadResults();
      }
    }

    async function editResult(id) {
      // Load result data first
      const { data: result } = await supabase.from('results').select('*').eq('id', id).single();
      if (!result) {
        showStatus('Error loading result data', 'error');
        return;
      }

      const athleteName = prompt('Enter athlete name:', result.athlete_name);
      if (!athleteName) return;
      
      const time = prompt('Enter time (seconds):', result.time || '');
      const distance = prompt('Enter distance (meters):', result.distance || '');
      const place = prompt('Enter place:', result.place || '');
      const gender = prompt('Enter gender (M/F):', result.gender || '');
      const meetSlug = prompt('Enter meet slug:', result.meet_slug || '');
      const schoolSlug = prompt('Enter school slug:', result.school_slug || '');

      const { error } = await supabase.from('results').update({ 
        athlete_name: athleteName,
        time: time || null,
        distance: distance || null,
        place: place || null,
        gender: gender || null,
        meet_slug: meetSlug || null,
        school_slug: schoolSlug || null
      }).eq('id', id);

      if (error) {
        showStatus(`Error updating result: ${error.message}`, 'error');
      } else {
        showStatus('Result updated successfully!');
        loadResults();
      }
    }

    async function deleteResult(id) {
      if (!confirm('Are you sure you want to delete this result?')) return;

      const { error } = await supabase.from('results').delete().eq('id', id);

      if (error) {
        showStatus(`Error deleting result: ${error.message}`, 'error');
      } else {
        showStatus('Result deleted successfully!');
        loadResults();
      }
    };

    // ===== CSV IMPORT ENHANCED =====
    function humanizeSlug(slug) {
      if (!slug) return '';
      return slug
        .toString()
        .split('-')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }

    async function ensureSchoolExists(schoolSlug, knownSchools) {
      if (!schoolSlug) return true;
      if (knownSchools.has(schoolSlug)) return true;
      // Check existence first
      const { data: existing, error: selectErr } = await supabase
        .from('schools')
        .select('slug')
        .eq('slug', schoolSlug)
        .limit(1);
      if (!selectErr && existing && existing.length) {
        knownSchools.add(schoolSlug);
        return true;
      }
      // Insert only if not found
      const name = humanizeSlug(schoolSlug);
      const { error: insertErr } = await supabase.from('schools').insert({ name, slug: schoolSlug });
      if (!insertErr) {
        knownSchools.add(schoolSlug);
        return true;
      }
      return false;
    }

    async function ensureAthleteExists(athleteName, schoolSlug, knownAthletes) {
      if (!athleteName) return true;
      const key = `${athleteName}||${schoolSlug || ''}`;
      if (knownAthletes.has(key)) return true;
      // Check existence first
      const { data: existing, error: selectErr } = await supabase
        .from('athletes')
        .select('name, school_slug')
        .eq('name', athleteName)
        .eq('school_slug', schoolSlug || null)
        .limit(1);
      if (!selectErr && existing && existing.length) {
        knownAthletes.add(key);
        return true;
      }
      // Insert only if not found
      const { error: insertErr } = await supabase
        .from('athletes')
        .insert({ name: athleteName, school_slug: schoolSlug || null });
      if (!insertErr) {
        knownAthletes.add(key);
        return true;
      }
      return false;
    }

    async function bulkInsertResults(meetSlug, csvData) {
      const results = { success: 0, errors: [], total: csvData.length };

      // Fetch known schools and athletes into sets for quick checks
      const { data: schoolRows } = await supabase.from('schools').select('slug');
      const knownSchools = new Set((schoolRows || []).map(s => s.slug));

      // Athletes set: we will grow it as we insert to avoid huge initial fetch; but seed with a small snapshot
      const { data: athleteRows } = await supabase.from('athletes').select('name, school_slug').limit(5000);
      const knownAthletes = new Set((athleteRows || []).map(a => `${a.name}||${a.school_slug || ''}`));

      const requiredFields = ['athlete_name'];
      const validRows = [];

      for (let i = 0; i < csvData.length; i++) {
        const row = { ...csvData[i] };
        const missingFields = requiredFields.filter(field => !row[field]);
        if (missingFields.length > 0) {
          results.errors.push(`Row ${i + 1}: Missing required fields: ${missingFields.join(', ')}`);
          continue;
        }

        // Ensure school exists
        if (row.school_slug) {
          const okSchool = await ensureSchoolExists(row.school_slug, knownSchools);
          if (!okSchool) {
            results.errors.push(`Row ${i + 1}: Unable to create or find school '${row.school_slug}'.`);
            continue;
          }
        }

        // Ensure athlete exists
        const okAthlete = await ensureAthleteExists(row.athlete_name, row.school_slug || null, knownAthletes);
        if (!okAthlete) {
          results.errors.push(`Row ${i + 1}: Unable to create or find athlete '${row.athlete_name}'.`);
          continue;
        }

        // Attach meet slug
        row.meet_slug = meetSlug;

        // Convert numeric fields (time, distance, place)
        if (row.time) {
          const parsed = parseTimeToSeconds(row.time);
          if (isNaN(parsed)) {
            results.errors.push(`Row ${i + 1}: Invalid time value: ${row.time}`);
            continue;
          }
          row.time = Math.round(parsed * 100) / 100;
          if (row.time > 36000) {
            results.errors.push(`Row ${i + 1}: Time seems unusually long (${row.time}s).`);
            continue;
          }
        }
        if (row.distance) {
          const d = parseFloat(row.distance);
          if (isNaN(d)) {
            results.errors.push(`Row ${i + 1}: Invalid distance value: ${row.distance}`);
            continue;
          }
          row.distance = d;
        }
        if (row.place) {
          const p = parseInt(row.place, 10);
          if (isNaN(p)) {
            results.errors.push(`Row ${i + 1}: Invalid place value: ${row.place}`);
            continue;
          }
          row.place = p;
        }
        if (row.gender) {
          const g = row.gender.toString().toUpperCase();
          if (!['M', 'F'].includes(g)) {
            results.errors.push(`Row ${i + 1}: Invalid gender value: ${row.gender}`);
            continue;
          }
          row.gender = g;
        }

        validRows.push(row);
      }

      if (validRows.length === 0) return results;

      const { error } = await supabase.from('results').insert(validRows);
      if (error) {
        results.errors.push(`Database error inserting results: ${error.message}`);
      } else {
        results.success = validRows.length;
      }
      return results;
    }

    function displayImportResults(result) {
      const statusDiv = document.getElementById('import-status');
      let html = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h4>Import Summary</h4>
          <p><strong>Total rows processed:</strong> ${result.total}</p>
          <p><strong>Successfully imported:</strong> ${result.success}</p>
          <p><strong>Errors:</strong> ${result.errors.length}</p>
        </div>
      `;
      if (result.errors.length > 0) {
        html += `
          <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
            <h4 style="color: #721c24; margin-top: 0;">Import Errors</h4>
            <ul style="color: #721c24; margin: 0;">
              ${result.errors.map(e => `<li>${e}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      statusDiv.innerHTML = html;
    }

    async function simpleImportCSV() {
      const meetSlug = document.getElementById('simple-meet-slug').value;
      const fileInput = document.getElementById('simple-csv-file');

      if (!meetSlug || !fileInput.files[0]) {
        showStatus('Enter a meet slug and choose a CSV file.', 'error');
        return;
      }

      try {
        showStatus('Importing CSV...', 'info');
        const file = fileInput.files[0];
        const csvText = await readFileAsText(file);

        const headers = ['athlete_name','school_slug','gender','time','distance','place'];
        const csvData = parseCSVStrict(csvText, headers);

        if (csvData.length === 0) {
          showStatus('No valid data found in CSV file.', 'error');
          return;
        }

        const importResult = await bulkInsertResults(meetSlug, csvData);
        displayImportResults(importResult);

        if (importResult.success > 0) {
          showStatus(`Successfully imported ${importResult.success} results for meet "${meetSlug}"!`, 'success');
          document.getElementById('simple-meet-slug').value = '';
          document.getElementById('simple-csv-file').value = '';
          loadResults();
        }
      } catch (error) {
        console.error('CSV import error:', error);
        showStatus(`Error importing CSV: ${error.message}`, 'error');
      }
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsText(file);
      });
    }

    function parseCSVStrict(csvText, headers) {
      const lines = csvText.trim().split('\n');
      if (lines.length === 0) return [];
      const headerRow = lines[0].trim();
      const fileHeaders = headerRow.split(',').map(h => h.trim());
      const expected = headers.join(',');
      if (fileHeaders.join(',') !== expected) {
        throw new Error(`CSV headers must be exactly: ${expected}`);
      }
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
        if (values.length !== headers.length) continue;
        const row = {};
        headers.forEach((h, idx) => { row[h] = values[idx] || null; });
        rows.push(row);
      }
      return rows;
    }

    function parseTimeToSeconds(timeStr) {
      if (!timeStr) return null;
      const str = timeStr.toString().trim();
      if (!isNaN(str) && !str.includes(':')) return parseFloat(str);
      if (str.includes(':')) {
        const parts = str.split(':');
        if (parts.length === 2) {
          const minutes = parseInt(parts[0]);
          const seconds = parseFloat(parts[1]);
          return (minutes * 60) + seconds;
        }
        if (parts.length === 3) {
          const hours = parseInt(parts[0]);
          const minutes = parseInt(parts[1]);
          const seconds = parseFloat(parts[2]);
          return (hours * 3600) + (minutes * 60) + seconds;
        }
      }
      return NaN;
    }
  </script>
</body>
</html>

