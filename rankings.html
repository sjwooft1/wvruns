<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rankings – Mountain State Miles</title>
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <style>
    table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    table thead {
      background: linear-gradient(135deg, #002855 0%, #004080 100%);
    }
    table th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      padding: 16px 12px;
    }
    table td {
      padding: 14px 12px;
      border-bottom: 1px solid #e5e7eb;
      color: #374151;
    }
    table tbody tr:hover {
      background: #f9fafb;
    }
    table tbody tr:last-child td {
      border-bottom: none;
    }
    table a {
      color: #0056b3;
      text-decoration: none;
      font-weight: 600;
    }
    table a:hover {
      text-decoration: underline;
    }
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 15px;
    }
    .table-wrapper table {
      min-width: 600px;
    }
    .distance-btn {
      padding: 10px 16px;
      border: 2px solid #002855;
      background: white;
      color: #002855;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    .distance-btn:hover {
      background: #f0f4f8;
    }
    .distance-btn.active {
      background: #002855;
      color: white;
    }
    @media (max-width: 768px) {
      section {
        padding: 20px;
        overflow-x: visible;
      }
      .table-wrapper {
        margin-left: -20px;
        margin-right: -20px;
        padding: 0 20px;
        width: calc(100% + 40px);
      }
      .table-wrapper table {
        min-width: 650px;
        font-size: 0.85rem;
      }
      table th {
        padding: 12px 8px;
        font-size: 0.75rem;
      }
      table td {
        padding: 10px 8px;
        font-size: 0.85rem;
      }
      section h2 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div class="page-background"></div>
    <div class="mountain-overlay-bg"></div>
    <img src="assets/rankings.jpg" alt="" class="page-background-image" />
    <header>
    <img src="assets/Wvruns Logo.png" alt="Mountain State Miles Logo" class="logo" />
    <nav>
        <a href="index.html">Home</a>
      <a href="schools.html">Schools</a>
      <a href="meets.html">Meets</a>
      <a href="rankings.html">Rankings</a>
      <a href="calendar.html">Calendar</a>
    </nav>
  </header>
  <main>
    <h1>Statewide Rankings</h1>
    <p>Fastest overall times recorded in the database.</p>
    <button onclick="document.getElementById('female-rankings').scrollIntoView({behavior:'smooth', block:'start'})"
    style="
    padding:10px 18px;
    background: rgba(23, 17, 71, 0.951);
    border:none;
    border-radius:8px;
    color:white;
    font-weight:600;
    cursor:pointer;
    margin-bottom:20px;
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
  ">
  Jump to Female Rankings
</button>

    <section class="filters-section">
      <h3>Filters</h3>
      
      <!-- Distance Filter Buttons -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #002855;">Distance:</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="distance-btn active" onclick="filterByDistance('all')">All Distances</button>
          <button class="distance-btn" onclick="filterByDistance(5000)">5K (5000m)</button>
          <button class="distance-btn" onclick="filterByDistance(3200)">3200m</button>
          <button class="distance-btn" onclick="filterByDistance(1600)">1600m</button>
        </div>
      </div>

      <div class="filters-grid">
        <div>
          <label for="search-athlete">Search Athlete</label>
          <input type="text" id="search-athlete" placeholder="Search by name..." class="input" />
        </div>
        <div>
          <label for="filter-grade">Grade</label>
          <select id="filter-grade" class="input">
            <option value="">All Grades</option>
            <option value="9">9th Grade</option>
            <option value="10">10th Grade</option>
            <option value="11">11th Grade</option>
            <option value="12">12th Grade</option>
          </select>
        </div>
        <div>
          <label for="filter-school">School</label>
          <select id="filter-school" class="input">
            <option value="">All Schools</option>
          </select>
        </div>
        <div>
          <label for="filter-time">Max Time (MM:SS)</label>
          <input type="text" id="filter-time" placeholder="e.g. 18:00" class="input" />
        </div>
      </div>
      <button id="clear-filters" class="button-clear">Clear Filters</button>
    </section>

    <section class="rankings-section">
      <h2>Male Leaderboard</h2>
      <div id="male-loading">Loading...</div>
      <div class="table-wrapper">
        <table id="male-table" style="display:none; width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>#</th>
              <th>Athlete</th>
              <th>Grade</th>
              <th>School</th>
              <th>Time</th>
              <th>Pace/Mile</th>
              <th>Meet</th>
            </tr>
          </thead>
          <tbody id="male-tbody"></tbody>
        </table>
      </div>
      <div id="male-empty" style="display:none;color:#888;">No male results found.</div>
    </section>

    <section class="rankings-section" id="female-rankings">
      <h2>Female Leaderboard</h2>
      <div id="female-loading">Loading...</div>
      <div class="table-wrapper">
        <table id="female-table" style="display:none; width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>#</th>
              <th>Athlete</th>
              <th>Grade</th>
              <th>School</th>
              <th>Time</th>
              <th>Pace/Mile</th>
              <th>Meet</th>
            </tr>
          </thead>
          <tbody id="female-tbody"></tbody>
        </table>
      </div>
      <div id="female-empty" style="display:none;color:#888;">No female results found.</div>
    </section>
    </main>
    <footer>
      <p>&copy; 2025 Mountain State Miles — Built by runners, for runners.</p>
      <a href="login.html"
         style="
           display:inline-block;
           margin-top:8px;
           background:#6cb5d967;
           padding:8px 14px;
           color:white;
           text-decoration:none;
           border-radius:6px;
           font-weight:bold;
         ">
         Admin Login
      </a>
    </footer>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script>
    // Format grade from graduation year
    function formatGrade(gradYear) {
      if (!gradYear) return 'N/A';
      const yearNum = parseInt(gradYear, 10);
      if (Number.isNaN(yearNum)) return 'N/A';
      const now = new Date();
      const month = now.getMonth();
      const currentYear = now.getFullYear();
      const academicEndYear = month >= 7 ? currentYear + 1 : currentYear;
      const gradeNum = 12 - (yearNum - academicEndYear);
      const numLabels = { 9: '9th', 10: '10th', 11: '11th', 12: '12th' };
      return numLabels[gradeNum] || 'N/A';
    }

    // Get athlete grade from athletes table
    const athleteGradeCache = {};
    async function getAthleteGrade(athleteName) {
      if (athleteGradeCache[athleteName]) return athleteGradeCache[athleteName];
      try {
        const { data } = await supabase
          .from('athletes')
          .select('grade')
          .ilike('name', athleteName)
          .limit(1)
          .single();
        if (data) {
          athleteGradeCache[athleteName] = data.grade;
          return data.grade;
        }
      } catch (e) {}
      return null;
    }

    function formatTime(val) {
      if (!val && val !== 0) return '';
      const sec = Number(val);
      if (Number.isNaN(sec)) return val;
      const minutes = Math.floor(sec / 60);
      const seconds = Math.floor(sec % 60);
      const ms = Math.round((sec - Math.floor(sec)) * 100);
      return `${minutes}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
    }
    // Calculate pace per mile based on actual distance
    function calculatePacePerMile(seconds, distanceMeters) {
      if (!seconds && seconds !== 0) return '';
      const sec = Number(seconds);
      if (Number.isNaN(sec) || sec <= 0) return '';
      
      // Use provided distance or default to 5000 meters
      const distance = distanceMeters ? Number(distanceMeters) : 5000;
      if (Number.isNaN(distance) || distance <= 0) return '';
      
      const DISTANCE_MILES = distance / 1609.34; // convert meters to miles
      const paceSecondsPerMile = sec / DISTANCE_MILES;
      const paceMinutes = Math.floor(paceSecondsPerMile / 60);
      const paceSeconds = Math.floor(paceSecondsPerMile % 60);
      return `${paceMinutes}:${paceSeconds.toString().padStart(2, '0')}`;
    }

    // Parse time string (MM:SS) to seconds
    function parseTimeString(timeStr) {
      if (!timeStr) return null;
      const parts = timeStr.split(':');
      if (parts.length === 2) {
        const minutes = parseInt(parts[0], 10);
        const seconds = parseInt(parts[1], 10);
        if (!Number.isNaN(minutes) && !Number.isNaN(seconds)) {
          return minutes * 60 + seconds;
        }
      }
      return null;
    }
    async function fetchMany(gender) {
      // Fetch a larger set, then refine client-side
      const { data, error } = await supabase
        .from('results')
        .select('*')
        .eq('gender', gender)
        .not('time', 'is', null)
        .limit(2000); // safety cap
      if (error) return [];
      return data || [];
    }
    // Store all data for filtering
    let allMaleRows = [];
    let allFemaleRows = [];
    let allSchools = [];

    async function loadSchools() {
      const { data } = await supabase.from('schools').select('slug, name').order('name');
      if (data) {
        allSchools = data;
        const schoolSelect = document.getElementById('filter-school');
        data.forEach(school => {
          const option = document.createElement('option');
          option.value = school.slug;
          option.textContent = school.name;
          schoolSelect.appendChild(option);
        });
      }
    }

    function bestPerAthlete(rows, topN = 50) {
      const valid = rows.filter(r => {
        const t = Number(r.time);
        return !Number.isNaN(t) && t > 0;
      });
      valid.sort((a,b) => Number(a.time) - Number(b.time));
      const seen = new Set();
      const best = [];
      for (const r of valid) {
        const key = (r.athlete_name || '').toLowerCase();
        if (!key) continue;
        if (seen.has(key)) continue;
        seen.add(key);
        best.push(r);
        if (best.length >= topN) break;
      }
      return best;
    }

    // Filter function
    function filterResults(results, filters) {
      let filtered = [...results];
      
      if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        filtered = filtered.filter(r => 
          (r.athlete_name || '').toLowerCase().includes(searchLower)
        );
      }

      if (filters.grade) {
        // Filter by grade - need to check athletes table
        filtered = filtered.filter(r => {
          // This will be async, so we'll handle it in the render function
          return true; // Will filter after getting grades
        });
      }

      if (filters.school) {
        filtered = filtered.filter(r => r.school_slug === filters.school);
      }

      if (filters.maxTime) {
        const maxSeconds = parseTimeString(filters.maxTime);
        if (maxSeconds) {
          filtered = filtered.filter(r => {
            const time = Number(r.time);
            return !Number.isNaN(time) && time <= maxSeconds;
          });
        }
      }

      return filtered;
    }

    async function renderRankings(gender, tbody, best, filters = {}) {
      // Get grades for all athletes
      const resultsWithGrades = await Promise.all(best.map(async (r) => {
        const grade = await getAthleteGrade(r.athlete_name);
        return { ...r, grade };
      }));

      // Apply grade filter if specified
      let filtered = resultsWithGrades;
      if (filters.grade) {
        const targetGrade = parseInt(filters.grade, 10);
        filtered = filtered.filter(r => {
          if (!r.grade) return false;
          const now = new Date();
          const month = now.getMonth();
          const currentYear = now.getFullYear();
          const academicEndYear = month >= 7 ? currentYear + 1 : currentYear;
          const gradeNum = 12 - (r.grade - academicEndYear);
          return gradeNum === targetGrade;
        });
      }

      // Apply other filters
      filtered = filterResults(filtered, filters);

      tbody.innerHTML = filtered.map((r, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td><a href="athlete.html?name=${encodeURIComponent(r.athlete_name)}" style="color: #0056b3; text-decoration: none; font-weight: 600;">${r.athlete_name || ''}</a></td>
          <td>${formatGrade(r.grade)}</td>
          <td>${r.school_slug || ''}</td>
          <td>${formatTime(r.time)}</td>
          <td>${calculatePacePerMile(r.time, r.distance)}</td>
          <td><a href="meet.html?slug=${r.meet_slug}" style="color: #0056b3; text-decoration: none;">${r.meet_slug || ''}</a></td>
        </tr>
      `).join('');
    }
    let maleBest = [];
    let femaleBest = [];

    async function loadRankings() {
      await loadSchools();
      
      // Male
      const maleLoading = document.getElementById('male-loading');
      const maleTable = document.getElementById('male-table');
      const maleTbody = document.getElementById('male-tbody');
      const maleEmpty = document.getElementById('male-empty');
      const maleRows = await fetchMany('M');
      allMaleRows = maleRows;
      maleBest = bestPerAthlete(maleRows, 200);
      if (!maleBest.length) {
        maleLoading.style.display = 'none';
        maleEmpty.style.display = '';
      } else {
        maleLoading.style.display = 'none';
        maleTable.style.display = '';
        // Show top 50 by default
        await renderRankings('M', maleTbody, maleBest.slice(0, 50));
      }
      
      // Female
      const femaleLoading = document.getElementById('female-loading');
      const femaleTable = document.getElementById('female-table');
      const femaleTbody = document.getElementById('female-tbody');
      const femaleEmpty = document.getElementById('female-empty');
      const femaleRows = await fetchMany('F');
      allFemaleRows = femaleRows;
      femaleBest = bestPerAthlete(femaleRows, 200);
      if (!femaleBest.length) {
        femaleLoading.style.display = 'none';
        femaleEmpty.style.display = '';
      } else {
        femaleLoading.style.display = 'none';
        femaleTable.style.display = '';
        // Show top 50 by default
        await renderRankings('F', femaleTbody, femaleBest.slice(0, 50));
      }
    }

    // Apply filters
    async function applyFilters() {
      const filters = {
        search: document.getElementById('search-athlete').value.trim(),
        grade: document.getElementById('filter-grade').value,
        school: document.getElementById('filter-school').value,
        maxTime: document.getElementById('filter-time').value.trim()
      };

      const maleTbody = document.getElementById('male-tbody');
      const femaleTbody = document.getElementById('female-tbody');

      // If searching or filtering, show all results; otherwise show top 50
      const hasActiveFilters = filters.search || filters.grade || filters.school || filters.maxTime;
      const maleData = hasActiveFilters ? maleBest : maleBest.slice(0, 50);
      const femaleData = hasActiveFilters ? femaleBest : femaleBest.slice(0, 50);

      if (maleBest.length > 0) {
        await renderRankings('M', maleTbody, maleData, filters);
      }
      if (femaleBest.length > 0) {
        await renderRankings('F', femaleTbody, femaleData, filters);
      }
    }

    // Event listeners
    document.getElementById('search-athlete').addEventListener('input', applyFilters);
    document.getElementById('filter-grade').addEventListener('change', applyFilters);
    document.getElementById('filter-school').addEventListener('change', applyFilters);
    document.getElementById('filter-time').addEventListener('input', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', () => {
      document.getElementById('search-athlete').value = '';
      document.getElementById('filter-grade').value = '';
      document.getElementById('filter-school').value = '';
      document.getElementById('filter-time').value = '';
      applyFilters();
    });

    document.addEventListener('DOMContentLoaded', loadRankings);

    // Distance filter state
    let currentDistanceFilter = 'all';

    // Filter by distance
    function filterByDistance(distance) {
      currentDistanceFilter = distance;
      
      // Update button states
      document.querySelectorAll('.distance-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Filter the best results by distance
      let maleBestFiltered = maleBest;
      let femaleBestFiltered = femaleBest;

      if (distance !== 'all') {
        const distanceNum = parseInt(distance, 10);
        maleBestFiltered = maleBest.filter(r => {
          const resultDistance = r.distance ? parseInt(r.distance, 10) : 5000;
          return resultDistance === distanceNum;
        });
        femaleBestFiltered = femaleBest.filter(r => {
          const resultDistance = r.distance ? parseInt(r.distance, 10) : 5000;
          return resultDistance === distanceNum;
        });
      }

      // Re-render with filtered data
      const maleTbody = document.getElementById('male-tbody');
      const femaleTbody = document.getElementById('female-tbody');
      
      if (maleBestFiltered.length > 0) {
        renderRankings('M', maleTbody, maleBestFiltered.slice(0, 50), {});
      } else {
        maleTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888; padding: 20px;">No results for this distance</td></tr>';
      }

      if (femaleBestFiltered.length > 0) {
        renderRankings('F', femaleTbody, femaleBestFiltered.slice(0, 50), {});
      } else {
        femaleTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888; padding: 20px;">No results for this distance</td></tr>';
      }
    }
  </script>
  </div>
</body>
</html>
