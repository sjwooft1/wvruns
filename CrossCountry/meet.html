<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meet Results | Mountain State Miles</title>
  
  <!-- Favicon Links -->
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  
  <!-- Link to the EXTERNAL stylesheet -->
  <link rel="stylesheet" href="style.css" />
  <!-- Removed Handsontable CSS link -->

  <meta name="description" content="WV running results, rankings, times, rosters, and meet data ‚Äî Mountain State Miles." />
  <meta name="keywords" content="WVXC, WV Track, West Virginia Running, Cross Country Results, WV HS Running, Mountain State Miles" />
  <meta name="author" content="Mountain State Miles" />

  <!-- URL Parameter Script in the Head -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("slug");
      if (slug) {
        document.title = `${slug.replace(/-/g, " ")} ‚Äì Meet Results | Mountain State Miles`;
      }
    });
  </script>
</head>

<body>
  <div class="content-wrapper">
    <div class="page-background"></div>
    <img src="assets/meets background.jpg" alt="" class="page-background-image" />
    
    <header>
      <nav class="navbar">
        <div class="container">
          <div class="navbar-content">
            <a href="xc.html" class="navbar-brand">üèîÔ∏è Cross Country</a>
            <ul class="navbar-nav">
              <li><a href="xc.html" class="navbar-link">Home</a></li>
              <li><a href="schools.html" class="navbar-link">Schools</a></li>
              <li><a href="meets.html" class="navbar-link active">Meets</a></li>
              <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
              <li><a href="analytics.html" class="navbar-link">Analytics</a></li>  
            </ul>
          </div>
        </div>
      </nav>
      <a href="meets.html" class="back-link">‚Üê Back to Meets</a>
    </header>

    <main>
      <h1 id="meet-title">Meet Results</h1>
      <div id="meet-meta" class="meet-metadata"></div>
      <div id="weather-widget" class="weather-widget" style="display:none;"></div>
      <div id="error" class="error-message" style="display:none;"></div>

      <div id="selector" style="display:none;">
        <div id="selector-card">
          <div class="tabs-row" role="tablist" aria-label="Gender tabs">
            <button id="tab-boys" class="gender-tab">BOYS</button>
            <button id="tab-girls" class="gender-tab">GIRLS</button>
          </div>
          <div id="select-heading">Select a Race</div>
          <div id="select-sub">Choose which race results you want to view for this meet.</div>
          <div id="race-button-wrap" class="race-buttons"></div>
        </div>
      </div>

      <!-- This div will now hold a standard HTML table created by JS -->
      <div id="results-box"></div>
    </main>

  <footer>
      <div class="row">
          <!-- 1st Column -->
          <div class="footer-col">
                <h4>General</h4>
                <ul>
                    <li><a href="/home/index.html">Home</a></li>
                    <li><a href="/home/admin.html">Admin</a></li>
                    <li><a href="/news.html">News</a></li>
                </ul>
            </div>

          <!-- 2nd Column -->
          <div class="footer-col">
              <h4>Cross Country</h4>
              <ul>
                  <li><a href="/CrossCountry/xc.html">Home</a></li>
                  <li><a href="/CrossCountry/meets.html">Meets</a></li>
                  <li><a href="/CrossCountry/schools.html">Schools</a></li>
                  <li><a href="/CrossCountry/rankings.html">Rankings</a></li>
                  <li><a href="/CrossCountry/analytics.html">Analytics</a></li>
              </ul>
          </div>

          <!-- 3rd Column -->
          <div class="footer-col">
              <h4>Track</h4>
              <ul>
                  <li><a href="/Track/index.html">Home</a></li>
                  <li><a href="/Track/meets.html">Meets</a></li>
                  <li><a href="/Track/teams.html">Teams</a></li>
                  <li><a href="/Track/rankings.html">Rankings</a></li>
                  <li><a href="/Track/analytics.html">Analytics</a></li>
              </ul>
          </div>
      </div>
      <hr>
      <div class="row">
          <div class="footer-bottom">
              <p>&#169; 2026 Mountain State Miles ‚Äî Built by runners, for runners.</p>
          </div>
      </div>
  </footer>

  <!-- Firebase SDK (Ensure HTTPS is added to fix loading errors) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="firebase-config.js"></script>
  <script src="firebase-helpers.js"></script>

  <script>
    // ==========================================
    // 1. UTILITY & FORMATTING FUNCTIONS
    // ==========================================

    /**
     * Converts time in seconds to MM:SS.ss format.
     */
    function formatTime(totalSeconds) {
      if (typeof totalSeconds !== 'number' || isNaN(totalSeconds) || totalSeconds <= 0) {
        return 'N/T';
      }
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${seconds.toFixed(2).padStart(5, '0')}`;
    }

    /**
     * Calculates Pace (MM:SS/mile).
     */
    function calculatePacePerMile(totalSeconds, distanceMeters) {
      if (!totalSeconds || !distanceMeters) return '-';
      const MILE_IN_METERS = 1609.34;
      const secondsPerMile = (totalSeconds / distanceMeters) * MILE_IN_METERS;
      return formatTime(secondsPerMile);
    }
    
    /**
     * Formats Graduation Year into Grade (Freshman, etc).
     * Based on current Fall 2025 season logic.
     */
    function formatGrade(gradYear) {
      if (!gradYear) return '';
      // Adjust this "currentYear" based on the active season
      const currentSeasonYear = 2025; // Base year on the current data (2025-11-16)
      const diff = gradYear - (currentSeasonYear + 1);
      
      const gradeMap = {
          0: '12', // Senior
          1: '11', // Junior
          2: '10', // Sophomore
          3: '9',  // Freshman
          4: '8',
          5: '7',
          6: '6'
      };
      return gradeMap[diff] || gradYear; 
    }

    /**
     * Converts a name (e.g., "Connor George") to a URL slug ("connor-george").
     * @param {string} name - The name to slugify.
     * @returns {string} The URL-friendly slug.
     */
    function slugify(name) {
        if (!name) return '';
        return name.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    // ==========================================
    // 2. STATE MANAGEMENT
    // ==========================================
    
    let currentMeetData = null;
    let allResults = [];
    let activeGender = 'M'; // Default to Boys ('M', 'F', 'O')
    let activeRaceType = null;

    // ==========================================
    // 3. MAIN INITIALIZATION
    // ==========================================

    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("slug");

      const errorDiv = document.getElementById("error");
      const metaDiv = document.getElementById("meet-meta");
      const selectorDiv = document.getElementById("selector");

      if (!slug) {
        errorDiv.style.display = "block";
        errorDiv.textContent = "No meet specified. Please return to the Meets page.";
        return;
      }

      try {
        // 1. Fetch Meet Details
        currentMeetData = await window.getMeetBySlug(slug);
        
        if (!currentMeetData) {
          throw new Error("Meet not found.");
        }

        // 2. Populate Header Info
        document.getElementById("meet-title").textContent = currentMeetData.name;
        metaDiv.innerHTML = `
            <strong>Date:</strong> ${currentMeetData.date || 'TBA'} <span style="margin:0 10px">|</span> 
            <strong>Location:</strong> ${currentMeetData.location || 'Unknown'}
        `;

        // 3. Load weather for the meet location if date is in the future
        if (currentMeetData.location && currentMeetData.date) {
          loadWeatherForMeet(currentMeetData.location, currentMeetData.date);
        }

        // 4. Fetch All Results for this Meet
        allResults = await window.getResultsByMeet(slug);
        
        if (!allResults || allResults.length === 0) {
            errorDiv.style.display = "block";
            errorDiv.textContent = "Results have not been uploaded for this meet yet.";
            return;
        }

        // 5. Initialize UI
        selectorDiv.style.display = "block";
        setupGenderTabs();
        
        // Trigger default view (Boys)
        document.getElementById("tab-boys").click();

      } catch (err) {
        console.error(err);
        errorDiv.style.display = "block";
        errorDiv.textContent = "Error loading meet data: " + err.message;
      }
    });

    // ==========================================
    // 3.5 WEATHER WIDGET FUNCTIONS
    // ==========================================

    /**
     * Map school names to their geographic coordinates for weather lookup
     */
    const schoolCoordinatesMap = {
      'grafton high school': { lat: 39.34, lon: -80.03 },
      'parkersburg high school': { lat: 39.27, lon: -81.56 },
      'parkersburg south high school': { lat: 39.27, lon: -81.56 },
      'morgantown high school': { lat: 39.64, lon: -79.96 },
      'bridgeport high school': { lat: 39.29, lon: -80.26 },
      'buckhannon sampson high school': { lat: 38.99, lon: -80.23 },
      'cabell midland high school': { lat: 38.54, lon: -82.45 },
      'capital high school': { lat: 38.35, lon: -81.64 },
      'george washington high school': { lat: 38.35, lon: -81.64 },
      'hedgesville high school': { lat: 39.18, lon: -78.05 },
      'huntington high school': { lat: 38.42, lon: -82.45 },
      'hurricane high school': { lat: 38.49, lon: -82.48 },
      'jefferson high school': { lat: 39.33, lon: -77.74 },
      'martinsburg high school': { lat: 39.47, lon: -77.97 },
      'musselman high school': { lat: 39.48, lon: -78.03 },
      'oak hill high school': { lat: 38.41, lon: -81.60 },
      'preston high school': { lat: 39.34, lon: -80.03 },
      'riverside high school': { lat: 38.46, lon: -81.75 },
      'spring mills high school': { lat: 39.47, lon: -77.97 },
      'spring valley high school': { lat: 38.42, lon: -82.45 },
      'st albans high school': { lat: 38.54, lon: -81.83 },
      'university high school': { lat: 39.64, lon: -79.96 },
      'washington high school': { lat: 38.35, lon: -81.64 },
      'wheeling park high school': { lat: 40.07, lon: -80.71 },
      'woodrow wilson high school': { lat: 37.78, lon: -81.19 }
    };

    /**
     * Get coordinates for a location (school or city)
     */
    function getCoordinatesForLocation(location) {
      if (!location) return null;
      
      const normalized = location.toLowerCase().trim();
      
      // Check if it's a school name
      if (schoolCoordinatesMap[normalized]) {
        console.log('‚úÖ Found coordinates in map for:', location);
        return schoolCoordinatesMap[normalized];
      }
      
      return null;
    }

    /**
     * Get weather for the meet location
     * Uses Open-Meteo API (free, no API key required)
     */
    async function loadWeatherForMeet(location, meetDate) {
      try {
        const weatherWidget = document.getElementById('weather-widget');
        console.log('üå§Ô∏è Weather loading for:', location, meetDate);
        
        // Get coordinates for the location
        const coordinates = getCoordinatesForLocation(location);
        
        if (!coordinates) {
          console.log('Could not find coordinates for location:', location);
          return;
        }

        console.log('üìç Found coordinates:', coordinates);

        // Determine which date to show weather for
        const meetDateObj = new Date(meetDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // If meet is today or in the past, show today's weather
        // If meet is in the future, show the meet day's forecast
        const weatherDate = meetDateObj <= today ? 'today' : meetDate;
        console.log('Weather date:', weatherDate, '(Meet date:', meetDate, ', Today:', today.toISOString().split('T')[0], ')');

        // Fetch weather data
        const weather = await fetchWeatherData(coordinates.lat, coordinates.lon, weatherDate);
        
        if (weather) {
          console.log('‚úÖ Weather data received:', weather);
          weatherWidget.style.display = 'block';
          renderWeatherWidget(weather, location, weather.isTodayWeather);
          
          // Update weather every 10 minutes
          setInterval(() => {
            fetchWeatherData(coordinates.lat, coordinates.lon, weatherDate).then(w => {
              if (w) renderWeatherWidget(w, location, w.isTodayWeather);
            });
          }, 600000); // 10 minutes
        } else {
          console.log('‚ùå No weather data received');
        }
      } catch (err) {
        console.error('Error loading weather:', err);
      }
    }

    /**
     * Fetch weather data from Open-Meteo API
     */
    async function fetchWeatherData(lat, lon, dateOrType) {
      try {
        console.log('üì° Fetching weather for:', dateOrType);
        
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_sum,wind_speed_10m_max&temperature_unit=fahrenheit&timezone=auto`
        );
        const data = await response.json();
        
        if (data.daily) {
          const dailyData = data.daily;
          console.log('Available dates:', dailyData.time.slice(0, 5));
          
          let weatherIndex = -1;
          let isTodayWeather = false;
          
          if (dateOrType === 'today') {
            // Use today's weather (first index)
            weatherIndex = 0;
            isTodayWeather = true;
            console.log('‚úÖ Using today\'s weather at index 0');
          } else {
            // Look for the specific meet date
            weatherIndex = dailyData.time.indexOf(dateOrType);
            if (weatherIndex !== -1) {
              console.log('‚úÖ Found meet date at index:', weatherIndex);
            } else {
              // If exact date not found, use today's weather
              console.log('‚ö†Ô∏è Meet date not found, using today\'s forecast');
              weatherIndex = 0;
              isTodayWeather = true;
            }
          }
          
          return {
            date: dateOrType === 'today' ? dailyData.time[0] : dateOrType,
            maxTemp: dailyData.temperature_2m_max[weatherIndex],
            minTemp: dailyData.temperature_2m_min[weatherIndex],
            weatherCode: dailyData.weather_code[weatherIndex],
            precipitation: dailyData.precipitation_sum[weatherIndex],
            windSpeed: dailyData.wind_speed_10m_max[weatherIndex],
            timezone: data.timezone,
            isTodayWeather: isTodayWeather
          };
        }
        console.log('‚ùå No daily data received');
        return null;
      } catch (err) {
        console.error('Weather fetch error:', err);
        return null;
      }
    }

    /**
     * Get weather icon and description from weather code
     */
    function getWeatherDetails(code) {
      const weatherMap = {
        0: { icon: '‚òÄÔ∏è', description: 'Clear' },
        1: { icon: 'üå§Ô∏è', description: 'Mostly Clear' },
        2: { icon: '‚õÖ', description: 'Partly Cloudy' },
        3: { icon: '‚òÅÔ∏è', description: 'Overcast' },
        45: { icon: 'üå´Ô∏è', description: 'Foggy' },
        48: { icon: 'üå´Ô∏è', description: 'Foggy' },
        51: { icon: 'üå¶Ô∏è', description: 'Light Drizzle' },
        53: { icon: 'üåßÔ∏è', description: 'Drizzle' },
        55: { icon: 'üåßÔ∏è', description: 'Heavy Drizzle' },
        61: { icon: 'üåßÔ∏è', description: 'Light Rain' },
        63: { icon: 'üåßÔ∏è', description: 'Rain' },
        65: { icon: '‚õàÔ∏è', description: 'Heavy Rain' },
        71: { icon: '‚ùÑÔ∏è', description: 'Light Snow' },
        73: { icon: '‚ùÑÔ∏è', description: 'Snow' },
        75: { icon: '‚ùÑÔ∏è', description: 'Heavy Snow' },
        77: { icon: '‚ùÑÔ∏è', description: 'Snow' },
        80: { icon: 'üåßÔ∏è', description: 'Light Showers' },
        81: { icon: '‚õàÔ∏è', description: 'Showers' },
        82: { icon: '‚õàÔ∏è', description: 'Heavy Showers' },
        85: { icon: 'üå®Ô∏è', description: 'Snow Showers' },
        86: { icon: 'üå®Ô∏è', description: 'Heavy Snow Showers' },
        95: { icon: '‚õàÔ∏è', description: 'Thunderstorm' },
        96: { icon: '‚õàÔ∏è', description: 'Hail Thunderstorm' },
        99: { icon: '‚õàÔ∏è', description: 'Hail Thunderstorm' }
      };
      
      return weatherMap[code] || { icon: '‚ùì', description: 'Unknown' };
    }

    /**
     * Render the weather widget
     */
    function renderWeatherWidget(weather, location, isTodayWeather) {
      const widget = document.getElementById('weather-widget');
      const { icon, description } = getWeatherDetails(weather.weatherCode);
      
      const maxTemp = Math.round(weather.maxTemp);
      const minTemp = Math.round(weather.minTemp);
      const windSpeed = Math.round(weather.windSpeed);
      const precipitation = Math.round(weather.precipitation * 100) / 100;
      
      const weatherLabel = isTodayWeather ? 'üìç Current Weather' : '‚õÖ Meet Day Forecast';
      
      widget.innerHTML = `
        <div class="weather-content">
          <div class="weather-icon">${icon}</div>
          <div class="weather-info">
            <div class="weather-label">${weatherLabel}</div>
            <div class="weather-location">üåç ${location}</div>
            <div class="weather-conditions">${description}</div>
            <div class="weather-temps">
              <span class="temp-high">${maxTemp}¬∞F</span>
              <span class="temp-divider">/</span>
              <span class="temp-low">${minTemp}¬∞F</span>
            </div>
            <div class="weather-details">
              <span class="detail-item">üí® ${windSpeed} mph</span>
              <span class="detail-item">üíß ${precipitation}"</span>
            </div>
            <div class="weather-timestamp">Updated: ${new Date().toLocaleTimeString()}</div>
          </div>
        </div>
      `;
    }

    // ==========================================
    // 4. UI LOGIC (TABS & BUTTONS)
    // ==========================================

    function setupGenderTabs() {
        const btnBoys = document.getElementById('tab-boys');
        const btnGirls = document.getElementById('tab-girls');

        // Helper to reset classes
        const resetTabs = () => {
            [btnBoys, btnGirls].forEach(b => b.classList.remove('active'));
        };

        btnBoys.addEventListener('click', () => {
            resetTabs();
            btnBoys.classList.add('active');
            activeGender = 'M';
            updateRaceButtons();
        });

        btnGirls.addEventListener('click', () => {
            resetTabs();
            btnGirls.classList.add('active');
            activeGender = 'F';
            updateRaceButtons();
        });

    }

    function updateRaceButtons() {
        const container = document.getElementById('race-button-wrap');
        container.innerHTML = ''; // Clear current buttons
        document.getElementById('results-box').innerHTML = ''; // Clear table

        // Filter results to find unique race types for current gender
        // Normalize gender to uppercase for comparison
        const relevantResults = allResults.filter(r => 
            (r.gender || '').toUpperCase() === activeGender
        );

        if (relevantResults.length === 0) {
            container.innerHTML = `<div style="color:#ccc; grid-column: 1/-1; text-align:center;">No results found for this category.</div>`;
            return;
        }

        // Get unique race types (e.g., "Varsity", "JV", "Middle School")
        const raceTypes = [...new Set(relevantResults.map(r => r.race_type))].sort();

        // Create a button for each race type
        raceTypes.forEach((type, index) => {
            const btn = document.createElement('button');
            btn.className = 'race-button secondary'; // Default style
            
            // Format label (capitalize first letter)
            const label = type ? type.charAt(0).toUpperCase() + type.slice(1) : 'Unlabeled Race';
            btn.textContent = label;

            btn.onclick = () => {
                // Remove primary class from all siblings
                Array.from(container.children).forEach(c => {
                    c.classList.remove('primary');
                    c.classList.add('secondary');
                });
                // Set this one to primary
                btn.classList.remove('secondary');
                btn.classList.add('primary');

                activeRaceType = type;
                renderTableForSelection();
            };

            container.appendChild(btn);

            // Automatically click the first button to show data immediately
            if (index === 0) btn.click();
        });
    }

    function renderTableForSelection() {
        // Filter data based on active Gender AND active Race Type
        const filteredData = allResults.filter(r => 
            (r.gender || '').toUpperCase() === activeGender && 
            r.race_type === activeRaceType
        );

        // Sort by Place (if available) or Time
        filteredData.sort((a, b) => {
            if (a.place && b.place) return a.place - b.place;
            // Use parseFloat here to ensure proper number comparison
            return parseFloat(a.time) - parseFloat(b.time); 
        });

        // Determine distance for pace calc (grab from first record)
        const distance = filteredData.length > 0 ? parseFloat(filteredData[0].distance) : 5000;

        // Calculate team scores
        const teamScores = calculateTeamScores(filteredData);

        renderResultsTable(filteredData, distance);
        renderTeamResults(teamScores);
        
        // Log any missing school data for debugging
        const missingSchools = filteredData.filter(r => !r.school_name && !r.school);
        if (missingSchools.length > 0) {
            console.warn(`‚ö†Ô∏è ${missingSchools.length} runners missing school data:`, missingSchools.map(r => r.athlete_name || r.name));
        }
    }

    /**
     * Get school name from result, trying multiple fields
     * @param {Object} runner - Runner result object
     * @returns {string} School name or "Unknown"
     */
    function getSchoolName(runner) {
        // Try multiple possible field names
        return runner.school_name || 
               runner.school || 
               runner.schoolName ||
               runner.schoolname ||
               runner.team ||
               runner.team_name ||
               'Unknown';
    }

    /**
     * Normalize school name to handle variations
     * e.g., "Parkersburg", "Parkersburg High School" -> "Parkersburg"
     */
    function normalizeSchoolName(schoolName) {
        if (!schoolName) return 'Unknown';
        
        // Convert to lowercase and trim
        let normalized = schoolName.toLowerCase().trim();
        
        // Remove common suffixes
        normalized = normalized
            .replace(/\s+(high\s+)?school\s*$/i, '')
            .replace(/\s+hs\s*$/i, '')
            .trim();
        
        // Capitalize first letter of each word
        return normalized.split(/\s+/).map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    /**
     * Calculate team scores from individual results
     * In cross country, lower score is better
     * Score = sum of top 5 finishers' places
     * Teams must have at least 5 runners to score
     * Tiebreaker: If two teams tie, use 6th and 7th runners' places
     */
    function calculateTeamScores(results) {
        const teamMap = {};
        
        // Group results by normalized school name
        results.forEach(result => {
            const rawSchool = result.school_name || result.school || 'Unknown';
            const school = normalizeSchoolName(rawSchool);
            if (!teamMap[school]) {
                teamMap[school] = [];
            }
            teamMap[school].push(result);
        });

        // Calculate scores for each team
        const scores = [];
        Object.entries(teamMap).forEach(([school, athletes]) => {
            // Sort athletes by place
            const sorted = athletes.sort((a, b) => {
                const placeA = parseInt(a.place) || 999;
                const placeB = parseInt(b.place) || 999;
                return placeA - placeB;
            });

            // Team must have at least 5 finishers to score
            if (sorted.length < 5) {
                console.log(`‚ö†Ô∏è Team "${school}" has only ${sorted.length} runners, skipping from team scores`);
                return; // Skip this team
            }

            // Calculate main score from top 5 finishers
            const topFive = sorted.slice(0, 5);
            const score = topFive.reduce((sum, athlete) => {
                return sum + (parseInt(athlete.place) || 999);
            }, 0);

            // Get 6th and 7th runners for tiebreaker (if available)
            const sixthRunner = sorted[5] ? parseInt(sorted[5].place) || 999 : 999;
            const seventhRunner = sorted[6] ? parseInt(sorted[6].place) || 999 : 999;

            scores.push({
                school,
                score,
                sixthPlace: sixthRunner,
                seventhPlace: seventhRunner,
                athletes: topFive,
                finishersCount: topFive.length,
                totalAthletes: sorted.length,
                allAthletes: sorted // Include all for reference
            });
            
            console.log(`‚úÖ Team "${school}" - Score: ${score}, Runners: ${sorted.length}`);
        });

        // Sort by score (ascending - lower is better)
        // Tiebreaker: if scores are equal, compare 6th runner, then 7th runner
        const sortedScores = scores.sort((a, b) => {
            if (a.score !== b.score) {
                return a.score - b.score;
            }
            // First tiebreaker: 6th runner
            if (a.sixthPlace !== b.sixthPlace) {
                return a.sixthPlace - b.sixthPlace;
            }
            // Second tiebreaker: 7th runner
            return a.seventhPlace - b.seventhPlace;
        });
        
        console.log(`üìä Total teams with 5+ runners: ${sortedScores.length}`);
        return sortedScores;
    }

    /**
     * Render team results table
     */
    function renderTeamResults(teamScores) {
        const resultsBox = document.getElementById('results-box');
        
        if (!teamScores || teamScores.length === 0) {
            return;
        }

        const teamHTML = `
            <section class="results-table-container">
                <h3 style="color: #002855; margin-bottom: 20px; font-size: 1.3rem;">üèÜ Team Scores</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Place</th>
                            <th>School</th>
                            <th>Team Score</th>
                            <th>Top 5 Finishers</th>
                            <th style="font-size: 0.85rem;">Tiebreaker<br/>(6th, 7th)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${teamScores.map((team, index) => {
                            const tiebreaker = team.sixthPlace !== 999 || team.seventhPlace !== 999
                                ? `${team.sixthPlace !== 999 ? team.sixthPlace : '-'}, ${team.seventhPlace !== 999 ? team.seventhPlace : '-'}`
                                : '‚Äî';
                            
                            return `
                            <tr>
                                <td data-label="Place" style="font-weight: 700;">${index + 1}</td>
                                <td data-label="School" style="font-weight: 600;">${team.school}</td>
                                <td data-label="Team Score" style="font-weight: 700; color: #0056b3; font-size: 1.1rem;">${team.score}</td>
                                <td data-label="Top 5 Finishers">
                                    ${team.athletes.map(a => `
                                        <div style="font-size: 0.9rem; padding: 4px 0;">
                                            <strong>#${a.place}</strong> ${a.athlete_name || a.name || 'Unknown'}
                                        </div>
                                    `).join('')}
                                </td>
                                <td data-label="Tiebreaker" style="font-size: 0.9rem; text-align: center; color: #666;">${tiebreaker}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </section>
        `;

        // Prepend team results to the results box (so it shows at the top)
        resultsBox.innerHTML = teamHTML + resultsBox.innerHTML;
    }

    // ==========================================
    // 5. TABLE RENDERING (UPDATED FOR ATHLETE LINK)
    // ==========================================

    function renderResultsTable(results, distanceMeters) {
        const resultsBox = document.getElementById('results-box');
        
        if (!results || results.length === 0) {
            resultsBox.innerHTML = '<section><p>No results found.</p></section>';
            return;
        }

        const tableHTML = `
            <section class="results-table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Place</th>
                            <th>Name</th>
                            <th>Grade</th>
                            <th>School</th>
                            <th>Time</th>
                            <th>Pace/Mile</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(runner => {
                            // FIX: Force 'runner.time' to be a float number and handle null/undefined
                            const timeSeconds = runner.time ? parseFloat(runner.time) : 0; 

                            // Create the URL slug from the runner's name
                            const athleteSlug = slugify(runner.athlete_name || runner.name);
                            
                            // Create the URL slug from the school name
                            const rawSchool = runner.school_name || runner.school || 'Unknown';
                            const schoolSlug = slugify(normalizeSchoolName(rawSchool));

                            return `
                            <tr>
                                <td data-label="Place">${runner.place || '-'}</td>
                                <td data-label="Name">
                                    <!-- Use athleteSlug for the link as intended -->
                                    <a href="athlete.html?slug=${athleteSlug}" style="font-weight:bold; color:#002855;">
                                        ${runner.athlete_name || runner.name || 'Unknown'}
                                    </a>
                                </td>
                                <td data-label="Grade">${formatGrade(runner.gradYear)}</td>
                                <td data-label="School">
                                    <a href="schools.html?slug=${schoolSlug}">
                                        ${rawSchool}
                                    </a>
                                </td>
                                <td data-label="Time" style="font-weight:700;">${formatTime(timeSeconds)}</td>
                                <td data-label="Pace/Mile" style="color:#666;">${calculatePacePerMile(timeSeconds, distanceMeters)}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            </section>
        `;
        resultsBox.innerHTML = tableHTML;
    }
  </script>
</body>
</html>
