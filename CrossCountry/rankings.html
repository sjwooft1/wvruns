<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rankings ‚Äì Mountain State Miles</title>
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Styling for the table container */
    .results-box {
      margin-top: 1.5rem;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    /* New style for all filter buttons */
    .filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background-color: #f3f4f6; /* Light gray default */
        color: #4b5563;
        font-weight: 500;
        transition: all 0.2s;
        white-space: nowrap; /* Prevent wrapping */
    }

    .filter-btn:hover {
        background-color: #e5e7eb;
    }

    .filter-btn.active {
        background-color: var(--xc-primary);
        color: white;
        box-shadow: 0 0 8px rgba(0, 40, 85, 0.3); /* Subtle blue shadow */
    }
    
    /* Responsive filter layout adjustments */
    #filter-control-panel .filter-group {
        display: flex;
        gap: 0.5rem; /* Consistent spacing */
        flex-wrap: wrap; /* Allow wrapping on small screens */
        justify-content: center;
    }

    /* Target all select elements within the control panel */
    #filter-control-panel select {
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        background-color: white;
        color: #4b5563;
        font-weight: 500;
        cursor: pointer;
        min-width: 100px; /* Ensure dropdowns have minimum size */
    }

    /* Small screen adjustments */
    @media (max-width: 768px) {
        #filter-control-panel > div {
            flex-direction: column;
            align-items: stretch;
        }
        #filter-control-panel .filter-group {
            justify-content: space-around;
        }
        .filter-btn {
            flex-grow: 1;
        }
        #filter-control-panel select {
            flex-grow: 1;
            min-width: unset;
        }
    }
  </style>
</head>
<body>
  <div class="page-background"></div>
    <img src="assets/rankings.jpg" alt="" class="page-background-image" />
  <!-- Header/Navigation Placeholder -->
  <header>
    <!-- Logo image for desktop/large view -->
    <img src="assets/Wvruns Logo.png" alt="Mountain State Miles Logo" class="logo" />
    
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="container">
        <div class="navbar-content">
          <!-- Text/Emoji logo for the navbar -->
          <a href="xc.html" class="navbar-brand">üèîÔ∏è Cross Country</a>
          <ul class="navbar-nav">
            <li><a href="xc.html" class="navbar-link">Home</a></li>
            <li><a href="schools.html" class="navbar-link">Schools</a></li>
            <li><a href="meets.html" class="navbar-link">Meets</a></li>
            <li><a href="rankings.html" class="navbar-link active">Rankings</a></li>
            <li><a href="analytics.html" class="navbar-link">Analytics</a></li>
            
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="container py-8">
    <section class="hero-content text-center">
        <h1 class="text-4xl font-bold mb-2 text-gray-800">State Rankings</h1>
        <p class="text-xl text-gray-600">The fastest 50 times across Cross Country running in West Virginia.</p>
    </section>

    <!-- Filter Control Panel (Gender, Distance, Meet) -->
    <section id="filter-control-panel" class="p-4 bg-white rounded-xl shadow-lg mb-8">
      <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0 items-center justify-center">

        <!-- 1. Gender Filter (Required: Male/Female toggle) -->
        <div class="filter-group">
          <button class="filter-btn active" data-filter-type="gender" data-value="M" onclick="setFilter('gender', 'M', event)">Male</button>
          <button class="filter-btn" data-filter-type="gender" data-value="F" onclick="setFilter('gender', 'F', event)">Female</button>
        </div>

        <!-- 2. Distance Filter -->
        <div class="filter-group">
          <select id="distance-filter" onchange="setFilter('distance', this.value)">
            <option value="all">All Distances</option>
            <option value="5000">5K (5000m)</option>
            <option value="3200">3200m</option>
            <option value="3000">3K (3000m)</option>
            <option value="1600">1 Mile (1600m)</option>
            <option value="2000">2000m</option>
          </select>
        </div>

        <!-- 3. Meet Filter -->
        <div class="filter-group">
            <select id="meet-filter" onchange="setFilter('meet', this.value)" class="p-2 border rounded-lg shadow-sm text-gray-700 focus:ring-xc-primary focus:border-xc-primary cursor-pointer">
                <option value="all">All Meets</option>
                <!-- Options populated by JS -->
            </select>
        </div>

        <!-- 4. Course Filter -->
        <div class="filter-group">
            <select id="course-filter" onchange="setFilter('course', this.value)" class="p-2 border rounded-lg shadow-sm text-gray-700 focus:ring-xc-primary focus:border-xc-primary cursor-pointer">
                <option value="all">All Courses</option>
                <!-- Options populated by JS -->
            </select>
        </div>

      </div>
    </section>

    <!-- Male Rankings Container (Initially Visible/Hidden based on default filter) -->
    <section id="male-rankings" class="my-10">
      <h2 class="text-3xl font-semibold mb-6 text-xc-primary border-b-2 border-xc-primary pb-2">Male Rankings</h2>
      <div id="male-results-box" class="results-box">
        <div class="loading-state text-center p-8 text-gray-500">Loading male rankings...</div>
      </div>
    </section>

    <!-- Female Rankings Container (Initially Hidden) -->
    <section id="female-rankings" class="my-10 hidden">
      <h2 class="text-3xl font-semibold mb-6 text-xc-primary border-b-2 border-xc-primary pb-2">Female Rankings</h2>
      <div id="female-results-box" class="results-box">
        <div class="loading-state text-center p-8 text-gray-500">Loading female rankings...</div>
      </div>
    </section>

    <!-- No Data Message (Only visible if the selected combination yields no results) -->
    <section id="no-rankings-message" class="text-center my-10 hidden">
        <p class="text-xl text-red-500">No results found for the selected filters.</p>
    </section>

  </main>

  <!-- Footer Placeholder -->
  <footer>
    <p>&copy; 2026 Mountain State Miles ‚Äî Built by runners, for runners.</p>
    <a href="login.html" class="btn btn-secondary">Admin Login</a>
  </footer>

  <!-- Firebase Setup and Helpers -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-helpers.js"></script>
  <script src="email-signup.js"></script>

  <script>
    // Global variables
    let allResults = []; // The raw data store (all records)
    let schoolsMap = {}; // slug -> name
    let meetsMap = {}; // slug -> name
    let maleResults = []; // Full list of ALL male times (for sorting/filtering)
    let femaleResults = []; // Full list of ALL female times (for sorting/filtering)

    // State variables for filtering
    let currentGender = 'M'; // Default to Male
    let currentDistance = 'all'; 
    // currentYear and currentGrade removed
    let currentMeetSlug = 'all'; 
    let currentCourseSlug = 'all';
    let coursesMap = {}; // slug -> name
    
    // =========================================
    // HELPER FUNCTIONS (Formatting)
    // =========================================

    /**
     * Converts a time string (MM:SS.ms, H:MM:SS.ms, or "seconds") into total seconds (number).
     * @param {string|number} timeString Time string (e.g., "18:30.45", "976") or number.
     * @returns {number|null} Total seconds as a number, or null if invalid.
     */
    function formatTimeInSeconds(timeString) {
        if (typeof timeString === 'number' && !isNaN(timeString)) return timeString;
        if (!timeString || typeof timeString !== 'string') return null;

        if (timeString.includes(':')) {
            const parts = timeString.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 3) { // H:MM:SS.ms
                seconds += parts[0] * 3600;
                seconds += parts[1] * 60;
                seconds += parts[2];
            } else if (parts.length === 2) { // MM:SS.ms
                seconds += parts[0] * 60;
                seconds += parts[1];
            }
            return seconds > 0 ? seconds : null;
        } else {
            // If it's a number string (like "976"), parse it directly
            const numSeconds = parseFloat(timeString);
            return !isNaN(numSeconds) && numSeconds > 0 ? numSeconds : null;
        }
    }

    /**
     * Converts seconds (number) to HH:MM:SS.ms string.
     * @param {number|object} timeSeconds Input time in seconds or result object with time_in_seconds property.
     * @returns {string} Formatted time string (e.g., "18:30.45" or "1:10:05.00").
     */
    function formatTime(timeInput) {
        const time = timeInput.time_in_seconds !== undefined ? timeInput.time_in_seconds : formatTimeInSeconds(timeInput);

        if (typeof time !== 'number' || isNaN(time) || time <= 0) return '';

        const totalSeconds = time;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const secondsPart = seconds.toFixed(2);

        let timeStr = `${minutes}:${secondsPart.padStart(5, '0')}`;

        if (minutes >= 60) {
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            timeStr = `${hours}:${String(remainingMinutes).padStart(2, '0')}:${secondsPart.padStart(5, '0')}`;
        }

        return timeStr;
    }

    /**
     * Calculates pace per mile.
     * @param {number} totalSeconds Total time in seconds.
     * @param {number} distanceMeters Distance in meters.
     * @returns {string} Pace per mile in MM:SS format.
     */
    function calculatePacePerMile(totalSeconds, distanceMeters = 5000) {
        if (!totalSeconds || totalSeconds <= 0 || !distanceMeters || distanceMeters <= 0) return '';
        const metersPerMile = 1609.34;
        const paceSeconds = (totalSeconds / distanceMeters) * metersPerMile;

        const minutes = Math.floor(paceSeconds / 60);
        const seconds = Math.round(paceSeconds % 60);

        return `${minutes}:${String(seconds).padStart(2, '0')}`;
    }

    /**
     * Formats the graduation year into a typical high school grade level string ('Fr', 'So', 'Jr', 'Sr').
     * The calculation adjusts for the current academic season (starting in August).
     * @param {number|string} gradYear The year the athlete graduates (e.g., 2026).
     * @returns {string} Grade level (e.g., 'Sr', 'Jr', 'So', 'Fr', or '').
     */
    function formatGrade(gradYear) {
        if (!gradYear) return '';
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth(); // 0-11 (January is 0)
        const grad = parseInt(gradYear, 10);

        // Determine the academic year based on the current date.
        // If it's August (7) or later (the start of the new academic year), 
        // the grade calculation uses the *next* calendar year.
        const academicYearStart = currentMonth >= 7 ? currentYear + 1 : currentYear;

        // Years until graduation from the start of the current academic year 
        const yearsUntilGraduation = grad - academicYearStart;

        // Mapping:
        // Grad Year - Academic Year Start = Years Until Graduation (YUG)
        // YUG = 0: Senior (e.g., 2026 - 2026)
        // YUG = 1: Junior (e.g., 2027 - 2026)
        // YUG = 2: Sophomore (e.g., 2028 - 2026)
        // YUG = 3: Freshman (e.g., 2029 - 2026)
        
        if (yearsUntilGraduation === 0) return 'Sr'; 
        if (yearsUntilGraduation === 1) return 'Jr'; 
        if (yearsUntilGraduation === 2) return 'So'; 
        if (yearsUntilGraduation === 3) return 'Fr'; 
        
        return ''; // Default or if graduated
    }


    // =========================================
    // TABLE RENDERING FUNCTION
    // =========================================

    /**
     * Renders results data into a standard responsive HTML table.
     */
    function renderRankings(gender, containerId, results) {
        const resultsBox = document.getElementById(containerId);
        if (!resultsBox) return;

        if (results.length === 0) {
            resultsBox.innerHTML = `<p class="text-center p-8 text-gray-500">No rankings available for the selected filters.</p>`;
            return;
        }

        // The distance is guaranteed to be the same for all results in a filtered set (or 5000 if 'all' distance filter is selected)
        // If the distance filter is 'all', use the distance of the top result, otherwise use 5000 as a default.
        const distanceMeters = currentDistance !== 'all' ? parseInt(currentDistance, 10) : (results[0]?.distance ? parseInt(results[0].distance, 10) : 5000);

        // Generate HTML Table structure
        const tableHTML = `
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Athlete Name</th>
                        <th>Grade</th>
                        <th>School</th>
                        <th>Meet (Year)</th>
                        <th>Time</th>
                        <th>Pace/Mile</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.map((runner, index) => {
                        const timeInSeconds = runner.time_in_seconds; 
                        const resultYear = runner.date ? new Date(runner.date).getFullYear() : 'N/A';
                        return `
                            <tr>
                                <td data-label="Rank">${index + 1}</td>
                                <td data-label="Athlete">
                                    <!-- Link uses athlete_name, URL encoded for safety -->
                                    <a href="athlete.html?name=${encodeURIComponent(runner.athlete_name || runner.id)}" style="color: var(--xc-primary); text-decoration: none; font-weight: 600;">${runner.athlete_name || ''}</a>
                                </td>
                                <td data-label="Grade">${formatGrade(runner.grad_year) || ''}</td>
                                <td data-label="School">${runner.school_name || runner.school_slug || ''}</td>
                                <td data-label="Meet">
                                    <a href="meet.html?slug=${runner.meet_slug}" style="color: var(--xc-primary); text-decoration: none;">${runner.meet_name || runner.meet_slug || ''}</a> 
                                    (${resultYear})
                                </td>
                                <td data-label="Time">${formatTime(runner.time) || ''}</td>
                                <td data-label="Pace/Mile">${calculatePacePerMile(timeInSeconds, distanceMeters) || ''}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        resultsBox.innerHTML = tableHTML;
    }

    // =========================================
    // FILTER SETTERS AND POPULATORS
    // =========================================
    
    /**
     * Generalized function to set a filter state and update UI buttons.
     */
    function setFilter(type, value, event = null) {
        // 1. Update internal state
        if (type === 'gender') currentGender = value;
        if (type === 'distance') currentDistance = value;
        // currentYear and currentGrade handlers removed
        if (type === 'meet') currentMeetSlug = value;
        if (type === 'course') currentCourseSlug = value;

        // 2. Update button active/inactive states (only for buttons)
        if (event && event.target.tagName === 'BUTTON') {
            document.querySelectorAll(`.filter-btn[data-filter-type="${type}"]`).forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 3. Trigger re-render
        filterAndRender();
    }
    
    /**
     * Finds unique meets and courses in the data and populates the dropdowns.
     */
    function populateFilters() {
        // --- Populate Meet Filter ---
        // meetsMap is populated in loadInitialData
        const meetSelect = document.getElementById('meet-filter');
        meetSelect.innerHTML = '<option value="all">All Meets</option>';
        
        // Convert map to array and sort by meet name
        const sortedMeets = Object.keys(meetsMap).map(slug => ({
            slug: slug,
            name: meetsMap[slug]
        })).sort((a, b) => a.name.localeCompare(b.name));

        sortedMeets.forEach(meet => {
            const option = document.createElement('option');
            option.value = meet.slug;
            option.textContent = meet.name;
            meetSelect.appendChild(option);
        });

        // --- Populate Course Filter ---
        const courseSelect = document.getElementById('course-filter');
        courseSelect.innerHTML = '<option value="all">All Courses</option>';
        
        // Convert map to array and sort by course name
        const sortedCourses = Object.keys(coursesMap).map(slug => ({
            slug: slug,
            name: coursesMap[slug]
        })).sort((a, b) => a.name.localeCompare(b.name));

        sortedCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.slug;
            option.textContent = course.name;
            courseSelect.appendChild(option);
        });
    }

    // =========================================
    // DATA FETCHING & FILTERING
    // =========================================

    /**
     * Loads schools and meets data before loading results.
     */
    async function loadInitialData() {
      try {
        // 1. Load Schools
        const schools = await getAllSchools(); 
        schools.forEach(school => {
          schoolsMap[school.slug] = school.name;
        });
        
        // 2. Load Meets
        const meets = await getMeets(); 
        meets.forEach(meet => {
          meetsMap[meet.slug] = meet.name;
        });

        // 3. Load Courses
        try {
          const coursesSnapshot = await firebaseDatabase.ref('crosscountry/courses').once('value');
          const coursesArray = snapshotToArray(coursesSnapshot);
          coursesArray.forEach(course => {
            coursesMap[course.slug] = course.name;
          });
        } catch (e) {
          console.warn("Courses not available:", e);
        }

        await loadRankingsData();
      } catch (error) {
        console.error("Error loading initial data (schools/meets/courses):", error);
      }
    }

    async function loadRankingsData() {
      try {
        // Load raw results
        const snapshot = await firebaseDatabase.ref('crosscountry/results').once('value');
        const allResultsArray = snapshotToArray(snapshot); 

        // Clear previous data
        allResults = [];
        maleResults = [];
        femaleResults = [];

        if (allResultsArray.length === 0) {
             console.warn("No results found at 'crosscountry/results'. Stopping ranking calculation.");
             document.getElementById('male-results-box').innerHTML = `<p class="text-center p-8 text-red-500">No results found in the database.</p>`;
             document.getElementById('female-results-box').innerHTML = `<p class="text-center p-8 text-red-500">No results found in the database.</p>`;
             return;
        }

        // Process and categorize results
        allResultsArray.forEach(result => {
            const timeInSeconds = formatTimeInSeconds(result.time);
            
            if (!result.gender || timeInSeconds === null) return;

            const resultWithExtras = {
                ...result,
                time_in_seconds: timeInSeconds,
                school_name: schoolsMap[result.school_slug] || result.school_slug,
                meet_name: meetsMap[result.meet_slug] || result.meet_slug,
                // Add the calculated grade string to the object for filtering
                grade_string: formatGrade(result.grad_year) 
            };
            
            allResults.push(resultWithExtras); // Store a copy of all results

            if (result.gender === 'M') {
                maleResults.push(resultWithExtras);
            } else if (result.gender === 'F') {
                femaleResults.push(resultWithExtras);
            }
        });

        // Populate all filter dropdowns
        populateFilters();

        // Sort the full lists by time_in_seconds (fastest first). 
        maleResults.sort((a, b) => a.time_in_seconds - b.time_in_seconds);
        femaleResults.sort((a, b) => a.time_in_seconds - b.time_in_seconds);

        // Initial render: Male, All Distances, All Meets
        filterAndRender();

      } catch (error) {
        console.error("Critical Error loading and processing raw results for rankings:", error);
        document.getElementById('male-results-box').innerHTML = `<p class="text-center p-8 text-red-500">Failed to load and process rankings data: ${error.message}</p>`;
        document.getElementById('female-results-box').innerHTML = `<p class="text-center p-8 text-red-500">Failed to load and process rankings data: ${error.message}</p>`;
      }
    }

    /**
     * Central function that filters data based on current filters and renders the visible table.
     */
    function filterAndRender() {
        const isMale = currentGender === 'M';
        const rawResults = isMale ? maleResults : femaleResults;
        const targetSectionId = isMale ? 'male-rankings' : 'female-rankings';
        const targetBoxId = isMale ? 'male-results-box' : 'female-results-box';
        
        // 1. Manage visibility
        document.getElementById(isMale ? 'female-rankings' : 'male-rankings').classList.add('hidden');
        document.getElementById(targetSectionId).classList.remove('hidden');
        document.getElementById('no-rankings-message').classList.add('hidden');

        // 2. Start Filtering the selected gender's full list
        let filteredResults = rawResults;

        // Filter A: Distance
        if (currentDistance !== 'all') {
            const distanceNum = parseInt(currentDistance, 10);
            filteredResults = filteredResults.filter(r => {
                const resultDistance = r.distance ? parseInt(r.distance, 10) : 0; 
                return resultDistance === distanceNum;
            });
        }
        
        // Filter B: Meet Slug
        if (currentMeetSlug !== 'all') {
            filteredResults = filteredResults.filter(r => {
                return r.meet_slug === currentMeetSlug;
            });
        }
        
        // Filter C: Course Slug (filter by the course associated with the meet)
        if (currentCourseSlug !== 'all') {
            filteredResults = filteredResults.filter(r => {
                return r.course_slug === currentCourseSlug;
            });
        }
        
        // 3. Render the top 50 results
        if (filteredResults.length > 0) {
            // Note: Since rawResults is already sorted, the filtered list is also sorted.
            renderRankings(currentGender, targetBoxId, filteredResults.slice(0, 50));
        } else {
            // Display 'No data' message in the specific box
            document.getElementById(targetBoxId).innerHTML = `<p class="text-center p-8 text-gray-500">No rankings found for the selected filters.</p>`;
        }
    }

    // Initialize on page load
    window.onload = loadInitialData; 
  </script>
</body>
</html>