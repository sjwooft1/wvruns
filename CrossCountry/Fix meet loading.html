<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meet Results | Mountain State Miles</title>

  <link rel="stylesheet" href="style.css" />

  <!-- Correct Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script src="firebase-config.js"></script>
  <script src="firebase-helpers.js"></script>
</head>

<body>
  <div class="content-wrapper">
    <div class="page-background"></div>
    <img src="assets/meets background.jpg" class="page-background-image"/>

    <header>
      <nav class="navbar">
        <div class="container">
          <div class="navbar-content">
            <a href="xc.html" class="navbar-brand">üèîÔ∏è Cross Country</a>
            <ul class="navbar-nav">
              <li><a href="xc.html" class="navbar-link">Home</a></li>
              <li><a href="schools.html" class="navbar-link">Schools</a></li>
              <li><a href="meets.html" class="navbar-link active">Meets</a></li>
              <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
              <li><a href="calendar.html" class="navbar-link">Calendar</a></li>
            </ul>
          </div>
        </div>
      </nav>
      <a href="meets.html" class="back-link">‚Üê Back to Meets</a>
    </header>

    <main>
      <h1 id="meet-title">Meet Results</h1>
      <div id="meet-meta" class="meet-metadata"></div>
      <div id="error" class="error-message" style="display:none;"></div>

      <div id="selector" style="display:none;">
        <div id="selector-card">
          <div class="tabs-row">
            <button id="tab-boys" class="gender-tab">BOYS</button>
            <button id="tab-girls" class="gender-tab">GIRLS</button>
          </div>
          <div id="select-heading">Select a Race</div>
          <div id="select-sub">Choose which race results you want to view.</div>
          <div id="race-button-wrap" class="race-buttons"></div>
        </div>
      </div>

      <div id="results-box"></div>
    </main>
  </div>

  <footer>
    <p>&copy; 2025 Mountain State Miles ‚Äî Built by runners, for runners.</p>
    <a href="login.html" class="btn">Admin Login</a>
  </footer>

  <script>
    function formatTime(seconds) {
      if (!seconds) return "";
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60).toString().padStart(2, "0");
      const ms = Math.round((seconds - Math.floor(seconds)) * 100)
        .toString()
        .padStart(2, "0");
      return `${m}:${s}.${ms}`;
    }
  
    function calculatePacePerMile(seconds, distance) {
      if (!seconds) return "";
      const miles = distance / 1609.34;
      const p = seconds / miles;
      return `${Math.floor(p / 60)}:${Math.floor(p % 60)
        .toString()
        .padStart(2, "0")}`;
    }
  
    function renderResultsTable(results, distance) {
      const box = document.getElementById("results-box");
      box.innerHTML = "";
  
      if (!results || results.length === 0) {
        box.innerHTML = "<section><p>No results found.</p></section>";
        return;
      }
  
      box.innerHTML = `
        <section class="results-table-container">
          <table class="results-table">
            <thead>
              <tr>
                <th>Place</th>
                <th>Name</th>
                <th>School</th>
                <th>Time</th>
                <th>Pace/Mile</th>
              </tr>
            </thead>
            <tbody>
              ${results
                .map(
                  r => `
                <tr>
                  <td>${r.place || ""}</td>
                  <td>${r.athlete_name || r.name || ""}</td>
                  <td>${r.school_name || r.school || r.school_slug || ""}</td>
                  <td>${formatTime(r.time)}</td>
                  <td>${calculatePacePerMile(r.time, distance)}</td>
                </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </section>
      `;
    }
  
    async function loadMeet() {
      const params = new URLSearchParams(location.search);
      const slug = params.get("slug");
      if (!slug) return;
  
      // Load meet
      const meetSnap = await firebaseDatabase
        .ref("crosscountry/meets")
        .orderByChild("slug")
        .equalTo(slug)
        .once("value");
  
      let meet = null;
      meetSnap.forEach(s => (meet = s.val()));
  
      if (!meet) {
        document.getElementById("error").style.display = "block";
        document.getElementById("error").innerText = "Meet not found.";
        return;
      }
  
      document.getElementById("meet-title").innerText = meet.name;
      document.getElementById("meet-meta").innerText = meet.date || "";
  
      // Load all results for this meet
      const resultsSnap = await firebaseDatabase
        .ref("crosscountry/results")
        .orderByChild("meet_slug")
        .equalTo(slug)
        .once("value");
  
      const allResults = [];
      resultsSnap.forEach(c => allResults.push(c.val()));
  
      // Allow gender switching
      const genderTabs = {
        M: document.getElementById("tab-boys"),
        F: document.getElementById("tab-girls")
      };
  
      document.getElementById("selector").style.display = "block";
  
      function activateGender(gender) {
        document.querySelectorAll(".gender-tab").forEach(t => t.classList.remove("active"));
        genderTabs[gender].classList.add("active");
  
        const races = meet.races?.[gender];
        const wrap = document.getElementById("race-button-wrap");
        wrap.innerHTML = "";
  
        if (!races) {
          wrap.innerHTML = "<p>No races listed for this gender.</p>";
          return;
        }
  
        Object.entries(races).forEach(([raceType, raceObj]) => {
          const btn = document.createElement("button");
          btn.className = "race-button primary";
          btn.innerText = raceObj.name;
          btn.onclick = () => {
            const raceDistance = raceObj.distance;
            const filtered = allResults.filter(
              r => r.gender === gender && r.race_type === raceType
            );
            renderResultsTable(filtered, raceDistance);
          };
          wrap.appendChild(btn);
        });
  
        // Clear old results whenever gender switches
        document.getElementById("results-box").innerHTML = "";
      }
  
      // Bind tab clicks
      genderTabs.M.onclick = () => activateGender("M");
      genderTabs.F.onclick = () => activateGender("F");
  
      activateGender("M"); // default gender
    }
  
    document.addEventListener("DOMContentLoaded", loadMeet);
  </script>

</body>
</html>
