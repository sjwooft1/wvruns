<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School ‚Äì Mountain State Miles</title>
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-content">
        <a href="xc.html" class="navbar-brand">üèîÔ∏è Cross Country</a>
        <ul class="navbar-nav">
          <li><a href="xc.html" class="navbar-link">Home</a></li>
          <li><a href="schools.html" class="navbar-link">Schools</a></li>
          <li><a href="meets.html" class="navbar-link">Meets</a></li>
          <li><a href="rankings.html" class="navbar-link">Rankings</a></li>
          <li><a href="calendar.html" class="navbar-link">Calendar</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="content-section">
    <div class="container">
      <div class="school-header">
        <div style="display: flex; align-items: center; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
          <img id="school-logo" src="" alt="School Logo" style="height: 60px; display: none; border-radius: 8px;" />
          <h1 id="school-name" class="school-name">Loading...</h1>
        </div>
        <p id="school-description" style="color: var(--text-secondary);">Loading school information...</p>
      </div>

      <section class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
          <h2 class="card-title">Roster</h2>
        </div>
        <div class="card-body">
          <div id="roster-loading" class="loading">Loading roster...</div>
          <div id="roster-grid" style="height: 400px; width: 100%; display: none;"></div>
          <p id="no-athletes" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);"><em>No athletes found. Add them via the admin page.</em></p>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Recent Meets & Results</h2>
        </div>
        <div class="card-body">
          <ul id="meets-list" style="list-style: none; padding: 0;">
            <!-- Meets will be loaded here -->
          </ul>
          <p style="color: var(--text-secondary); margin-top: 1rem;">Click a meet to view full results. More data will be loaded dynamically.</p>
        </div>
      </section>
    </div>
  </main>

  <footer style="text-align: center; padding: 3rem 2rem; background: white; margin-top: 4rem; border-top: 1px solid var(--border-light);">
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">&copy; 2025 Mountain State Miles ‚Äî Built by runners, for runners.</p>
    <a href="login.html" class="btn btn-secondary">Admin Login</a>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
  <!-- Firebase Configuration -->
  <script src="firebase-config.js"></script>
  <script src="firebase-helpers.js"></script>
  <script>
    const USE_WORD_GRADE_LABELS = false;

    // Convert graduation year to grade label (9th‚Äì12th or words) based on current academic year
    function formatGrade(gradYear) {
      if (!gradYear) return 'N/A';
      const yearNum = parseInt(gradYear, 10);
      if (Number.isNaN(yearNum)) return 'N/A';
      const now = new Date();
      const month = now.getMonth(); // 0=Jan ... 11=Dec
      const currentYear = now.getFullYear();
      const academicEndYear = month >= 7 ? currentYear + 1 : currentYear;
      const gradeNum = 12 - (yearNum - academicEndYear);
      const numLabels = { 9: '9th', 10: '10th', 11: '11th', 12: '12th' };
      const wordLabels = { 9: 'Freshman', 10: 'Sophomore', 11: 'Junior', 12: 'Senior' };
      const dict = USE_WORD_GRADE_LABELS ? wordLabels : numLabels;
      return dict[gradeNum] || 'N/A';
    }
    /**
     * Extracts the most used color from the given logo image (ignoring very light/dark/gray/transparent pixels).
     * If multiple colors tie for highest count, the theme uses the average (mix) of these colors.
     */
    function setSchoolThemeFromLogo(logoEl) {
      if (!logoEl.complete || logoEl.naturalHeight === 0) {
        logoEl.onload = () => setSchoolThemeFromLogo(logoEl);
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = logoEl.naturalWidth;
      canvas.height = logoEl.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(logoEl, 0, 0);
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      const hist = {};
      for(let i=0; i<data.length; i+=4) {
        const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
        if(a<120) continue;
        if(r>230 && g>230 && b>230) continue; // skip near-white
        if(r<28 && g<28 && b<28) continue; // skip near-black
        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        if(max-min<18) continue; // skip grayish
        const key = `${Math.round(r/12)*12},${Math.round(g/12)*12},${Math.round(b/12)*12}`;
        hist[key] = (hist[key]||0) + 1;
      }
      // Find most-used value(s)
      let maxCount = 0; let bestColors = [];
      Object.entries(hist).forEach(([k, v]) => {
        if(v>maxCount) { maxCount = v; bestColors=[k.split(',').map(Number)]; }
        else if(v===maxCount) { bestColors.push(k.split(',').map(Number)); }
      });
      let dominant = [44,95,125];
      if(bestColors.length && maxCount>0) {
        // Average if ties
        dominant = bestColors[0];
        if(bestColors.length > 1) {
          dominant = [0,0,0];
          bestColors.forEach(c=>{dominant[0]+=c[0];dominant[1]+=c[1];dominant[2]+=c[2];});
          dominant = dominant.map(v=>Math.round(v/bestColors.length));
        }
      }
      const style = document.getElementById('school-theme') || (()=>{ const s = document.createElement('style'); s.id = 'school-theme'; document.head.appendChild(s); return s; })();
      style.textContent = `:root{--school-main: rgb(${dominant.join(',')});--school-main-t: rgba(${dominant.join(',')},0.18);}`;
      document.body.classList.add('school-themed');
    }
    function prepareSchoolTheme() {
      const logoEl = document.getElementById('school-logo');
      if(logoEl && logoEl.complete && logoEl.naturalHeight!==0) setSchoolThemeFromLogo(logoEl);
      else if(logoEl) logoEl.onload = ()=>setSchoolThemeFromLogo(logoEl);
    }
    document.addEventListener('DOMContentLoaded',()=>{
      setTimeout(prepareSchoolTheme,400); // run after usual load
    });
    // Get school slug from URL parameter
    function getSchoolSlug() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('school');
    }

    // Load school information from Supabase
    async function loadSchoolInfo() {
      const schoolSlug = getSchoolSlug();
      
      if (!schoolSlug) {
        document.getElementById('school-name').textContent = 'School Not Found';
        document.getElementById('school-description').textContent = 'Please select a school from the schools page.';
        return null;
      }

      try {
        // Try to load from Firebase first
        let schoolData = await getSchoolBySlug(schoolSlug);

        if (!schoolData) {
          // Fallback to local JSON
          const response = await fetch('data/schools.json');
          const allSchools = await response.json();
          schoolData = allSchools.find(s => s.slug === schoolSlug);
        }

        if (schoolData) {
          document.getElementById('school-name').textContent = schoolData.name;
          document.getElementById('school-description').textContent = `The ${schoolData.name} team represents ${schoolData.name} in West Virginia.`;
          
          // Try to load school logo
          const logo = document.getElementById('school-logo');
          logo.src = `assets/team logos/${schoolSlug}.png`;
          logo.alt = `${schoolData.name} Logo`;
          logo.onerror = function() {
            // Logo not found, hide it
            this.style.display = 'none';
          };
          logo.onload = function() {
            this.style.display = 'block';
          };
        } else {
          document.getElementById('school-name').textContent = 'School Not Found';
          document.getElementById('school-description').textContent = 'This school does not exist.';
        }

        return schoolSlug;
      } catch (error) {
        console.error('Error loading school info:', error);
        document.getElementById('school-name').textContent = 'Error Loading School';
        return null;
      }
    }

    // Load meets for the school
    async function loadMeets(schoolSlug) {
      try {
        // Get meets for this school
        const meets = await getMeetsBySchool(schoolSlug);
        
        if (!meets || meets.length === 0) {
          document.getElementById('meets-list').innerHTML = '<li>No meets yet. Add results via the admin page.</li>';
          return;
        }
          order('date', { ascending: false })
          .limit(5);
        
        if (error) {
          console.error('Error loading meets:', error);
          document.getElementById('meets-list').innerHTML = '<li>Error loading meets</li>';
          return;
        }
        
        const meetsList = document.getElementById('meets-list');
        meetsList.innerHTML = ''; // Clear existing content
        
        function formatDate(dateString) {
          if (!dateString) return 'Date TBD';
          // Parse date string in local time to avoid timezone shift
          const parts = dateString.split('-');
          if (parts.length === 3) {
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
            const day = parseInt(parts[2], 10);
            const date = new Date(year, month, day);
            return date.toLocaleDateString();
          }
          // Fallback to original method if format is unexpected
          return new Date(dateString).toLocaleDateString();
        }
        if (meets && meets.length > 0) {
          meets.forEach(meet => {
            const li = document.createElement('li');
            const date = formatDate(meet.date);
            li.innerHTML = `
              <a href="meet.html?slug=${meet.slug}" style="font-weight:bold">${meet.name}</a>
              ${meet.location ? `‚Äî Location: ${meet.location}` : ''} 
              ‚Äî Date: ${date}
            `;
            meetsList.appendChild(li);
          });
        } else {
          meetsList.innerHTML = '<li>No meets found for this school.</li>';
        }
      } catch (error) {
        console.error('Error loading meets:', error);
        document.getElementById('meets-list').innerHTML = '<li>Error loading meets</li>';
      }
    }

    // Load athletes roster
    async function loadRoster(schoolSlug) {
      try {
        const athletes = await getAthletesBySchool(schoolSlug);
        
        if (!athletes) {
          console.error('Error loading athletes');
          document.getElementById('roster-loading').textContent = 'Error loading roster';
          return;
        }
        
        const gridContainer = document.getElementById('roster-grid');
        const loadingDiv = document.getElementById('roster-loading');
        const noAthletes = document.getElementById('no-athletes');
        
        if (athletes && athletes.length > 0) {
          if (window.rosterHot) {
            try {
              window.rosterHot.destroy();
            } catch (e) {
              console.warn('Error destroying Handsontable:', e);
            }
          }

          const headers = ['Name', 'Grade', 'Gender'];
          const rowData = athletes.map(athlete => [
            athlete.name || '',
            formatGrade(athlete.grade),
            athlete.gender || 'N/A',
            athlete.name
          ]);

          const columnDefs = [
            {
              data: 0,
              title: 'Name',
              type: 'text',
              readOnly: true,
              renderer: function(instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.TextRenderer.apply(this, arguments);
                const athleteName = instance.getDataAtRow(row)[3];
                if (athleteName) {
                  td.innerHTML = `<a href="athlete.html?name=${encodeURIComponent(athleteName)}" style="color: #0056b3; text-decoration: none; font-weight: 600;">${value || ''}</a>`;
                }
              }
            },
            { data: 1, title: 'Grade', type: 'text', readOnly: true, width: 100 },
            { data: 2, title: 'Gender', type: 'text', readOnly: true, width: 100 }
          ];

          loadingDiv.style.display = 'none';
          gridContainer.style.display = 'block';
          
          setTimeout(() => {
            try {
              if (!gridContainer) {
                console.error('Roster grid container not found');
                return;
              }
              window.rosterHot = new Handsontable(gridContainer, {
                data: rowData,
                colHeaders: headers,
                columns: columnDefs,
                rowHeaders: true,
                licenseKey: 'non-commercial-and-evaluation',
                height: 'auto',
                maxHeight: '400px',
                stretchH: 'all',
                columnSorting: true,
                filters: true,
                dropdownMenu: true,
                contextMenu: true,
                manualColumnResize: true
              });
              loadingDiv.style.display = 'none';
              gridContainer.style.display = 'block';
            } catch (error) {
              console.error('Error creating Handsontable:', error);
              loadingDiv.innerHTML = `Error loading roster: ${error.message}`;
            }
          }, 100);
        } else {
          loadingDiv.style.display = 'none';
          noAthletes.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading roster:', error);
        document.getElementById('roster-loading').textContent = 'Error loading roster';
      }
    }

    // Initialize page
    async function init() {
      const schoolSlug = await loadSchoolInfo();
      if (schoolSlug) {
        loadRoster(schoolSlug);
        loadMeets(schoolSlug);
      } else {
        document.getElementById('roster-loading').style.display = 'none';
      }
    }

    // Run when page loads
    init();
  </script>
  </div>
</body>
</html>

