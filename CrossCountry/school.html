<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School ‚Äì Mountain State Miles</title>
  <link rel="icon" type="image/png" href="assets/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="assets/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/Favicon Generator/apple-touch-icon.png" />
  <link rel="manifest" href="assets/Favicon Generator/site.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- Your Configuration and Helper Scripts -->
  <script src="firebase-config.js"></script>
  <script src="firebase-helpers.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-content">
        <a href="xc.html" class="navbar-brand">üèîÔ∏è Cross Country</a>
        <ul class="navbar-nav">
          <li><a href="xc.html" class="navbar-link">Home</a></li>
            <li><a href="schools.html" class="navbar-link active">Schools</a></li>
            <li><a href="meets.html" class="navbar-link">Meets</a></li>
            <li><a href="rankings.html" class="navbar-link">Rankings</a>
            </li><li><a href="analytics.html" class="navbar-link">Analytics</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="page-container">
    <header class="hero-section hero-profile">
      <div class="hero-content">
        <!-- School Logo Display -->
        <!-- Logo path based on assets/team_logos/school_slug.png -->
        <img id="school-logo" class="hero-logo" src="" alt="School Logo" style="display: none;" 
             onerror="this.style.display='none';"> 
        <h1 id="school-name" class="text-4xl font-extrabold mb-2">School Profile</h1>
        <p id="school-info" class="text-xl font-medium text-gray-200">Loading school information...</p>
      </div>
    </header>

    <section class="content-section">
      <div class="container">
        
        <!-- Roster Section -->
        <h2 class="section-title mb-4">Current Roster</h2>
        <div id="roster-loading" class="loading-message">
            Loading roster...
        </div>
        <div id="no-athletes" class="loading-message" style="display: none;">
            No athletes found for this school.
        </div>
        <div id="roster-grid" class="table-container" style="display: none;">
          <!-- Custom HTML Roster Table will render here -->
        </div>

        <!-- Meet Results Section -->
        <h2 class="section-title mt-10 mb-4">Meet Results Summary</h2>
        <div id="meets-loading" class="loading-message">
            Loading recent meet results...
        </div>
        <div id="meets-list">
            <!-- Meet list will be injected here -->
        </div>

        <!-- Team Statistics Section -->
        <h2 class="section-title mt-10 mb-4">Team Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Average Team Time</div>
            <div class="stat-value" id="avg-time">--:--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Athletes</div>
            <div class="stat-value" id="total-athletes">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Personal Records Set</div>
            <div class="stat-value" id="pr-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Meet Appearances</div>
            <div class="stat-value" id="meet-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Best Team Performance</div>
            <div class="stat-value" id="best-time">--:--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Fastest Athlete</div>
            <div class="stat-value" id="fastest-athlete">--</div>
          </div>
        </div>

        <!-- Season Trends Section -->
        <h2 class="section-title mt-10 mb-4">Season Performance</h2>
        <div id="trends-container" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);">
          <canvas id="trendsChart" style="max-height: 400px;"></canvas>
        </div>
        
      </div>
    </section>
  </main>
  
  <!-- Custom Styles for visual integration (kept from previous version) -->
  <style>
    /* School Logo Style */
    .hero-logo { 
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: contain;
        background: white;
        padding: 5px;
        margin: 0 auto 1.5rem auto;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Container for the new custom table */
    .table-container {
        max-width: 100%;
        overflow-x: auto;
        margin-bottom: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .loading-message {
        padding: 20px;
        text-align: center;
        color: var(--xc-primary);
        font-weight: 500;
        font-size: 1.1rem;
    }
    .meet-card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .meet-card a {
      color: var(--xc-primary);
      font-weight: 600;
      text-decoration: none;
    }
    .meet-card p {
        margin: 0;
        color: #555;
        font-size: 0.95rem;
    }
    
    /* Responsive Table Styles */
    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .results-table th, .results-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        color: #333;
    }

    .results-table th {
        background-color: var(--xc-primary);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .results-table tbody tr:nth-of-type(even) {
        background-color: #f9f9f9;
    }

    .results-table tbody tr:hover {
        background-color: #f1f5f9;
    }
    
    /* Responsive styles for table on small screens, mirroring style.css */
    @media screen and (max-width: 768px) {
        .results-table table, 
        .results-table thead, 
        .results-table tbody, 
        .results-table th, 
        .results-table td, 
        .results-table tr {
            display: block;
        }
        
        .results-table thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        .results-table tr {
            border: 1px solid #ccc;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .results-table td {
            border: none;
            position: relative;
            padding-left: 50%;
            text-align: right;
        }
        
        .results-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            font-weight: 600;
            text-align: left;
            color: var(--xc-primary);
        }
    }
  </style>

  <script>
    // Utility function to format time (in seconds) to M:SS.ss
    function formatTime(seconds) {
      const timeSec = parseFloat(seconds);
      if (isNaN(timeSec) || timeSec <= 0) return 'N/A';
      
      const totalMinutes = Math.floor(timeSec / 60);
      // Ensure the seconds part is padded and has two decimal places
      const remainingSeconds = (timeSec % 60).toFixed(2).padStart(5, '0'); 
      return `${totalMinutes}:${remainingSeconds}`;
    }
    
    // Element references
    const schoolLogoEl = document.getElementById('school-logo');
    const schoolNameEl = document.getElementById('school-name');
    const schoolInfoEl = document.getElementById('school-info');
    const rosterGrid = document.getElementById('roster-grid');
    const rosterLoading = document.getElementById('roster-loading');
    const noAthletes = document.getElementById('no-athletes');
    const meetsList = document.getElementById('meets-list');
    const meetsLoading = document.getElementById('meets-loading');


    /**
     * Loads school name, info, and logo from URL parameter.
     * @returns {Promise<string|null>} The school slug or null if not found.
     */
    async function loadSchoolInfo() {
      const params = new URLSearchParams(window.location.search);
      const schoolSlug = params.get('slug');

      if (!schoolSlug) {
        schoolNameEl.textContent = 'School Not Found';
        schoolInfoEl.textContent = 'Please provide a valid school slug in the URL.';
        return null;
      }

      try {
        const school = await getSchoolBySlug(schoolSlug);
        if (school && school.name) {
          schoolNameEl.textContent = school.name;
          schoolInfoEl.textContent = `School in ${school.city || 'West Virginia'}`;
          document.title = `${school.name} Profile ‚Äì Mountain State Miles`;
          
          // Set Logo path as requested: assets/team_logos/school_slug.png
          const logoPath = `assets/team_logos/${schoolSlug}.png`;
          schoolLogoEl.src = logoPath;
          schoolLogoEl.style.display = 'block'; 
          
          return schoolSlug;
        } else {
          schoolNameEl.textContent = 'School Not Found';
          schoolInfoEl.textContent = `No data found for slug: ${schoolSlug}`;
          return null;
        }
      } catch (error) {
        console.error('Error fetching school info:', error);
        schoolNameEl.textContent = 'Error Loading Data';
        schoolInfoEl.textContent = 'Could not connect to database.';
        return null;
      }
    }

    /**
     * Loads the roster by querying the /athletes folder for school_slug matches.
     * @param {string} schoolSlug The school identifier.
     */
    async function loadRoster(schoolSlug) {
      rosterLoading.style.display = 'block';
      rosterGrid.style.display = 'none';
      noAthletes.style.display = 'none';
      rosterGrid.innerHTML = ''; 

      try {
        // Fetch athletes using the helper which should query /athletes filtered by school_slug
        const roster = await getAthletesBySchool(schoolSlug);

        if (roster && roster.length > 0) {
          
          const tableHTML = `
            <table class="results-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Gender</th>
                  <th>Graduation Year</th>
                </tr>
              </thead>
              <tbody>
                ${roster.map(athlete => {
                  // Resilient name fetching
                  const name = athlete.athlete_name || athlete.name || 'Name Unknown'; 
                  
                  // === FIX: Resilient graduation year fetching ===
                  let gradYear = athlete.grad_year || athlete.graduation_year || athlete.class;
                  gradYear = gradYear ? `C/o ${gradYear}` : 'N/A';
                  // ===============================================

                  const gender = athlete.gender === 'M' ? 'Male' : (athlete.gender === 'F' ? 'Female' : 'N/A');
                  const slug = athlete.athlete_slug;
                  
                  // Link to athlete page
                  const link = slug 
                      ? `<a href="athlete.html?slug=${slug}" style="color: var(--xc-primary); font-weight: 600;">${name}</a>`
                      : name;

                  return `
                    <tr>
                      <td data-label="Name">${link}</td>
                      <td data-label="Gender">${gender}</td>
                      <td data-label="Graduation Year">${gradYear}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;

          rosterGrid.innerHTML = tableHTML;
          rosterLoading.style.display = 'none';
          rosterGrid.style.display = 'block';

        } else {
          rosterLoading.style.display = 'none';
          noAthletes.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading roster:', error);
        rosterLoading.textContent = 'Error loading roster data: ' + error.message;
        rosterLoading.style.display = 'block';
        rosterGrid.style.display = 'none';
        noAthletes.style.display = 'none';
      }
    }
    
    /**
     * Loads the list of meets a school has participated in by querying the /results 
     * folder for results matching the school's slug.
     * @param {string} schoolSlug The school identifier.
     */
    async function loadMeets(schoolSlug) {
      meetsLoading.style.display = 'block';
      meetsList.innerHTML = '';
      try {
        // Fetch results using the helper which should query /results filtered by school_slug
        const results = await getResultsBySchool(schoolSlug);
        
        if (results && results.length > 0) {
            // Group results by unique meet slug
            const meetsMap = results.reduce((acc, result) => {
                const meetSlug = result.meet_slug;
                
                if (!meetSlug) return acc; // Skip results missing a meet slug

                // === FIX: Prioritize clean name over 'Unknown Meet' + slug ===
                let meetName = result.meet_name || result.meet; 
                if (!meetName) {
                    // Fallback: If no proper name, use the slug directly.
                    meetName = meetSlug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); 
                }
                // =============================================================
                
                if (!acc[meetSlug]) {
                    acc[meetSlug] = {
                        meet_slug: meetSlug,
                        meet_name: meetName, // Use the determined name
                        date: result.date || null,
                        results: []
                    };
                }
                acc[meetSlug].results.push(result);
                return acc;
            }, {});

            const meetsArray = Object.values(meetsMap);
            
            // Sort meets by date, newest first
            meetsArray.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (isNaN(dateA)) return 1;
                if (isNaN(dateB)) return -1;
                return dateB.getTime() - dateA.getTime(); 
            });

            const html = meetsArray.map(meet => {
                // Find the best overall time from this school at this meet
                const bestTimeResult = meet.results.reduce((best, current) => {
                    const currentTime = parseFloat(current.time);
                    if (isNaN(currentTime) || currentTime <= 0) return best; 
                    
                    const bestTime = best ? parseFloat(best.time) : Infinity;
                    return currentTime < bestTime ? current : best;
                }, null);
                
                const bestTimeDisplay = bestTimeResult ? formatTime(bestTimeResult.time) : 'No Valid Time Recorded';
                
                // Resilient name fetching for fastest athlete: athlete_name, then name, then fallback
                const bestTimeAthlete = bestTimeResult 
                    ? bestTimeResult.athlete_name || bestTimeResult.name || 'Unknown Athlete' 
                    : '';

                let displayDate = 'Date Unknown';
                if (meet.date) {
                    const dateObj = new Date(meet.date);
                    if (!isNaN(dateObj.getTime())) {
                        displayDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                }
                
                return `
                    <div class="meet-card">
                        <a href="meet.html?slug=${meet.meet_slug}">${meet.meet_name}</a>
                        <p>Date: ${displayDate}</p>
                        <p>Fastest Time: ${bestTimeDisplay} ${bestTimeAthlete ? `(by ${bestTimeAthlete})` : ''}</p>
                    </div>
                `;
            }).join('');

            meetsList.innerHTML = html;
        } else {
            meetsList.innerHTML = '<p class="loading-message">No meet results found for this school in the database.</p>';
        }

      } catch (error) {
        console.error('Error loading meets:', error);
        meetsList.innerHTML = `<p class="loading-message" style="color: red;">Error loading meet data: ${error.message}</p>`;
      } finally {
        meetsLoading.style.display = 'none';
      }
    }


    // Initialize page
    async function init() {
      if (typeof getSchoolBySlug === 'undefined') {
          document.getElementById('roster-loading').textContent = 'Error: Firebase helpers not loaded. Check script tags.';
          document.getElementById('meets-loading').textContent = '';
          return;
      }

      const schoolSlug = await loadSchoolInfo();
      if (schoolSlug) {
        loadRoster(schoolSlug);
        loadMeets(schoolSlug);
      } else {
        document.getElementById('roster-loading').style.display = 'none';
        document.getElementById('meets-loading').style.display = 'none';
      }
    }

    // Run when page loads
    window.onload = init;
  </script>
</body>
</html>